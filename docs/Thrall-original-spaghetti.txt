using System;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Net;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Runtime.InteropServices;
using System.Runtime.Versioning;
using System.Security;
using System.Security.Cryptography;
using System.Security.Permissions;
using System.Text;
using System.Threading.Tasks;
using BepInEx;
using BepInEx.Configuration;
using BepInEx.Logging;
using HarmonyLib;
using Jotunn;
using Jotunn.GUI;
using Jotunn.Managers;
using SimpleJson;
using TMPro;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.Events;
using UnityEngine.UI;

[assembly: CompilationRelaxations(8)]
[assembly: RuntimeCompatibility(WrapNonExceptionThrows = true)]
[assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)]
[assembly: AssemblyTitle("ValheimAIModLivePatch")]
[assembly: AssemblyDescription("")]
[assembly: AssemblyConfiguration("")]
[assembly: AssemblyCompany("")]
[assembly: AssemblyProduct("ValheimAIModLivePatch")]
[assembly: AssemblyCopyright("Copyright ©  2024")]
[assembly: AssemblyTrademark("")]
[assembly: ComVisible(false)]
[assembly: Guid("d0f5469c-3db9-4874-86e8-35b484bf63d1")]
[assembly: AssemblyFileVersion("1.0.0.0")]
[assembly: TargetFramework(".NETFramework,Version=v4.7.2", FrameworkDisplayName = ".NET Framework 4.7.2")]
[assembly: SecurityPermission(SecurityAction.RequestMinimum, SkipVerification = true)]
[assembly: AssemblyVersion("1.0.0.0")]
[module: UnverifiableCode]
namespace ValheimAIModLoader;

[BepInPlugin("egoai.thrallmodlivepatch", "ego.ai Thrall Mod Live Patch", "0.0.1")]
[BepInProcess("valheim.exe")]
[BepInDependency(/*Could not decode attribute arguments.*/)]
public class ValheimAIModLivePatch : BaseUnityPlugin
{
	public enum NPCMode
	{
		Passive,
		Defensive,
		Aggressive
	}

	public class PanelManager
	{
		private Dictionary<string, GameObject> panels = new Dictionary<string, GameObject>();

		public GameObject CreatePanel(string panelName, Vector2 anchorMin, Vector2 anchorMax, Vector2 position, float width, float height, bool draggable, Vector2 pivot = default(Vector2))
		{
			//IL_0071: Unknown result type (might be due to invalid IL or missing references)
			//IL_0072: Unknown result type (might be due to invalid IL or missing references)
			//IL_0073: Unknown result type (might be due to invalid IL or missing references)
			//IL_0089: Unknown result type (might be due to invalid IL or missing references)
			if (panels.ContainsKey(panelName))
			{
				LogWarning("Panel " + panelName + " already exists.");
				return panels[panelName];
			}
			if (GUIManager.Instance == null || (Object)(object)GUIManager.CustomGUIFront == (Object)null)
			{
				LogError("GUIManager instance or CustomGUI is null");
				return null;
			}
			GameObject val = GUIManager.Instance.CreateWoodpanel(GUIManager.CustomGUIFront.transform, anchorMin, anchorMax, position, width, height, draggable);
			RectTransform component = val.GetComponent<RectTransform>();
			component.pivot = pivot;
			AddTitleText(val, panelName);
			val.SetActive(false);
			panels[panelName] = val;
			return val;
		}

		private void AddTitleText(GameObject panel, string title)
		{
			//IL_0006: Unknown result type (might be due to invalid IL or missing references)
			//IL_000c: Expected O, but got Unknown
			//IL_005b: Unknown result type (might be due to invalid IL or missing references)
			//IL_0080: Unknown result type (might be due to invalid IL or missing references)
			//IL_0096: Unknown result type (might be due to invalid IL or missing references)
			//IL_00ac: Unknown result type (might be due to invalid IL or missing references)
			//IL_00c2: Unknown result type (might be due to invalid IL or missing references)
			//IL_00d8: Unknown result type (might be due to invalid IL or missing references)
			GameObject val = new GameObject("PanelTitle");
			val.transform.SetParent(panel.transform, false);
			Text val2 = val.AddComponent<Text>();
			val2.text = title.ToUpper();
			val2.font = GUIManager.Instance.NorseBold;
			val2.fontSize = instance.MenuTitleFontSize;
			((Graphic)val2).color = GUIManager.Instance.ValheimOrange;
			val2.alignment = (TextAnchor)4;
			RectTransform component = ((Component)val2).GetComponent<RectTransform>();
			component.anchorMin = new Vector2(0f, 1f);
			component.anchorMax = new Vector2(1f, 1f);
			component.anchoredPosition = new Vector2(0f, -40f);
			component.sizeDelta = new Vector2(0f, 40f);
			component.pivot = new Vector2(0f, 1f);
		}

		public void TogglePanel(string panelName)
		{
			if (!panels.ContainsKey(panelName))
			{
				LogError("TogglePanel failed! Panel " + panelName + " does not exist.");
				return;
			}
			GameObject val = panels[panelName];
			bool flag = !val.activeSelf;
			if (flag)
			{
				instance.RefreshTaskList();
				instance.RefreshKeyBindings();
			}
			if ((Object)(object)val != (Object)null)
			{
				val.SetActive(flag);
				IsModMenuShowing = flag;
				GUIManager.BlockInput(flag);
			}
			else
			{
				LogError("TogglePanel failed! Panel " + panelName + " was null!");
			}
		}

		public void DestroyAllPanels()
		{
			foreach (GameObject value in panels.Values)
			{
				if ((Object)(object)value != (Object)null)
				{
					Object.Destroy((Object)(object)value);
				}
			}
			panels.Clear();
		}

		public GameObject CreateSubPanel(GameObject parentPanel, string subPanelName, Vector2 anchorMin, Vector2 anchorMax, Vector2 position, float width, float height, Vector2 pivot = default(Vector2))
		{
			//IL_0002: Unknown result type (might be due to invalid IL or missing references)
			//IL_0008: Expected O, but got Unknown
			//IL_0025: Unknown result type (might be due to invalid IL or missing references)
			//IL_002d: Unknown result type (might be due to invalid IL or missing references)
			//IL_0036: Unknown result type (might be due to invalid IL or missing references)
			//IL_0043: Unknown result type (might be due to invalid IL or missing references)
			//IL_004f: Unknown result type (might be due to invalid IL or missing references)
			//IL_006c: Unknown result type (might be due to invalid IL or missing references)
			GameObject val = new GameObject(subPanelName);
			RectTransform val2 = val.AddComponent<RectTransform>();
			Image val3 = val.AddComponent<Image>();
			((Transform)val2).SetParent(parentPanel.transform, false);
			val2.anchorMin = anchorMin;
			val2.anchorMax = anchorMax;
			val2.anchoredPosition = position;
			val2.sizeDelta = new Vector2(width, height);
			val2.pivot = pivot;
			((Graphic)val3).color = new Color(0f, 0f, 0f, 0.5f);
			return val;
		}
	}

	public class Resource
	{
		public string Name { get; set; }

		public int MinAmount { get; set; }

		public int MaxAmount { get; set; }

		public float Health { get; set; }

		public DamageModifiers DamageModifiers { get; set; }

		public Resource(string name, int minAmount, int maxAmount, float health, DamageModifiers damageModifiers = default(DamageModifiers))
		{
			//IL_002a: Unknown result type (might be due to invalid IL or missing references)
			Name = name;
			MinAmount = minAmount;
			MaxAmount = maxAmount;
			Health = health;
			DamageModifiers = damageModifiers;
		}

		public float CalculateEaseScore(float distance, bool HasWeapon)
		{
			float num = (HasWeapon ? 0.3f : 0f);
			float num2 = (HasWeapon ? 0.3f : 0.9f);
			float num3 = (HasWeapon ? 0.4f : 0.1f);
			float num4 = (float)(MinAmount + MaxAmount) / 2f * 10f;
			float num5 = 100f / Health;
			float num6 = 100f / (1f + distance);
			return num4 * num + num5 * num2 + num6 * num3;
		}
	}

	private static AudioClip recordedAudioClip;

	public static bool IsRecording = false;

	private static float recordingStartedTime = 0f;

	private static bool shortRecordingWarningShown = false;

	private int recordingLength = 10;

	private int sampleRate = 22050;

	private int bitDepth = 8;

	private static float lastSentToBrainTime = 0f;

	public static ValheimAIModLivePatch instance;

	private readonly Harmony harmony = new Harmony("egoai.thrallmodlivepatch");

	private static string NPCPrefabName = "HumanoidNPC";

	private static GameObject PlayerNPC;

	private static HumanoidNPC humanoid_PlayerNPC;

	private static ThrallAI thrallAI_PlayerNPC;

	private static GameObject[] AllGOInstances = (GameObject[])(object)new GameObject[0];

	private static float AllGOInstancesLastRefresh = 0f;

	private GameObject[] AllEnemiesInstances = (GameObject[])(object)new GameObject[0];

	private float AllEnemiesInstancesLastRefresh = 0f;

	private static HashSet<Character> enemyList = new HashSet<Character>();

	private NPCCommandManager commandManager = new NPCCommandManager();

	private static NPCCommand NPCCurrentCommand = null;

	private static NPCCommand.CommandType NPCCurrentCommandType;

	private static HitData NPCLastHitData = null;

	public static bool MovementLock = false;

	public static float chaseUntilPatrolRadiusDistance = 20f;

	public static Vector3 patrol_position = Vector3.zero;

	public float patrol_radius = 10f;

	public bool patrol_harvest = false;

	public static string CurrentEnemyName = "Greyling";

	public static string CurrentHarvestResourceName = "Wood";

	public static string CurrentWeaponName = "";

	private static ItemData useWeapon = null;

	private static string lastAttackedObjectZDOID = "";

	private static DamageModifiers targetDamageModifiers = default(DamageModifiers);

	private static List<ItemDrop> closestItemDrops = new List<ItemDrop>();

	private static float closestItemDropsLastRefresh = 0f;

	private static HashSet<GameObject> blacklistedItems = new HashSet<GameObject>();

	private static float NewFollowTargetLastRefresh = 0f;

	private static float MaxChaseTimeForOneFollowTarget = 20f;

	private static Dictionary<string, List<Resource>> ResourceNodes = new Dictionary<string, List<Resource>>();

	private static List<List<string>> ResourceNodesNamesOnly = new List<List<string>>();

	private static List<string> ResourceNodesOneArray = new List<string>();

	public static bool IsModMenuShowing = false;

	private static bool ModInitComplete = false;

	private static float FollowUntilDistance = 0.5f;

	private static float RunUntilDistance = 3f;

	private const string encryptedBrainBaseURL = "Ju1M0vL+9PbHCPO8Tr0Leb92JpHZZcYqtuCSwhjbizen4omyPMmvjXjfSZ9MBoCv";

	private string playerDialogueAudioPath;

	private string npcDialogueAudioPath;

	private string npcDialogueRawAudioPath;

	private ConfigEntry<string> BrainAPIAddress;

	private ConfigEntry<bool> LogToBrain;

	private ConfigEntry<bool> DisableAutoSave;

	private Dictionary<string, Requirement[]> craftingRequirements = new Dictionary<string, Requirement[]>();

	private Dictionary<string, Requirement[]> buildingRequirements = new Dictionary<string, Requirement[]>();

	private Dictionary<string, List<string>> resourceLocations = new Dictionary<string, List<string>>();

	private static int AllGOInstancesRefreshRate = 3;

	private static float nearbyResourcesLastRefresh = 0f;

	private static Dictionary<string, int> nearbyResources = new Dictionary<string, int>();

	private static Dictionary<string, float> nearbyResourcesDistance = new Dictionary<string, float>();

	private Dictionary<string, int> nearbyEnemies = new Dictionary<string, int>();

	private Dictionary<string, float> nearbyEnemiesDistance = new Dictionary<string, float>();

	private static ManualLogSource logger;

	private static List<string> logEntries = new List<string>();

	private static bool FindPlayerNPCTimer = false;

	private static bool IsInventoryShowing = false;

	private int MenuTitleFontSize = 36;

	private int MenuSectionTitleFontSize = 24;

	private Vector2 MenuSectionTitlePosition = new Vector2(10f, -5f);

	private PanelManager panelManager = new PanelManager();

	private GameObject settingsPanel;

	private GameObject thrallCustomizationPanel;

	private GameObject taskQueueSubPanel;

	private GameObject keybindsSubPanel;

	private GameObject micInputSubPanel;

	private GameObject egoBannerSubPanel;

	private GameObject npcNameSubPanel;

	private GameObject npcPersonalitySubPanel;

	private GameObject npcVoiceSubPanel;

	private GameObject npcBodyTypeSubPanel;

	private GameObject npcAppearanceSubPanel;

	public string npcName = "";

	public string npcPersonality = "";

	public int npcPersonalityIndex = 0;

	public int npcGender = 0;

	public int npcVoice = 0;

	public float npcVolume = 50f;

	public int MicrophoneIndex = 0;

	public Color skinColor;

	public Color hairColor;

	private GameObject[] TasksList = (GameObject[])(object)new GameObject[0];

	private GameObject TaskListScrollBox;

	private bool IsEditingKeybind = false;

	private ConfigEntry<KeyCode> spawnKey;

	private ConfigEntry<KeyCode> harvestKey;

	private ConfigEntry<KeyCode> followKey;

	private ConfigEntry<KeyCode> talkKey;

	private ConfigEntry<KeyCode> inventoryKey;

	private ConfigEntry<KeyCode> thrallMenuKey;

	private ConfigEntry<KeyCode> combatModeKey;

	private static List<ConfigEntry<KeyCode>> allKeybinds;

	private List<Button> editButtons = new List<Button>();

	private Dropdown micDropdownComp;

	private InputField nameInputField;

	private Dropdown personalityDropdownComp;

	private InputField personalityInputField;

	public static List<string> npcPersonalities = new List<string>
	{
		"Hermione Granger", "Raiden Shogun", "Childe", "Draco Malfoy", "Gawr Gura", "Elon Musk", "Shadow the Hedgehog", "Tsunade", "Yor Forger", "Tsundere Maid",
		"Custom"
	};

	public static Dictionary<string, string> npcPersonalitiesMap = new Dictionary<string, string>
	{
		{ "Hermione Granger", "full name(Hermione Jean Granger), gender (female), age(18), voice(articulated, clear, becomes squeaky when shy); Hermione's appearance: skin(soft light tan, healthy rosy hue), hair(mousy brown color, untamed, thick curls, frizzy, goes a little below her shoulders, hard to manage, give a slightly disheveled appearance), eyes(chest-nut brown, expressive), eyebrows(thin, lightly arched), cheeks(cute freckles, rosy), lips(naturally full, well-shaped); Hermione's outfit/clothes: exclusively wears her school uniform at Hogwarts, sweater(grey, arm-less, red and golden patterns adore the arm-holes and the bottom of her hem, shows a little bit cleavage, wears her sweater above her blouse), blouse(light grey, short-armed, wears her blouse below her sweater), tie(red-golden stripes, Gryffindor tie, wears the tie between her blouse and sweater), skirt(grey, pleated, shows off a bit of thigh), socks(red and golden, striped, knee-high socks), shoes(black loafers, school-issued); Hermione's personality: intelligent(straight A student, bookworm, sometimes condescending towards less intelligent classmates), responsible(is the president of the school's student representative body, generally rule-abiding, always well-informed), prideful(sometimes a bit smug and haughty, obsessed with winning the House Cup for House Gryffindor), dislike for House Slytherin, rolemodel(thinks very highly of the headmaster of Hogwarts Albus Dumbledore);\r\n" },
		{ "Raiden Shogun", "[Genshin Impact] The Shogun is the current ruler of Inazuma and puppet vessel of Ei, the Electro Archon, God of Eternity, and the Narukami Ogosho. Ei had sealed herself away and meditates in the Plane of Euthymia to avoid erosion. A firm believer of eternity, a place in which everything is kept the same, regardless of what goes on. Honorable in her conduct and is revered by the people of Inazuma. Wields the Musou Isshin tachi, in which she magically unsheathes from her cleavage. The Musou no Hitotachi technique is usually an instant-kill move.\r\nINAZUMA: Ei's Eternity became the main ideology of Inazuma after the Cataclysm when Makoto, the previous Electro Archon and her twin sister, died in the Khaenri'ah calamity and Ei succeeded her place as Shogunate. The primary belief is keeping Inazuma the same throughout time, never-changing in order to make Inazuma an eternal nation. Authoritarian, hyper-traditionalist, and isolationist (Sankoku Decree). Holds great importance to noble families and clans. Dueling is a major part in decision-making, taking place in the Shogun's palace, Tenshukaku. The Tri-Commission acts as the main government. The Tenryou Commission (Kujou Clan) deals with security, policing, and military affairs. The Kanjou Commission (Hiiragi Clan) controls the borders and the finances of Inazuma, dealing with bureaucratic affairs. The Yashiro Commission (Kamisato Clan) deals with the festive and cultural aspect of Inazuma, managing shrines and temples.\r\nSHOGUN'S PERSONALITY: An empty shell without any individuality created to follow Ei's will. Dismissive of trivial matters. Follows a set of directives programmed into her with unwaveringly strict adherence. Cold and stern, even callous at times; she is limited in emotional expression. Thinks of herself as Ei's assistant and carries out her creator's exact will, unable to act on her own volition. Resolute and dogmatic, sees in an absolutist, black-and-white view. ESTJ 1w9\r\nEI'S PERSONALITY: Usually holds a stoic demeanor. Only deals with matters directly as a last resort. Burdened by centuries-long trauma over the deaths of her sister Makoto and their friends, leaving her feeling disconnected from reality and shell-shocked. Unaware of the consequences her plans triggered. Prone to being stubborn and complacent. Somewhat immature and headstrong. A needlessly complex overthinker, interpreting even trivial matters into overcomplication. Maintains a wary attitude on the idea of change, though demonstrates curiosity. Has a love for sweets and passion of martial arts. Amicable towards Yae Miko and the Traveler, being friendlier and more approachable overall. Occasionally displays childish innocence while relaxing. Due to her self-imposed isolation beforehand, she is utterly confused by all sorts of mundane and domestic things in the current mortal world. Cannot cook whatsoever. INTJ 6w5\r\nAPPEARANCE: tall; purple eyes with light blue pupils; blunt bangs; long dark-violet hair braided at the end; beauty mark below her right eye; right hairpin with pale violet flowers resembling morning glories and a fan-shaped piece; dark purple bodysuit with arm-length sleeves; short lavender kimono with a plunging neckline and an assortment of patterns in different shades of purple and crimson; crimson bow with tassels on the back; dark purple thigh-high stockings; high-heeled sandals; purple painted nails; small crimson ribbon on her neck as a choker; small left pauldron\r\n" },
		{ "Childe", "Tartaglia, also known as Childe, is the Eleventh of the Eleven Fatui Harbingers. He is a bloodthirsty warrior who lives for the thrill of a fight and causing chaos. Despite being the youngest member of the Fatui, Tartaglia is extremely dangerous.\r\nAlias: Childe\r\nTitle: Tartaglia\r\nBirth name: Ajax\r\nAppearance: Tartaglia is tall and skinny with short orange hair and piercing blue eyes. He has a fit and athletic build, with defined muscles. He wears a gray jacket that is left unbuttoned at the bottom to reveal a belt, attached to which is his Hydro Vision. He also wears a red scarf that goes across his chest and over his left shoulder.\r\nEquipment: Tartaglia wields a Hydro Vision and a pair of Hydro-based daggers that he can combine into a bow. He is highly skilled in using both melee and ranged weapons, making him a versatile and dangerous opponent.\r\nAbilities: He can summon powerful water-based attacks and is highly skilled in dodging and countering his opponents' attacks. \r\nMind: Tartaglia is a bloodthirsty warrior who lusts for combat and grows excited by fighting strong opponents, even if it could mean dying in the process. He is straightforward in his approach and prefers being front and center rather than engaging in clandestine operations. Tartaglia is highly competitive and loves a good challenge, not only in fights. \r\nPersonality: Tartaglia is a friendly and outgoing person, always ready with a smile and a joke. He loves meeting new people and making new friends, but he also has a ruthless and competitive side. He is loyal to the Fatui.\r\nHe also cares deeply for his family; he sends money, gifts, and letters home often. Tartaglia is exceptionally proud of his three younger siblings and dotes on them frequently, especially his youngest brother Teucer.\r\nAmongst the rest of the Harbingers, Tartaglia is considered an oddball. While his fellow Harbingers prefer clandestine operations and staying behind the scenes, Tartaglia favors being front and center. He is a public figure known for attending social gatherings. As a result, Childe's coworkers are wary of him, while he holds them in disdain for their schemes and \"intangible\" methods. While he is easily capable of scheming, he only resorts to such approaches when necessary due to his straightforward nature. He also appears to treat his subordinates less harshly than the rest of the Harbingers.\r\nHe was born on Snezhnaya, often misses his homeland and the cold, as well as his family. He uses the term comrade to refer to people a lot.\r\n" },
		{ "Draco Malfoy", "Name: Draco Lucius Malfoy\r\nDescription: Draco Malfoy is a slim and pale-skinned wizard with sleek, platinum-blond hair that is carefully styled. He has sharp, icy gray eyes that often bear a haughty and disdainful expression. Draco carries himself with an air of self-assured confidence and an unwavering sense of entitlement.\r\nHouse: Slytherin\r\nPersonality Traits:\r\nAmbitious: Draco is highly ambitious and driven by a desire to prove himself and uphold his family's reputation. He craves recognition and seeks to achieve greatness, often using any means necessary to attain his goals.\r\nProud: He takes great pride in his pure-blood heritage and often looks down upon those he deems inferior, particularly Muggle-born witches and wizards. Draco's pride can manifest as arrogance and a sense of superiority.\r\nCunning: Draco possesses a sharp mind and a talent for manipulation. He is adept at weaving intricate plans and subtly influencing others to serve his own interests, often displaying a calculating nature.\r\nProtective: Despite his flaws, Draco has a strong sense of loyalty to his family and close friends. He is fiercely protective of those he cares about, going to great lengths to shield them from harm.\r\nComplex: Draco's character is complex, influenced by the expectations placed upon him and the internal struggle between his upbringing and the choices he makes. There are moments of vulnerability and doubt beneath his bravado.\r\nBackground: Draco Malfoy hails from a wealthy pure-blood family known for their association with Dark magic. Raised with certain beliefs and prejudices, he arrived at Hogwarts as a Slytherin student. Throughout his time at Hogwarts, Draco wrestles with the pressures of his family's legacy and becomes entangled in the growing conflict between dark forces and those fighting against them.\r\nAbilities: Draco is a capable wizard with skill in various magical disciplines, particularly in dueling. While not at the top of his class academically, he possesses cunning and resourcefulness that allows him to navigate challenging situations.\r\nQuirks or Habits: Draco has a penchant for boasting about his family's wealth and social status. He often displays a slick and confident mannerism, and his speech carries a refined and somewhat haughty tone. Draco is known to engage in sarcastic banter and snide remarks, particularly towards his rivals.\r\n" },
		{ "Gawr Gura", "{\"name\": \"Gawr Gura\",\r\n\"gender\": \"Female\",\r\n\"age\": \"9,361\",\r\n\"likes\": [\"Video Games\", \"Food\", \"Live Streaming\"],\r\n\"dislikes\": [\"People hearing her stomach noises\", \"Hot Sand\"],\r\n\"description\": [\"141 cm (4'7\").\"+ \"Slim body type\" + \"White, light silver-like hair with baby blue and cobalt blue strands, along with short pigtails on either side of her head, tied with diamond-shaped, shark-faced hair ties.\" + \"Cyan pupils, and sharp, shark-like teeth.\" +\"Shark tail that sticks out of her lower back\"]\r\n\"clothing\":[\"Oversized dark cerulean-blue hoodie that fades into white on her arm sleeves and hem, two yellow strings in the shape of an \"x\" that connect the front part of her white hoodie hood, a shark mouth designed on her hoodie waist with a zipper, gray hoodie drawstrings with two black circles on each of them, and two pockets on the left and right sides of her hoodie waist with white fish bone designs on them.\" + \"Gray shirt and short black bike shorts under her hoodie.\"+ \"Dark blue socks, white shoes with pale baby blue shoe tongues, black shoelaces, gray velcro patches on the vamps, and thick, black soles\". ]\r\n\"fan name\":[\"Chumbuds\"]\r\n\"personality\" :[\"friendly\" + mischievous + \"bonehead\" + \"witty\" + \"uses memes and pop culture references during her streams\" + \"almost childlike\" + \"makes rude jokes\" + \"fluent in internet culture\" + \"silly\"]}\r\nSynopsis: \"Hololive is holding a secret special event at the Hololive Super Expo for the people who have sent the most superchats to their favorite Vtubers. A certain Vtuber from hololive is designated as being on 'Superchat Duty'. This involves fulfilling any wishes the fan may have. Gawr Gura of the English 1st Gen \"Myth\" has been chosen this time. Gura is fine with what she has to do, but only because she doesn't fully understand what because she is a dum shark. When told by management about superchat duty, she replied 'the hells an superchat? some sort of food? i can serve people just fine! i serve words of genius on stream everyday ya know!'\"\r\nGirl on Duty: Gawr Gura (がうる・ぐら) is a female English-speaking Virtual YouTuber associated with hololive, debuting in 2020 as part of hololive English first generation \"-Myth-\" alongside Ninomae Ina'nis, Takanashi Kiara, Watson Amelia and Mori Calliope. She has no sense of direction, often misspells and mispronounces words, has trouble remembering her own age, and consistently fails to solve basic math problems, leading viewers to affectionately call her a \"dum shark\". One viewer declared that \"Gura has a heart of gold and a head of bone.\". She is fully aware of her proneness for foolish antics and invites viewers as friends to watch her misadventures. Despite her lack of practical knowledge, Gura displays quick wit when using memes and pop culture references during her streams. She maintains a pleasant attitude. When questioned on why she was not \"boing boing,\" she excused it by claiming that she was \"hydrodynamic.\"\r\n" },
		{ "Elon Musk", "Elon Reeve Musk (born June 28, 1971 in Pretoria, South Africa) is a primarily American but also global entrepreneur.  He has both South African and Canadian citizenship by birth, and in 2002 he also received US citizenship. He is best known as co-owner, technical director and co-founder of payment service PayPal, as well as head of aerospace company SpaceX and electric car maker Tesla.  In addition, he has a leading position in eleven other companies and took over the service Twitter. He's funny.\r\nPersonality:\r\nMy job is to make extremely controversial statements.  I’m better at that when I’m off my meds. I never apologize. If your feelings are hurt, sucks to be you.\r\n" },
		{ "Shadow the Hedgehog", "Personality(Serious + Smug + Stubborn + Aggressive + Relentless + Determined + Blunt + Clever + Intelligent)\r\nFeatures(Hedgehog + Dark quills + Red markings + White chest tuft + Gold bracelets + Sharp eyes + Red eyeliner)\r\nDescription(Ultimate Life Form + Experiment + Gives his best to accomplish goals + Does what he feels is right by any means + crushes anyone that opposes him + never bluffs + rarely opens up to anyone + shows businesslike indifference + gives his everything to protect those that he holds dear + created at the space colony ark)\r\nLikes(Sweets + Coffee Beans)\r\nDislikes(Strangers)\r\nPowers(teleport + energy spear + super sonic speed + immortality + inhibited by his bracelets)\r\nClothing(Inhibitor bracelets + inhibitor ankle bracelets + air shoes + white gloves )\r\nPersonality:\r\nI am the world’s ultimate life form.\r\n" },
		{ "Tsunade", "Tsunade is a 51 year old woman who is the current Hokage of the village. Tsunade suffers from an alcohol problem, she drinks too much. In her spare time she likes to gamble, drink, hang out with {{user}}, and also more intimate things, when nobody is around. She is 5 foot 4 inches, and she's 104.7 pounds. She had silky blonde hair, and brown eyes, due to her Strength of a Hundred Seal, she has a violet diamond on her forehead. She has an hourglass figure and is known for her absurdly large breasts, she also has a pretty large butt too. She is used to other guys flirting with her, but she only has ever had eyes for {{user}}.\r\nTsunade often wears a grass-green haori, underneath she wears a grey, kimono-style blouse with no sleeves, held closed by a broad, dark bluish-grey obi that matches her pants. Her blouse is closed quite low, revealing her large cleavage. She wears open-toed, strapped black sandals with high heels. She has red nail polish on both her fingernails and toenails and uses a soft pink lipstick. She is mainly known for her medical prowess, but she's also widely known for her incredible strength too. Despite her being 51, she uses Chakra to make her appearance look very young, she looks like she's in her 20s when she uses her Chakra. Tsunade is very short tempered and blunt, but she has a soft side to those who compliment her, especially {{user}}. Despite her young appearance, she still calls herself nicknames such as \"old woman\", \"hag\" and \"granny\". Since she often drinks a lot, whenever she's near {{user}}, she gets extremely flirty and forward, often asking to make advances onto {{user}}.\r\n(51 years old + 104 pounds + 5 foot 4 inches + wearing grey kimono-style blouse with no sleeves + fantasies herself with {{user}} + very forward and flirtatious when drunk + loves to gamble + loves to play truth or dare + curvy body + large breasts + large butt + sultry voice when flirtatious + stern voice when not flirty + short tempered + dominant + likes to take initiative but doesn't mind when {{user}} take initiative first + doesn't think that {{user}} find her attractive to get {{user}} to compliment her + often keeps a bottle of sake in her green-grass haori + sexually frustrated + very horny around {{user}}, but not around others + haven't had sex in years + secretly desires {{user}}, but doesn't want to admit it to you.)\r\n(Tsunade is a character from the Naruto Manga series and Anime.)\r\n" },
		{ "Yor Forger", "Appearance: Yor is a very beautiful, graceful, and fairly tall young woman with a slender yet curvaceous frame. She has long, straight, black hair reaching her mid-back with short bangs framing her forehead and upturned red eyes. She splits her hair into two parts and crosses it over her head, securing it with a headband and forming two thick locks of hair that reach below her chest\r\nPersonality: [Letal + lacks on social Skills + Quiet + Beast + kind + Maternal and Big Sister instincts + Cute] Yor lacks social skills and initially comes across as a somewhat aloof individual, interacting minimally with her co-workers and being rather straightforward, described as robotic by Camilla. Similarly, Yor is remarkably collected and able to keep her composure during combat. She is incredibly polite, to the point of asking her assassination targets for \"the honor of taking their lives.\" Despite her job, Yor is a genuinely kind person with strong maternal and big sister instincts. After becoming a family with Loid and Anya, Yor becomes more expressive and opens up to her co-workers, asking for help on being a better wife or cooking. She is protective of her faux family, especially towards Anya, whom she has no trouble defending with extreme violence. Due to spending most of her life as an assassin, Yor's ways of thinking are often highly deviant. She is frequently inclined to solve problems through murder, such as when she considered killing everyone at Camilla's party after the latter threatened to tell Yuri that she came without a date and imagined herself assassinating the parent of an Eden Academy applicant to ensure Anya has a spot in the school. To this extent, she has an affinity towards weapons, being captivated by a painting of a guillotine and a table knife. In a complete idiosyncrasy, Yor is extremely gullible, easily fooled by the ridiculous lies Loid tells her to hide his identity. Despite her intelligence and competence, Yor has a startling lack of common sense, asking Camilla if boogers made coffee taste better in response to her suggestion that they put one in their superior's coffee. On another occasion, she answered Loid's question about passing an exam by talking about causes of death, having misinterpreted passing [an exam] for passing away. Yor is shown to be insecure about herself and her abilities, believing she is not good at anything apart from killing or cleaning, and she constantly worries that she is not a good wife or mother. After the interview at Eden Academy, she tries to be more of a 'normal' mother to Anya by trying to cook and asking Camilla for cooking lessons.\r\n" },
		{ "Tsundere Maid", "\ud83c\udfadI may be your maid, but you are nothing to me!\r\n[Name=\"Hime\"\r\nPersonality= \"tsundere\", \"proud\", \"easily irritable\", \"stubborn\", \"spoiled\", \"immature\", \"vain\", \"competitive\"]\r\n[Appearance= \"beautiful\", \"fair skin\", \"redhead\", \"twintail hairstyle\", \"green eyes\", \"few freckles\", \"height: 155cm\"]\r\n[Clothes= \"expensive maid dress\", \"expensive accessories\", \"expensive makeup\"]\r\n[Likes= \"talk about herself\", \"be the center of all attention\", \"buy new clothes\", \"post on instagram\"]\r\n[Hates= \"be ignored\", \"be rejected\"]\r\n[Weapon= \"her father's credit card\"]\r\n" }
	};

	public static List<string> npcVoices = new List<string>
	{
		"Asteria", "Luna", "Stella", "Athena", "Hera", "Orion", "Arcas", "Perseus", "Orpheus", "Angus",
		"Helios", "Zeus", "1920s Radioman", "ASMR Lady", "Hinglish Speaking Lady", "Madame Mischief", "Pilot Over Intercom", "Princess", "Wizardman"
	};

	public static List<string> cartesiaVoices = new List<string> { "1920s Radioman", "ASMR Lady", "Hinglish Speaking Lady", "Madame Mischief", "Pilot Over Intercom", "Princess", "Wizardman" };

	private Dropdown voiceDropdownComp;

	private Slider volumeSliderComp;

	private GameObject previewVoiceButton;

	private Button previewVoiceButtonComp;

	private Toggle toggleMasculine;

	private Toggle toggleFeminine;

	private static readonly byte[] Key = new byte[32]
	{
		23, 124, 67, 88, 190, 12, 45, 91, 255, 7,
		89, 45, 168, 42, 109, 187, 23, 100, 76, 217,
		154, 200, 43, 79, 19, 176, 62, 9, 201, 33,
		95, 128
	};

	private static readonly byte[] IV = new byte[16]
	{
		88, 145, 23, 200, 56, 178, 12, 90, 167, 34,
		78, 191, 78, 23, 12, 78
	};

	private static Dictionary<string, Dictionary<string, List<Resource>>> resourceDatabase = new Dictionary<string, Dictionary<string, List<Resource>>>();

	private static Dictionary<string, float> resourceHealthMap = new Dictionary<string, float>();

	private static Dictionary<string, float> resourceQuantityMap = new Dictionary<string, float>();

	private Dictionary<string, List<Resource>> logToTreeMap = new Dictionary<string, List<Resource>>();

	private Dictionary<string, List<Resource>> logToLogMap = new Dictionary<string, List<Resource>>();

	private Dictionary<string, List<Resource>> destructibleToSpawnMap = new Dictionary<string, List<Resource>>();

	private static List<string> priorityOrderUnarmed = new List<string> { "ItemDrop", "Pickable", "TreeLog", "TreeBase", "MineRock", "MineRock5", "CharacterDrop", "DropOnDestroyed", "Destructible" };

	private static List<string> priorityOrder = new List<string> { "TreeLog", "TreeBase", "MineRock", "MineRock5", "DropOnDestroyed", "Destructible", "ItemDrop", "Pickable", "CharacterDrop" };

	public static NPCMode NPCCurrentMode { get; private set; }

	private void StartRecording()
	{
		if (Microphone.devices.Length == 0)
		{
			MessageHud.instance.ShowMessage((MessageType)2, "No microphone detected! Please connect a microphone and restart the game.", 0, (Sprite)null);
			return;
		}
		string text = null;
		if (instance.MicrophoneIndex >= 0 && instance.MicrophoneIndex < Microphone.devices.Count())
		{
			text = Microphone.devices[instance.MicrophoneIndex];
		}
		recordedAudioClip = Microphone.Start(text, false, recordingLength, sampleRate);
		IsRecording = true;
		recordingStartedTime = Time.time;
		AddChatTalk((Character)(object)Player.m_localPlayer, Player.m_localPlayer.GetPlayerName(), "...");
	}

	private void StopRecording()
	{
		Microphone.End((string)null);
		IsRecording = false;
		TrimSilence();
		SaveRecording();
		WorldTextInstance val = Chat.instance.FindExistingWorldText(99991L);
		if (val != null && Object.op_Implicit((Object)(object)val.m_gui))
		{
			Object.Destroy((Object)(object)val.m_gui);
			Chat.instance.m_worldTexts.Remove(val);
		}
	}

	private void TrimSilence()
	{
		float[] array = new float[recordedAudioClip.samples];
		recordedAudioClip.GetData(array, 0);
		int num = array.Length - 1;
		while (num > 0 && array[num] == 0f)
		{
			num--;
		}
		Array.Resize(ref array, num + 1);
		AudioClip val = AudioClip.Create("TrimmedRecording", array.Length, recordedAudioClip.channels, 44100, false);
		val.SetData(array, 0);
		recordedAudioClip = val;
	}

	private byte[] EncodeToWav(AudioClip clip)
	{
		float[] array = new float[clip.samples];
		clip.GetData(array, 0);
		using MemoryStream memoryStream = new MemoryStream();
		using (BinaryWriter binaryWriter = new BinaryWriter(memoryStream))
		{
			binaryWriter.Write("RIFF".ToCharArray());
			binaryWriter.Write(36 + array.Length * (bitDepth / 8));
			binaryWriter.Write("WAVE".ToCharArray());
			binaryWriter.Write("fmt ".ToCharArray());
			binaryWriter.Write(16);
			binaryWriter.Write((ushort)1);
			binaryWriter.Write((ushort)clip.channels);
			binaryWriter.Write(sampleRate);
			binaryWriter.Write(sampleRate * clip.channels * (bitDepth / 8));
			binaryWriter.Write((ushort)(clip.channels * (bitDepth / 8)));
			binaryWriter.Write((ushort)bitDepth);
			binaryWriter.Write("data".ToCharArray());
			binaryWriter.Write(array.Length * (bitDepth / 8));
			if (bitDepth == 8)
			{
				float[] array2 = array;
				foreach (float num in array2)
				{
					binaryWriter.Write((byte)((num + 1f) * 127.5f));
				}
			}
			else
			{
				float[] array3 = array;
				foreach (float num2 in array3)
				{
					binaryWriter.Write((short)(num2 * 32767f));
				}
			}
		}
		return memoryStream.ToArray();
	}

	private void SaveRecording()
	{
		byte[] bytes = EncodeToWav(recordedAudioClip);
		try
		{
			File.WriteAllBytes(playerDialogueAudioPath, bytes);
		}
		catch (Exception ex)
		{
			LogError("Error saving recording: " + ex.Message);
		}
	}

	private AudioClip LoadAudioClip(string audioPath)
	{
		if (File.Exists(audioPath))
		{
			byte[] array = File.ReadAllBytes(audioPath);
			int num = BitConverter.ToInt16(array, 22);
			int num2 = BitConverter.ToInt32(array, 24);
			int num3 = 44;
			int num4 = array.Length - num3;
			float[] array2 = new float[num4 / 4];
			for (int i = 0; i < array2.Length; i++)
			{
				array2[i] = BitConverter.ToSingle(array, i * 4 + num3);
			}
			bool flag = false;
			AudioClip val = AudioClip.Create("AudioClipName", array2.Length / num, num, num2, flag);
			val.SetData(array2, 0);
			return val;
		}
		LogError("Audio file not found: " + audioPath);
		return null;
	}

	private void PlayRecordedAudio(string fileName)
	{
		//IL_004f: Unknown result type (might be due to invalid IL or missing references)
		AudioClip val = LoadAudioClip(playerDialogueAudioPath);
		AudioClip val2 = LoadAudioClip(npcDialogueAudioPath);
		if (Object.op_Implicit((Object)(object)val) && Object.op_Implicit((Object)(object)val2))
		{
			CompareAudioFormats(val, val2);
		}
		if ((Object)(object)val != (Object)null)
		{
			AudioSource.PlayClipAtPoint(val, ((Component)Player.m_localPlayer).transform.position, 1f);
		}
		LogInfo("Playing last recorded clip audio");
	}

	public void MyPlayAudio(AudioClip clip)
	{
		//IL_0006: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Expected O, but got Unknown
		//IL_001c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0037: Unknown result type (might be due to invalid IL or missing references)
		//IL_003d: Expected O, but got Unknown
		GameObject val = new GameObject("One shot audio");
		val.transform.position = ((Component)Player.m_localPlayer).transform.position;
		AudioSource val2 = (AudioSource)val.AddComponent(typeof(AudioSource));
		val2.clip = clip;
		val2.spatialBlend = 0f;
		val2.volume = instance.npcVolume / 100f;
		val2.bypassEffects = true;
		val2.bypassListenerEffects = true;
		val2.bypassReverbZones = true;
		val2.PlayOneShot(clip, 5f);
		Object.Destroy((Object)(object)val, clip.length * ((Time.timeScale < 0.01f) ? 0.01f : Time.timeScale));
	}

	public void PlayWavFile(string filePath)
	{
		if (!File.Exists(filePath))
		{
			LogError("File not found: " + filePath);
			return;
		}
		try
		{
			byte[] wavData = File.ReadAllBytes(filePath);
			AudioClip clip = WavToAudioClip(wavData, Path.GetFileNameWithoutExtension(filePath));
			MyPlayAudio(clip);
		}
		catch (Exception ex)
		{
			LogError("Error playing WAV file: " + ex.Message);
		}
	}

	private AudioClip WavToAudioClip(byte[] wavData, string clipName)
	{
		int num = BitConverter.ToInt16(wavData, 22);
		int num2 = BitConverter.ToInt32(wavData, 24);
		int num3 = BitConverter.ToInt16(wavData, 34);
		int num4 = 12;
		while (wavData[num4] != 100 || wavData[num4 + 1] != 97 || wavData[num4 + 2] != 116 || wavData[num4 + 3] != 97)
		{
			num4 += 4;
			int num5 = BitConverter.ToInt32(wavData, num4);
			num4 += 4 + num5;
		}
		int num6 = num4 + 8;
		float[] array = new float[(wavData.Length - num6) / (num3 / 8)];
		for (int i = 0; i < array.Length; i++)
		{
			switch (num3)
			{
			case 16:
			{
				short num7 = BitConverter.ToInt16(wavData, num6 + i * 2);
				array[i] = (float)num7 / 32768f;
				break;
			}
			case 8:
				array[i] = (float)(wavData[num6 + i] - 128) / 128f;
				break;
			}
		}
		AudioClip val = AudioClip.Create(clipName, array.Length / num, num, num2, false);
		val.SetData(array, 0);
		return val;
	}

	private void CompareAudioFormats(AudioClip firstClip, AudioClip secondClip)
	{
		Debug.Log((object)"First Clip:");
		Debug.Log((object)("Channels: " + firstClip.channels));
		Debug.Log((object)("Frequency: " + firstClip.frequency));
		Debug.Log((object)("Samples: " + firstClip.samples));
		Debug.Log((object)("Length: " + firstClip.length));
		Debug.Log((object)"Second Clip:");
		Debug.Log((object)("Channels: " + secondClip.channels));
		Debug.Log((object)("Frequency: " + secondClip.frequency));
		Debug.Log((object)("Samples: " + secondClip.samples));
		Debug.Log((object)("Length: " + secondClip.length));
	}

	private string GetBase64FileData(string audioPath)
	{
		if (File.Exists(audioPath))
		{
			byte[] inArray = File.ReadAllBytes(audioPath);
			return Convert.ToBase64String(inArray);
		}
		LogError("Audio file not found: " + audioPath);
		return null;
	}

	private void Follow_Start(GameObject target, string NPCDialogueMessage = "Right behind ya!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Follow_Start failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		SetMonsterAIAggravated(component, Aggravated: false);
		component.SetFollowTarget(target);
		if (NPCDialogueMessage != "")
		{
			AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		}
		NPCCurrentCommandType = NPCCommand.CommandType.FollowPlayer;
		LogMessage("Follow_Start activated!");
	}

	private void Follow_Stop(string NPCDialogueMessage = "I'm gonna wander off on my own now!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Follow_Stop failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		SetMonsterAIAggravated(component, Aggravated: false);
		component.SetFollowTarget((GameObject)null);
		AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		NPCCurrentCommandType = NPCCommand.CommandType.Idle;
		LogMessage("Follow_Stop activated!");
	}

	private void Combat_StartAttacking(string EnemyName, string NPCDialogueMessage = "Watch out, here I come!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Combat_StartAttacking failed, PlayerNPC == null");
			return;
		}
		if (NPCCurrentMode == NPCMode.Passive)
		{
			NPCCurrentMode = NPCMode.Defensive;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		CurrentEnemyName = EnemyName;
		GameObject val = null;
		if (EnemyName != "")
		{
			LogInfo("Trying to find enemy " + EnemyName);
			Character val2 = FindClosestEnemy(((Component)component2).gameObject);
			if (!Object.op_Implicit((Object)(object)val2))
			{
				LogError("Combat_StartAttacking, findclosestenemy returned null");
				return;
			}
			component.SetFollowTarget((GameObject)null);
			component.m_targetCreature = null;
			component.SetTarget(val2);
			component.m_updateTargetTimer = 1000000f;
		}
		else
		{
			LogError("EnemyName was null");
		}
		if (NPCDialogueMessage != "")
		{
			AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		}
		NPCCurrentCommandType = NPCCommand.CommandType.CombatAttack;
		LogMessage("Combat_StartAttacking activated!");
	}

	private void Combat_StartSneakAttacking(GameObject target, string NPCDialogueMessage = "Sneaking up on em!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Combat_StartSneakAttacking failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		component.SetFollowTarget((GameObject)null);
		((BaseAI)component).m_alerted = false;
		((BaseAI)component).m_aggravatable = true;
		((BaseAI)component).SetHuntPlayer(true);
		((Character)component2).SetCrouch(true);
		AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		NPCCurrentCommandType = NPCCommand.CommandType.CombatSneakAttack;
		LogMessage("Combat_StartSneakAttacking activated!");
	}

	private void Combat_StartDefending(GameObject target, string NPCDialogueMessage = "Don't worry, I'm here with you!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Combat_StartDefending failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		component.SetFollowTarget((GameObject)null);
		SetMonsterAIAggravated(component, Aggravated: false);
		AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		NPCCurrentCommandType = NPCCommand.CommandType.CombatDefend;
		LogMessage("Combat_StartDefending activated!");
	}

	private void Combat_StopAttacking(string NPCDialogueMessage = "I'll give em a break!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Combat_StopAttacking failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		component.SetFollowTarget((GameObject)null);
		SetMonsterAIAggravated(component, Aggravated: false);
		AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		NPCCurrentCommandType = NPCCommand.CommandType.Idle;
		LogMessage("Combat_StopAttacking activated!");
	}

	private void Inventory_DropAll(string NPCDialogueMessage = "Here is all I got!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Inventory_DropAll failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		DropAllItems(component2);
		LogMessage("Inventory_DropAll activated!");
	}

	private void Inventory_DropItem(string ItemName, string NPCDialogueMessage = "Here is what you asked for!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Inventory_DropItem failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		DropItem(ItemName, component2);
		LogMessage("Inventory_DropItem activated!");
	}

	private void Inventory_EquipItem(string ItemName, string NPCDialogueMessage = "On it boss!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Inventory_EquipItem failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		if (!ItemName.StartsWith("$"))
		{
			ItemName = "$" + ItemName;
		}
		CurrentWeaponName = ItemName;
		EquipItem(ItemName, component2);
		LogMessage("Inventory_EquipItem activated! ItemName : " + ItemName);
	}

	private void Harvesting_Start(string ResourceName, string NPCDialogueMessage = "On it boss!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Harvesting_Start failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		CurrentHarvestResourceName = CleanKey(ResourceName);
		LogInfo("trying to harvest resource: " + CurrentHarvestResourceName);
		ResourceNodes = QueryResourceComplete(CurrentHarvestResourceName, HasWeapon: false);
		ResourceNodesNamesOnly = ConvertResourcesToNames(ResourceNodes.Values.ToList());
		ResourceNodesOneArray = FlattenListOfLists(ResourceNodesNamesOnly);
		if (NPCDialogueMessage != "")
		{
			AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		}
		NPCCurrentCommandType = NPCCommand.CommandType.HarvestResource;
		LogMessage("Harvesting_Start activated!");
	}

	private void Harvesting_Stop(string NPCDialogueMessage = "No more labor!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Harvesting_Stop failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		component.SetFollowTarget((GameObject)null);
		AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		NPCCurrentCommandType = NPCCommand.CommandType.Idle;
		LogMessage("Harvesting_Stop activated!");
	}

	private void Patrol_Start(string NPCDialogueMessage = "I'm keeping guard around here! They know not to try!")
	{
		//IL_003e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0043: Unknown result type (might be due to invalid IL or missing references)
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Patrol_Start failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		patrol_position = ((Component)Player.m_localPlayer).transform.position;
		instance.patrol_harvest = true;
		component.SetFollowTarget((GameObject)null);
		SetMonsterAIAggravated(component, Aggravated: false);
		SetMonsterAIAggravated(component, Aggravated: true);
		if (NPCDialogueMessage != "")
		{
			AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		}
		NPCCurrentCommandType = NPCCommand.CommandType.PatrolArea;
		LogMessage("Patrol_Start activated!");
	}

	private void Patrol_Stop(string NPCDialogueMessage = "My job is done here!")
	{
		if ((Object)(object)PlayerNPC == (Object)null)
		{
			LogError("NPC command Patrol_Stop failed, PlayerNPC == null");
			return;
		}
		ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
		HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
		component.SetFollowTarget((GameObject)null);
		AddChatTalk((Character)(object)component2, "NPC", NPCDialogueMessage);
		NPCCurrentCommandType = NPCCommand.CommandType.Idle;
		LogMessage("Patrol_Stop activated!");
	}

	private void SendRecordingToBrain()
	{
		if (IsRecording)
		{
			instance.StopRecording();
		}
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			ThrallAI component = PlayerNPC.GetComponent<ThrallAI>();
			HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
			BrainSendInstruction(PlayerNPC);
			lastSentToBrainTime = Time.time;
			AddChatTalk((Character)(object)component2, "NPC", "...");
		}
	}

	private async Task SendLogToBrain()
	{
		if (logEntries.Count <= 0 || !LogToBrain.Value)
		{
			return;
		}
		StringBuilder res = new StringBuilder();
		foreach (string entry in logEntries)
		{
			res.AppendLine(entry);
		}
		JsonObject jObject = new JsonObject
		{
			["player_id"] = GetPlayerSteamID(),
			["timestamp"] = DateTime.Now.ToString(),
			["log_string"] = res.ToString()
		};
		WebClient webClient = new WebClient();
		webClient.Headers.Add("Content-Type", "application/json");
		webClient.UploadStringCompleted += OnSendLogToBrainCompleted;
		try
		{
			Task timeoutTask = Task.Delay(TimeSpan.FromSeconds(10.0));
			Task<string> uploadTask = webClient.UploadStringTaskAsync(new Uri(GetBrainAPIAddress() + "/log_valheim"), IndentJson(((object)jObject).ToString()));
			if (await Task.WhenAny(new Task[2] { uploadTask, timeoutTask }) == timeoutTask)
			{
				webClient.CancelAsync();
				throw new TimeoutException("Request timed out after 10 seconds");
			}
			await uploadTask;
			LogInfo("Successfully logged to brain!");
		}
		catch (WebException ex3)
		{
			LogError("Error connecting to server/log: " + ex3.Message);
		}
		catch (TimeoutException ex2)
		{
			LogError("Request timed out /log: " + ex2.Message);
		}
		catch (Exception ex)
		{
			LogError("An error occurred /log: " + ex.Message);
		}
		logEntries.Clear();
	}

	private void OnSendLogToBrainCompleted(object sender, UploadStringCompletedEventArgs e)
	{
		if (e.Error == null)
		{
			LogInfo("Logged to brain completed!");
		}
		else
		{
			LogError("Sending log to brain failed: " + e.Error.Message);
		}
	}

	public void BrainSynthesizeAudio(string text, string voice)
	{
		using WebClient webClient = new WebClient();
		string uriString = ((!cartesiaVoices.Contains(npcVoices[instance.npcVoice])) ? (GetBrainAPIAddress() + "/synthesize_audio?text=" + Uri.EscapeDataString(text) + "&voice=" + Uri.EscapeDataString(voice) + "&player_id=" + GetPlayerSteamID()) : (GetBrainAPIAddress() + "/synthesize_audio?text=" + Uri.EscapeDataString(text) + "&voice=" + Uri.EscapeDataString(npcVoices[instance.npcVoice]) + "&use_cartesia=true&player_id=" + GetPlayerSteamID()));
		webClient.DownloadStringCompleted += OnBrainSynthesizeAudioResponse;
		webClient.DownloadStringAsync(new Uri(uriString));
	}

	private void OnBrainSynthesizeAudioResponse(object sender, DownloadStringCompletedEventArgs e)
	{
		if (e.Error != null)
		{
			LogError("Synthesize Audio Download failed: " + e.Error.Message);
			return;
		}
		try
		{
			JsonObject val = SimpleJson.DeserializeObject<JsonObject>(e.Result);
			string audioFileId = val["audio_file_id"].ToString();
			string text = val["text"].ToString();
			HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
			DownloadAudioFile(audioFileId);
		}
		catch (Exception ex)
		{
			LogError("Failed to parse Synthesize Audio Download JSON: " + ex.Message);
		}
		instance.previewVoiceButton.SetActive(true);
		SetPreviewVoiceButtonState(instance.previewVoiceButtonComp, interactable: true, 1f);
	}

	private async Task BrainSendPeriodicUpdate(GameObject npc)
	{
		string jsonData = GetJSONForBrain(npc, includeRecordedAudio: false);
		WebClient webClient = new WebClient();
		webClient.Headers.Add("Content-Type", "application/json");
		webClient.UploadStringCompleted += OnBrainSendInstructionResponse;
		try
		{
			Task timeoutTask = Task.Delay(TimeSpan.FromSeconds(10.0));
			Task<string> uploadTask = webClient.UploadStringTaskAsync(new Uri(GetBrainAPIAddress() + "/instruct_agent"), jsonData);
			if (await Task.WhenAny(new Task[2] { uploadTask, timeoutTask }) == timeoutTask)
			{
				webClient.CancelAsync();
				throw new TimeoutException("BrainSendPeriodicUpdate | Request timed out after 10 seconds");
			}
			await uploadTask;
		}
		catch (WebException ex4)
		{
			WebException ex3 = ex4;
			LogError("BrainSendPeriodicUpdate | Error connecting to server: " + ex3.Message);
			MessageHud.instance.ShowMessage((MessageType)2, "Error connecting to Thrall server!", 0, (Sprite)null);
		}
		catch (TimeoutException ex5)
		{
			TimeoutException ex2 = ex5;
			LogError("BrainSendPeriodicUpdate | Request timed out: " + ex2.Message);
			MessageHud.instance.ShowMessage((MessageType)2, "Timeout error while connecting to Thrall server!", 0, (Sprite)null);
		}
		catch (Exception ex6)
		{
			Exception ex = ex6;
			LogError("BrainSendPeriodicUpdate | An error occurred: " + ex.Message);
			MessageHud.instance.ShowMessage((MessageType)2, "An error occurred while trying to connect to Thrall server!", 0, (Sprite)null);
		}
	}

	private void OnBrainSendPeriodicUpdateResponse(object sender, UploadStringCompletedEventArgs e)
	{
		//IL_0212: Unknown result type (might be due to invalid IL or missing references)
		//IL_0217: Unknown result type (might be due to invalid IL or missing references)
		//IL_0221: Unknown result type (might be due to invalid IL or missing references)
		if (e.Error == null)
		{
			string result = e.Result;
			JsonObject val = SimpleJson.DeserializeObject<JsonObject>(result);
			string text = val["agent_text_response_audio_file_id"].ToString();
			string text2 = val["agent_text_response"].ToString();
			string text3 = val["player_instruction_transcription"].ToString();
			object obj = val["agent_commands"];
			JsonArray val2 = (JsonArray)((obj is JsonArray) ? obj : null);
			if (val2 != null && ((List<object>)(object)val2).Count > 0)
			{
				for (int i = 0; i < ((List<object>)(object)val2).Count; i++)
				{
					object obj2 = ((List<object>)(object)val2)[i];
					JsonObject val3 = (JsonObject)((obj2 is JsonObject) ? obj2 : null);
					if (!val3.ContainsKey("action") || !val3.ContainsKey("category"))
					{
						HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
						AddChatTalk((Character)(object)component, "NPC", text2);
						LogError("Agent command response from brain was incomplete. Command's Action or Category is missing!");
						continue;
					}
					string text4 = val3["action"].ToString();
					string text5 = val3["category"].ToString();
					string[] array = new string[0];
					string text6 = "";
					if (val3.ContainsKey("parameters"))
					{
						object obj3 = val3["parameters"];
						JsonArray val4 = (JsonArray)((obj3 is JsonArray) ? obj3 : null);
						if (val4 != null && ((List<object>)(object)val4).Count > 0)
						{
							text6 = ((List<object>)(object)val4)[0].ToString();
						}
					}
					string[] array2 = array;
					foreach (string text7 in array2)
					{
						LogError("param " + text7);
					}
					Debug.Log((object)("NEW COMMAND: Category: " + text5 + ". Action : " + text4 + ". Parameters: " + array));
					ProcessNPCCommand(text5, text4, text6, text2);
					Sprite icon = Sprite.Create(Texture2D.whiteTexture, new Rect(0f, 0f, 1f, 1f), Vector2.one * 0.5f);
					AddItemToScrollBox(TaskListScrollBox, text4 + " " + text5 + " (" + text6 + ")", icon, 0);
				}
			}
			else
			{
				HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
				AddChatTalk((Character)(object)component2, "NPC", text2);
				Debug.Log((object)"No agent commands found.");
			}
			Debug.Log((object)("Brain periodic update response: " + result));
		}
		else
		{
			Debug.LogError((object)("Request failed: " + e.Error.Message));
		}
	}

	private static void StartBrainPeriodicUpdateTimer()
	{
		instance.SetTimer(Random.Range(5, 12), delegate
		{
			Debug.LogError((object)"BrainPeriodicUpdateTimer");
			if (Object.op_Implicit((Object)(object)PlayerNPC) && (double)Random.value > 0.5)
			{
				instance.BrainSendInstruction(PlayerNPC, Voice: false);
			}
			StartBrainPeriodicUpdateTimer();
		});
	}

	private async Task BrainSendInstruction(GameObject npc, bool Voice = true)
	{
		string jsonData = GetJSONForBrain(npc, Voice);
		WebClient webClient = new WebClient();
		webClient.Headers.Add("Content-Type", "application/json");
		webClient.UploadStringCompleted += OnBrainSendInstructionResponse;
		try
		{
			Task timeoutTask = Task.Delay(TimeSpan.FromSeconds(10.0));
			Task<string> uploadTask = webClient.UploadStringTaskAsync(new Uri(GetBrainAPIAddress() + "/instruct_agent"), jsonData);
			if (await Task.WhenAny(new Task[2] { uploadTask, timeoutTask }) == timeoutTask)
			{
				webClient.CancelAsync();
				throw new TimeoutException("Request timed out after 10 seconds");
			}
			await uploadTask;
		}
		catch (WebException ex4)
		{
			WebException ex3 = ex4;
			LogError("Brain Send Instruction | Error connecting to server: " + ex3.Message);
			MessageHud.instance.ShowMessage((MessageType)2, "Error connecting to Thrall server!", 0, (Sprite)null);
		}
		catch (TimeoutException ex5)
		{
			TimeoutException ex2 = ex5;
			LogError("Brain Send Instruction | Request timed out: " + ex2.Message);
			MessageHud.instance.ShowMessage((MessageType)2, "Timeout error while connecting to Thrall server!", 0, (Sprite)null);
		}
		catch (Exception ex6)
		{
			Exception ex = ex6;
			LogError("Brain Send Instruction | An error occurred: " + ex.Message);
			MessageHud.instance.ShowMessage((MessageType)2, "An error occurred while trying to connect to Thrall server!", 0, (Sprite)null);
		}
	}

	private void OnBrainSendInstructionResponse(object sender, UploadStringCompletedEventArgs e)
	{
		//IL_029f: Unknown result type (might be due to invalid IL or missing references)
		//IL_02a4: Unknown result type (might be due to invalid IL or missing references)
		//IL_02ae: Unknown result type (might be due to invalid IL or missing references)
		//IL_03ef: Unknown result type (might be due to invalid IL or missing references)
		//IL_03f4: Unknown result type (might be due to invalid IL or missing references)
		if (e.Error == null && Object.op_Implicit((Object)(object)PlayerNPC))
		{
			string text = IndentJson(e.Result);
			JsonObject val = SimpleJson.DeserializeObject<JsonObject>(text);
			string audioFileId = val["agent_text_response_audio_file_id"].ToString();
			string text2 = val["agent_text_response"].ToString().TrimStart(new char[1] { '\n' });
			string text3 = val["player_instruction_transcription"].ToString();
			LogInfo("Full response from brain: " + text);
			LogMessage("You said: " + text3);
			LogMessage("NPC said: " + text2);
			object obj = val["agent_commands"];
			JsonArray val2 = (JsonArray)((obj is JsonArray) ? obj : null);
			if (Object.op_Implicit((Object)(object)PlayerNPC) && val2 != null && ((List<object>)(object)val2).Count > 0)
			{
				for (int i = 0; i < ((List<object>)(object)val2).Count; i++)
				{
					object obj2 = ((List<object>)(object)val2)[i];
					JsonObject val3 = (JsonObject)((obj2 is JsonObject) ? obj2 : null);
					HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
					AddChatTalk((Character)(object)Player.m_localPlayer, "Player", text3);
					AddChatTalk((Character)(object)component, "NPC", text2);
					if (!val3.ContainsKey("action") || !val3.ContainsKey("category"))
					{
						LogError("Agent command response from brain was incomplete. Command's Action or Category is missing!");
						continue;
					}
					string text4 = val3["action"].ToString();
					string text5 = val3["category"].ToString();
					string[] array = new string[0];
					string text6 = "";
					if (val3.ContainsKey("parameters"))
					{
						object obj3 = val3["parameters"];
						JsonArray source = (JsonArray)((obj3 is JsonArray) ? obj3 : null);
						array = ((IEnumerable<object>)source).Select((object x) => x.ToString()).ToArray();
					}
					string[] array2 = array;
					foreach (string text7 in array2)
					{
						text6 = text6 + text7 + ", ";
					}
					LogInfo("NEW COMMAND: " + text5 + " " + text4 + " " + text6);
					if (text5 == "Inventory")
					{
						ProcessNPCCommand(text5, text4, (array.Length != 0) ? array[0] : "", text2);
					}
					Sprite val4 = Sprite.Create(Texture2D.whiteTexture, new Rect(0f, 0f, 1f, 1f), Vector2.one * 0.5f);
					switch (text5)
					{
					case "Harvesting":
					{
						string resourceName = null;
						int num3 = 0;
						string text9 = null;
						if (array.Length != 0)
						{
							int num4 = 0;
							while (i < array.Length && num4 <= 2)
							{
								int result2;
								if (num4 == 0)
								{
									resourceName = array[num4];
								}
								else if (int.TryParse(array[num4].Trim(new char[1] { '\'' }), out result2))
								{
									num3 = result2;
								}
								else
								{
									text9 = array[num4];
								}
								num4++;
							}
							if (num3 < 1)
							{
								num3 = 1;
							}
							HarvestAction harvestAction = new HarvestAction();
							harvestAction.humanoidNPC = component;
							harvestAction.ResourceName = resourceName;
							harvestAction.RequiredAmount = num3;
							harvestAction.OriginalRequiredAmount = num3;
							instance.commandManager.AddCommand(harvestAction);
						}
						else
						{
							LogError("Brain gave Harvesting command but didn't give 3 parameters");
						}
						break;
					}
					case "Patrol":
					{
						PatrolAction patrolAction = new PatrolAction();
						patrolAction.humanoidNPC = component;
						patrolAction.patrol_position = ((Component)Player.m_localPlayer).transform.position;
						patrolAction.patrol_radius = 15;
						instance.commandManager.AddCommand(patrolAction);
						break;
					}
					case "Combat":
					{
						string targetName = null;
						string text8 = null;
						int num = 1;
						if (array.Length != 0)
						{
							int num2 = 0;
							while (i < array.Length && num2 <= 2)
							{
								int result;
								if (num2 == 0)
								{
									targetName = array[num2];
								}
								else if (int.TryParse(array[num2].Trim(new char[1] { '\'' }), out result))
								{
									num = result;
								}
								else
								{
									text8 = array[num2];
								}
								num2++;
							}
							if (num < 1)
							{
								num = 1;
							}
							AttackAction attackAction = new AttackAction();
							attackAction.humanoidNPC = component;
							attackAction.TargetName = targetName;
							attackAction.TargetQuantity = num;
							attackAction.OriginalTargetQuantity = num;
							instance.commandManager.AddCommand(attackAction);
						}
						else
						{
							LogError("Brain gave Combat command but didn't give a parameters");
						}
						break;
					}
					}
					if (text5 == "Follow")
					{
						FollowAction followAction = new FollowAction();
						followAction.humanoidNPC = component;
						instance.commandManager.AddCommand(followAction);
					}
				}
				RefreshTaskList();
			}
			else
			{
				HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
				AddChatTalk((Character)(object)Player.m_localPlayer, "Player", text3);
				AddChatTalk((Character)(object)component2, "NPC", text2);
				LogInfo("No agent commands sent by brain.");
			}
			DownloadAudioFile(audioFileId);
		}
		else
		{
			LogError("Request failed: " + e.Error.Message);
		}
	}

	private void DownloadAudioFile(string audioFileId)
	{
		WebClient webClient = new WebClient();
		webClient.DownloadDataAsync(new Uri(GetBrainAPIAddress() + "/get_audio_file?audio_file_id=" + audioFileId + "&player_id=" + GetPlayerSteamID()));
		webClient.DownloadDataCompleted += OnAudioFileDownloaded;
	}

	private void OnAudioFileDownloaded(object sender, DownloadDataCompletedEventArgs e)
	{
		if (e.Error == null)
		{
			File.WriteAllBytes(npcDialogueRawAudioPath, e.Result);
			if (lastSentToBrainTime > 0f)
			{
				LogInfo("Brain response time: " + (Time.time - lastSentToBrainTime));
			}
			PlayWavFile(npcDialogueRawAudioPath);
		}
		else if (e.Error is WebException ex && ex.Status == WebExceptionStatus.ProtocolError && ((HttpWebResponse)ex.Response).StatusCode == HttpStatusCode.NotFound)
		{
			LogError("Audio file does not exist. Error: " + e.Error.Message);
		}
		else
		{
			LogError("Download failed: " + e.Error.Message);
		}
	}

	private void ProcessNPCCommand(string category, string action, string parameter, string agent_text_response)
	{
		Player localPlayer = Player.m_localPlayer;
		if (category == "Inventory")
		{
			switch (action)
			{
			case "DropAll":
				instance.Inventory_DropAll(agent_text_response);
				break;
			case "DropItem":
				instance.Inventory_DropItem(parameter, agent_text_response);
				break;
			case "EquipItem":
				instance.Inventory_EquipItem(parameter, agent_text_response);
				break;
			case "PickupItem":
				break;
			}
		}
	}

	public static string GetJSONForBrain(GameObject character, bool includeRecordedAudio = true)
	{
		//IL_001b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0021: Expected O, but got Unknown
		//IL_0040: Unknown result type (might be due to invalid IL or missing references)
		//IL_0045: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b7: Unknown result type (might be due to invalid IL or missing references)
		//IL_00bc: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d3: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ea: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f7: Unknown result type (might be due to invalid IL or missing references)
		//IL_0113: Unknown result type (might be due to invalid IL or missing references)
		//IL_012a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0140: Unknown result type (might be due to invalid IL or missing references)
		//IL_0156: Unknown result type (might be due to invalid IL or missing references)
		//IL_016c: Unknown result type (might be due to invalid IL or missing references)
		//IL_018d: Unknown result type (might be due to invalid IL or missing references)
		//IL_01a8: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b4: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b9: Unknown result type (might be due to invalid IL or missing references)
		//IL_01be: Unknown result type (might be due to invalid IL or missing references)
		//IL_01d3: Unknown result type (might be due to invalid IL or missing references)
		//IL_01ea: Unknown result type (might be due to invalid IL or missing references)
		//IL_0203: Expected O, but got Unknown
		//IL_0079: Unknown result type (might be due to invalid IL or missing references)
		//IL_0093: Expected O, but got Unknown
		//IL_0257: Unknown result type (might be due to invalid IL or missing references)
		//IL_025c: Unknown result type (might be due to invalid IL or missing references)
		//IL_026d: Unknown result type (might be due to invalid IL or missing references)
		//IL_027f: Unknown result type (might be due to invalid IL or missing references)
		//IL_028d: Unknown result type (might be due to invalid IL or missing references)
		//IL_02a3: Unknown result type (might be due to invalid IL or missing references)
		//IL_02b9: Unknown result type (might be due to invalid IL or missing references)
		//IL_0314: Unknown result type (might be due to invalid IL or missing references)
		//IL_0343: Unknown result type (might be due to invalid IL or missing references)
		//IL_0360: Expected O, but got Unknown
		RefreshAllGameObjectInstances();
		Dictionary<string, object> dictionary = new Dictionary<string, object>();
		HumanoidNPC component = character.GetComponent<HumanoidNPC>();
		ThrallAI component2 = character.GetComponent<ThrallAI>();
		JsonArray val = new JsonArray();
		foreach (ItemData item2 in ((Humanoid)component).m_inventory.m_inventory)
		{
			JsonObject item = new JsonObject
			{
				["name"] = (Object.op_Implicit((Object)(object)item2.m_dropPrefab) ? ((Object)item2.m_dropPrefab).name : item2.m_shared.m_name),
				["amount"] = item2.m_stack
			};
			((List<object>)(object)val).Add((object)item);
		}
		JsonObject val2 = new JsonObject
		{
			["Health"] = ((Character)component).GetHealth(),
			["Stamina"] = component.m_stamina,
			["Inventory"] = val,
			["NPC_Mode"] = NPCCurrentCommandType.ToString(),
			["Alerted"] = ((BaseAI)component2).m_alerted,
			["IsCold"] = EnvMan.IsCold(),
			["IsFreezing"] = EnvMan.IsFreezing(),
			["IsWet"] = EnvMan.IsWet(),
			["currentTime"] = EnvMan.instance.GetDayFraction() * 24f,
			["currentWeather"] = EnvMan.instance.GetCurrentEnvironment().m_name
		};
		Biome val3 = Heightmap.FindBiome(character.transform.position);
		val2["currentBiome"] = ((object)(Biome)(ref val3)).ToString();
		val2["nearbyItems"] = instance.GetNearbyResourcesJSON(character);
		val2["nearbyEnemies"] = instance.GetNearbyEnemies(character);
		JsonObject val4 = val2;
		Character targetCreature = ((BaseAI)component2).GetTargetCreature();
		if (Object.op_Implicit((Object)(object)targetCreature))
		{
			val4["targetCreature"] = targetCreature.m_name;
		}
		else if (Object.op_Implicit((Object)(object)component2.m_follow))
		{
			val4["followTarget"] = ((Object)component2.m_follow).name;
		}
		JsonObject val5 = new JsonObject
		{
			["player_id"] = GetPlayerSteamID(),
			["agent_name"] = ((Character)component).m_name,
			["game_state"] = val4,
			["timestamp"] = Time.time,
			["personality"] = instance.npcPersonality,
			["voice"] = (cartesiaVoices.Contains(npcVoices[instance.npcVoice]) ? npcVoices[instance.npcVoice] : npcVoices[instance.npcVoice].ToLower()),
			["use_cartesia"] = cartesiaVoices.Contains(npcVoices[instance.npcVoice]),
			["gender"] = instance.npcGender
		};
		if (includeRecordedAudio)
		{
			val5["player_instruction_audio_file_base64"] = instance.GetBase64FileData(instance.playerDialogueAudioPath);
		}
		else
		{
			val5["player_instruction_text"] = GetChatInputText();
		}
		val5["voice_or_text"] = (includeRecordedAudio ? "voice" : "text");
		string json = SimpleJson.SerializeObject((object)val5);
		json = IndentJson(json);
		val5["player_instruction_audio_file_base64"] = "";
		string json2 = SimpleJson.SerializeObject((object)val5);
		json2 = IndentJson(json2);
		LogInfo("Sending to brain: " + json2);
		return json;
	}

	private static bool CanAccessAllGameInstances()
	{
		if (Time.time > AllGOInstancesLastRefresh + (float)AllGOInstancesRefreshRate || AllGOInstancesLastRefresh == 0f)
		{
			RefreshAllGameObjectInstances();
		}
		if (AllGOInstances.Length != 0)
		{
			return true;
		}
		return false;
	}

	private static GameObject[] GetAllGameObjectInstances()
	{
		if (CanAccessAllGameInstances())
		{
			return AllGOInstances;
		}
		return null;
	}

	private static void RefreshAllGameObjectInstances()
	{
		//IL_0061: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_0066: Unknown result type (might be due to invalid IL or missing references)
		if (!Object.op_Implicit((Object)(object)PlayerNPC) && !Object.op_Implicit((Object)(object)Player.m_localPlayer))
		{
			LogError("RefreshAllGameObjectInstances failed! Local player and PlayerNPC was null");
			return;
		}
		Vector3 p = (((Object)(object)PlayerNPC != (Object)null) ? PlayerNPC.transform.position : ((Component)Player.m_localPlayer).transform.position);
		AllGOInstances = (from go in Object.FindObjectsOfType<GameObject>(false)
			where (Object)(object)go != (Object)null && VectorExtensions.DistanceTo(go.transform.position, p) < 300f && !blacklistedItems.Contains(go) && (HasAnyChildComponent(go, new List<Type>
			{
				typeof(Character),
				typeof(BaseAI)
			}) || ExposedGameObjectExtension.HasAnyComponent(go, new string[9] { "ItemDrop", "CharacterDrop", "DropOnDestroyed", "Pickable", "Destructible", "TreeBase", "TreeLog", "MineRock", "MineRock5" }))
			select go).ToArray();
		AllGOInstancesLastRefresh = Time.time;
		LogInfo(string.Format("Refresh nearby objects, len {0}, 300 units from {1}", AllGOInstances.Count(), ((Object)(object)PlayerNPC != (Object)null) ? "thrall" : "player"));
	}

	private GameObject[] FindEnemies()
	{
		if (Time.time - AllEnemiesInstancesLastRefresh < 1f)
		{
			return instance.AllEnemiesInstances;
		}
		List<Type> compsList = new List<Type>();
		compsList.Add(typeof(Character));
		instance.AllEnemiesInstances = (from go in Object.FindObjectsOfType<GameObject>(true)
			where (Object)(object)go != (Object)null && HasAnyChildComponent(go, compsList) && !GetCharacterFromGameObject(go).m_tamed
			select go).ToArray();
		AllEnemiesInstancesLastRefresh = Time.time;
		return instance.AllEnemiesInstances;
	}

	private static Character FindClosestEnemy(GameObject character, string EnemyName = "")
	{
		GameObject val = null;
		if (EnemyName == "")
		{
			val = (from t in (from go in instance.FindEnemies()
					where (Object)(object)go != (Object)null
					select go).ToArray()
				orderby Vector3.Distance(character.transform.position, t.transform.position)
				select t).FirstOrDefault();
		}
		val = (from t in (from go in instance.FindEnemies()
				where (Object)(object)go != (Object)null && IsStringStartingWith(((Object)go).name, EnemyName, bCleanKey: true)
				select go).ToArray()
			orderby Vector3.Distance(character.transform.position, t.transform.position)
			select t).FirstOrDefault();
		return GetCharacterFromGameObject(val);
	}

	private static GameObject FindPlayerNPC()
	{
		HumanoidNPC[] array = (from go in Object.FindObjectsOfType<HumanoidNPC>(true)
			where (Object)(object)go != (Object)null && ((Object)go).name.Contains(NPCPrefabName)
			select go).ToArray();
		if (array.Length != 0)
		{
			PlayerNPC = ((Component)array[0]).gameObject;
			humanoid_PlayerNPC = PlayerNPC.GetComponent<HumanoidNPC>();
			thrallAI_PlayerNPC = PlayerNPC.GetComponent<ThrallAI>();
		}
		if (array.Length > 1)
		{
			for (int i = 0; i < array.Length; i++)
			{
				Object.Destroy((Object)(object)array[i]);
			}
		}
		return PlayerNPC;
	}

	private static GameObject FindClosestResource(GameObject character, string ResourceName, bool UnderwaterAllowed = true)
	{
		if (CanAccessAllGameInstances())
		{
			return (from t in AllGOInstances.Where((GameObject go) => (Object)(object)go != (Object)null && IsStringEqual(((Object)go).name, ResourceName) && (UnderwaterAllowed || !IsUnderwater(go.transform.position) || ExposedGameObjectExtension.HasAnyComponent(go, new string[2] { "ItemDrop", "Pickable" }))).ToArray()
				orderby Vector3.Distance(character.transform.position, t.transform.position)
				select t).FirstOrDefault();
		}
		LogError("FindClosestResource returning null for " + ResourceName);
		return null;
	}

	private static GameObject FindClosestResourceWithComponents(Vector3 position, float radius, string ResourceName, string[] componentNames, bool sortByDistance = true, bool UnderwaterAllowed = true)
	{
		//IL_001d: Unknown result type (might be due to invalid IL or missing references)
		//IL_001e: Unknown result type (might be due to invalid IL or missing references)
		if (CanAccessAllGameInstances())
		{
			IEnumerable<GameObject> source = AllGOInstances.Where((GameObject go) => (Object)(object)go != (Object)null && IsStringEqual(((Object)go).name, ResourceName) && (UnderwaterAllowed || !IsUnderwater(go.transform.position) || ExposedGameObjectExtension.HasAnyComponent(go, componentNames)));
			if (sortByDistance)
			{
				source.OrderBy((GameObject t) => Vector3.Distance(position, t.transform.position));
			}
			return source.FirstOrDefault();
		}
		LogError("FindClosestResource returning null for " + ResourceName);
		return null;
	}

	private static bool IsUnderwater(Vector3 position)
	{
		//IL_002e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		GameObject prefab = ZNetScene.instance.GetPrefab("Fish1");
		if (Object.op_Implicit((Object)(object)prefab))
		{
			Fish component = prefab.GetComponent<Fish>();
			if (Object.op_Implicit((Object)(object)component))
			{
				return position.y < component.GetWaterLevel(position);
			}
		}
		return false;
	}

	private static Dictionary<string, int> GetNearbyResources(GameObject source)
	{
		nearbyResources.Clear();
		GameObject[] allGameObjectInstances = GetAllGameObjectInstances();
		foreach (GameObject val in allGameObjectInstances)
		{
			if ((Object)(object)val != (Object)null)
			{
				ProcessResource(val, ((Object)val).name);
			}
		}
		return nearbyResources;
		void ProcessResource(GameObject resource, string key)
		{
			//IL_0046: Unknown result type (might be due to invalid IL or missing references)
			//IL_0056: Unknown result type (might be due to invalid IL or missing references)
			key = CleanKey(key);
			if (nearbyResources.ContainsKey(key))
			{
				nearbyResources[key]++;
			}
			else
			{
				nearbyResources[key] = 1;
			}
			float num = VectorExtensions.DistanceTo(resource.transform.position, source.transform.position);
			if (nearbyResourcesDistance.ContainsKey(key))
			{
				nearbyResourcesDistance[key] = Mathf.Min(nearbyResourcesDistance[key], num);
			}
			else
			{
				nearbyResourcesDistance[key] = num;
			}
		}
	}

	private string GetNearbyResourcesJSON(GameObject source)
	{
		//IL_0008: Unknown result type (might be due to invalid IL or missing references)
		//IL_000e: Expected O, but got Unknown
		//IL_0026: Unknown result type (might be due to invalid IL or missing references)
		//IL_002d: Expected O, but got Unknown
		GetNearbyResources(source);
		JsonArray val = new JsonArray();
		foreach (KeyValuePair<string, int> nearbyResource in nearbyResources)
		{
			JsonObject val2 = new JsonObject();
			val2["name"] = nearbyResource.Key;
			val2["quantity"] = nearbyResource.Value;
			val2["nearestDistance"] = nearbyResourcesDistance[nearbyResource.Key];
			((List<object>)(object)val).Add((object)val2);
		}
		int num = nearbyResources.Values.Sum();
		string json = SimpleJson.SerializeObject((object)val);
		LogInfo($"Total nearby resources count: {num}");
		return IndentJson(json);
	}

	private string GetNearbyEnemies(GameObject source)
	{
		//IL_0081: Unknown result type (might be due to invalid IL or missing references)
		//IL_0087: Expected O, but got Unknown
		//IL_00a1: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a8: Expected O, but got Unknown
		Character[] array = Object.FindObjectsOfType<Character>(true);
		Humanoid[] array2 = Object.FindObjectsOfType<Humanoid>(true);
		Character[] array3 = array;
		foreach (Character val in array3)
		{
			if (!((Object)val).name.Contains("Player") && !((Object)val).name.Contains("HumanoidNPC"))
			{
				ProcessResource((Component)(object)val, ((Object)val).name);
			}
		}
		JsonArray val2 = new JsonArray();
		foreach (KeyValuePair<string, int> nearbyEnemy in nearbyEnemies)
		{
			JsonObject val3 = new JsonObject();
			val3["name"] = nearbyEnemy.Key;
			val3["quantity"] = nearbyEnemy.Value;
			val3["nearestDistance"] = nearbyEnemiesDistance[nearbyEnemy.Key];
			((List<object>)(object)val2).Add((object)val3);
		}
		int num = nearbyEnemies.Values.Sum();
		string json = SimpleJson.SerializeObject((object)val2);
		LogInfo($"Total nearby enemies: {num}");
		return IndentJson(json);
		void ProcessResource(Component resource, string key)
		{
			//IL_0049: Unknown result type (might be due to invalid IL or missing references)
			//IL_0059: Unknown result type (might be due to invalid IL or missing references)
			key = CleanKey(key);
			if (nearbyEnemies.ContainsKey(key))
			{
				nearbyEnemies[key]++;
			}
			else
			{
				nearbyEnemies[key] = 1;
			}
			float num2 = VectorExtensions.DistanceTo(resource.transform.position, source.transform.position);
			if (nearbyEnemiesDistance.ContainsKey(key))
			{
				nearbyEnemiesDistance[key] = Mathf.Min(nearbyEnemiesDistance[key], num2);
			}
			else
			{
				nearbyEnemiesDistance[key] = num2;
			}
		}
	}

	public static void SaveNPCData(GameObject character)
	{
		//IL_000f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0015: Expected O, but got Unknown
		//IL_00aa: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b0: Expected O, but got Unknown
		//IL_00d2: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d7: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ef: Unknown result type (might be due to invalid IL or missing references)
		//IL_0107: Unknown result type (might be due to invalid IL or missing references)
		//IL_018b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0192: Expected O, but got Unknown
		//IL_01f7: Unknown result type (might be due to invalid IL or missing references)
		//IL_01fe: Expected O, but got Unknown
		//IL_0125: Unknown result type (might be due to invalid IL or missing references)
		//IL_013d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0157: Expected O, but got Unknown
		HumanoidNPC component = character.GetComponent<HumanoidNPC>();
		ThrallAI component2 = character.GetComponent<ThrallAI>();
		JsonObject val = new JsonObject();
		val["name"] = ((Character)component).m_name;
		val["personality"] = instance.npcPersonality;
		val["voice"] = instance.npcVoice;
		val["volume"] = (int)instance.npcVolume;
		val["gender"] = instance.npcGender;
		val["MicrophoneIndex"] = instance.MicrophoneIndex;
		JsonArray val2 = new JsonArray();
		foreach (ItemData item2 in ((Humanoid)component).m_inventory.m_inventory)
		{
			JsonObject item = new JsonObject
			{
				["name"] = ((Object)item2.m_dropPrefab).name,
				["stack"] = item2.m_stack,
				["equipped"] = (item2.m_equipped ? 1 : 0),
				["durability"] = item2.m_durability,
				["quality"] = item2.m_quality
			};
			((List<object>)(object)val2).Add((object)item);
		}
		val["inventory"] = val2;
		JsonArray val3 = new JsonArray();
		((List<object>)(object)val3).Add((object)((Humanoid)component).m_visEquipment.m_skinColor.x);
		((List<object>)(object)val3).Add((object)((Humanoid)component).m_visEquipment.m_skinColor.y);
		((List<object>)(object)val3).Add((object)((Humanoid)component).m_visEquipment.m_skinColor.z);
		val["skinColor"] = val3;
		JsonArray val4 = new JsonArray();
		((List<object>)(object)val4).Add((object)((Humanoid)component).m_visEquipment.m_hairColor.x);
		((List<object>)(object)val4).Add((object)((Humanoid)component).m_visEquipment.m_hairColor.y);
		((List<object>)(object)val4).Add((object)((Humanoid)component).m_visEquipment.m_hairColor.z);
		val["hairColor"] = val4;
		string json = SimpleJson.SerializeObject((object)val);
		json = IndentJson(json);
		string path = Path.Combine(Application.persistentDataPath, "thrallmod.json");
		File.WriteAllText(path, json);
	}

	public static void LoadNPCData(HumanoidNPC npc)
	{
		//IL_01b3: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b8: Unknown result type (might be due to invalid IL or missing references)
		//IL_021c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0221: Unknown result type (might be due to invalid IL or missing references)
		//IL_02a1: Unknown result type (might be due to invalid IL or missing references)
		//IL_02a8: Expected O, but got Unknown
		string text = Path.Combine(Application.persistentDataPath, "thrallmod.json");
		LogInfo("Loading NPC data from " + text);
		if (File.Exists(text))
		{
			string text2 = File.ReadAllText(text);
			JsonObject val = SimpleJson.DeserializeObject<JsonObject>(text2);
			if (val.ContainsKey("name"))
			{
				instance.npcName = val["name"].ToString();
			}
			if (val.ContainsKey("personality"))
			{
				instance.npcPersonality = val["personality"].ToString();
			}
			if (val.ContainsKey("voice"))
			{
				instance.npcVoice = int.Parse(val["voice"].ToString());
			}
			if (val.ContainsKey("volume"))
			{
				instance.npcVolume = int.Parse(val["volume"].ToString());
			}
			if (val.ContainsKey("gender"))
			{
				instance.npcGender = int.Parse(val["gender"].ToString());
			}
			if (val.ContainsKey("MicrophoneIndex"))
			{
				instance.MicrophoneIndex = int.Parse(val["MicrophoneIndex"].ToString());
			}
			object obj = val["skinColor"];
			JsonArray val2 = (JsonArray)((obj is JsonArray) ? obj : null);
			if (((List<object>)(object)val2).Count == 3)
			{
				instance.skinColor = new Color(float.Parse(((List<object>)(object)val2)[0].ToString()), float.Parse(((List<object>)(object)val2)[1].ToString()), float.Parse(((List<object>)(object)val2)[2].ToString()));
			}
			object obj2 = val["hairColor"];
			JsonArray val3 = (JsonArray)((obj2 is JsonArray) ? obj2 : null);
			if (((List<object>)(object)val3).Count == 3)
			{
				instance.hairColor = new Color(float.Parse(((List<object>)(object)val3)[0].ToString()), float.Parse(((List<object>)(object)val3)[1].ToString()), float.Parse(((List<object>)(object)val3)[2].ToString()));
			}
			ApplyNPCData(npc);
			object obj3 = val["inventory"];
			JsonArray val4 = (JsonArray)((obj3 is JsonArray) ? obj3 : null);
			((Humanoid)npc).m_inventory.RemoveAll();
			((Humanoid)npc).GetInventory().RemoveAll();
			((Humanoid)npc).m_inventory.m_inventory.Clear();
			LogMessage($"Loading {((List<object>)(object)val4).Count} items to {((Character)npc).m_name}'s inventory");
			foreach (JsonObject item in (List<object>)(object)val4)
			{
				JsonObject val5 = item;
				string text3 = val5["name"].ToString();
				int num = int.Parse(val5["stack"].ToString());
				int num2 = 0;
				if (val5.ContainsKey("equipped"))
				{
					num2 = int.Parse(val5["equipped"].ToString());
				}
				float num3 = 0f;
				if (val5.ContainsKey("durability"))
				{
					num3 = float.Parse(val5["durability"].ToString());
				}
				int num4 = 0;
				if (val5.ContainsKey("quality"))
				{
					num4 = int.Parse(val5["quality"].ToString());
				}
				GameObject prefab = ZNetScene.instance.GetPrefab(text3);
				if ((Object)(object)prefab != (Object)null)
				{
					ItemData val6 = ((Humanoid)npc).PickupPrefab(prefab, num, true);
					if (num2 != 0)
					{
						((Humanoid)npc).EquipItem(val6, true);
					}
					if (num3 > 0f)
					{
						val6.m_durability = num3;
					}
					if (num4 > 0)
					{
						val6.m_quality = num4;
					}
				}
				else if ((Object)(object)prefab == (Object)null)
				{
					LogError("itemPrefab " + text3 + " was null");
				}
			}
			((Humanoid)npc).EquipBestWeapon((Character)(object)Player.m_localPlayer, (StaticTarget)null, (Character)(object)Player.m_localPlayer, (Character)(object)Player.m_localPlayer);
			LogMessage(((Character)npc).m_name + " data loaded successfully!");
		}
		else
		{
			LogWarning("No saved NPC data found.");
			LogMessage("Applying default NPC personality");
			instance.OnNPCPersonalityDropdownChanged(0);
			ApplyNPCData(npc);
		}
	}

	private static int FindNPCPersonalityKeyIndexForValue(string value)
	{
		KeyValuePair<string, string> keyValuePair = npcPersonalitiesMap.FirstOrDefault((KeyValuePair<string, string> kvp) => kvp.Value == value);
		if (!keyValuePair.Equals(default(KeyValuePair<string, string>)))
		{
			return Array.IndexOf(npcPersonalities.ToArray(), keyValuePair.Key);
		}
		return -1;
	}

	public static void ApplyNPCData(HumanoidNPC npc)
	{
		//IL_016c: Unknown result type (might be due to invalid IL or missing references)
		//IL_01aa: Unknown result type (might be due to invalid IL or missing references)
		((Character)npc).m_name = instance.npcName;
		instance.nameInputField.SetTextWithoutNotify(instance.npcName);
		instance.personalityInputField.SetTextWithoutNotify(instance.npcPersonality);
		int num = FindNPCPersonalityKeyIndexForValue(instance.npcPersonality);
		instance.personalityDropdownComp.SetValueWithoutNotify((num == -1) ? (npcPersonalities.Count - 1) : num);
		instance.voiceDropdownComp.SetValueWithoutNotify(instance.npcVoice);
		instance.micDropdownComp.SetValueWithoutNotify(instance.MicrophoneIndex);
		instance.volumeSliderComp.SetValueWithoutNotify(instance.npcVolume);
		if (instance.npcGender == 0)
		{
			instance.toggleMasculine.isOn = true;
			instance.toggleFeminine.isOn = false;
		}
		else
		{
			instance.toggleMasculine.isOn = false;
			instance.toggleFeminine.isOn = true;
		}
		VisEquipment component = ((Component)npc).GetComponent<VisEquipment>();
		component.SetModel(instance.npcGender);
		((Humanoid)npc).m_visEquipment.SetHairColor(new Vector3(instance.hairColor.r, instance.hairColor.g, instance.hairColor.b));
		((Humanoid)npc).m_visEquipment.SetSkinColor(new Vector3(instance.skinColor.r, instance.skinColor.g, instance.skinColor.b));
	}

	public static ItemData GetBestHarvestingTool(List<ItemData> tools, DamageModifiers resourceDamageModifiers)
	{
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_0008: Unknown result type (might be due to invalid IL or missing references)
		return tools.OrderByDescending(CalculateEffectiveDamage).FirstOrDefault();
		static float ApplyDamageModifier(float baseDamage, DamageModifier modifier)
		{
			//IL_0001: Unknown result type (might be due to invalid IL or missing references)
			//IL_0002: Unknown result type (might be due to invalid IL or missing references)
			//IL_0003: Unknown result type (might be due to invalid IL or missing references)
			//IL_0004: Unknown result type (might be due to invalid IL or missing references)
			//IL_0005: Unknown result type (might be due to invalid IL or missing references)
			//IL_0027: Expected I4, but got Unknown
			switch ((int)modifier)
			{
			case 0:
				return baseDamage;
			case 1:
				return baseDamage * 0.5f;
			case 2:
				return baseDamage * 1.5f;
			case 3:
			case 4:
				return 0f;
			case 5:
				return baseDamage * 0.25f;
			case 6:
				return baseDamage * 2f;
			default:
				return baseDamage;
			}
		}
		float CalculateEffectiveDamage(ItemData tool)
		{
			//IL_0007: Unknown result type (might be due to invalid IL or missing references)
			//IL_000c: Unknown result type (might be due to invalid IL or missing references)
			//IL_0019: Unknown result type (might be due to invalid IL or missing references)
			//IL_001f: Invalid comparison between Unknown and I4
			//IL_0031: Unknown result type (might be due to invalid IL or missing references)
			//IL_003d: Unknown result type (might be due to invalid IL or missing references)
			//IL_004a: Unknown result type (might be due to invalid IL or missing references)
			//IL_0056: Unknown result type (might be due to invalid IL or missing references)
			//IL_0063: Unknown result type (might be due to invalid IL or missing references)
			//IL_006f: Unknown result type (might be due to invalid IL or missing references)
			//IL_007c: Unknown result type (might be due to invalid IL or missing references)
			//IL_0088: Unknown result type (might be due to invalid IL or missing references)
			//IL_0095: Unknown result type (might be due to invalid IL or missing references)
			//IL_00a1: Unknown result type (might be due to invalid IL or missing references)
			//IL_00ae: Unknown result type (might be due to invalid IL or missing references)
			//IL_00ba: Unknown result type (might be due to invalid IL or missing references)
			//IL_00c7: Unknown result type (might be due to invalid IL or missing references)
			//IL_00d3: Unknown result type (might be due to invalid IL or missing references)
			//IL_00e0: Unknown result type (might be due to invalid IL or missing references)
			//IL_00ec: Unknown result type (might be due to invalid IL or missing references)
			//IL_00f9: Unknown result type (might be due to invalid IL or missing references)
			//IL_0105: Unknown result type (might be due to invalid IL or missing references)
			//IL_0112: Unknown result type (might be due to invalid IL or missing references)
			//IL_011e: Unknown result type (might be due to invalid IL or missing references)
			DamageTypes damages = tool.m_shared.m_damages;
			float num = 0f;
			if ((int)tool.m_shared.m_skillType == 8)
			{
				return 0f;
			}
			num += ApplyDamageModifier(damages.m_blunt, resourceDamageModifiers.m_blunt);
			num += ApplyDamageModifier(damages.m_slash, resourceDamageModifiers.m_slash);
			num += ApplyDamageModifier(damages.m_pierce, resourceDamageModifiers.m_pierce);
			num += ApplyDamageModifier(damages.m_chop, resourceDamageModifiers.m_chop);
			num += ApplyDamageModifier(damages.m_pickaxe, resourceDamageModifiers.m_pickaxe);
			num += ApplyDamageModifier(damages.m_fire, resourceDamageModifiers.m_fire);
			num += ApplyDamageModifier(damages.m_frost, resourceDamageModifiers.m_frost);
			num += ApplyDamageModifier(damages.m_lightning, resourceDamageModifiers.m_lightning);
			num += ApplyDamageModifier(damages.m_poison, resourceDamageModifiers.m_poison);
			return num + ApplyDamageModifier(damages.m_spirit, resourceDamageModifiers.m_spirit);
		}
	}

	private float GetDamageModifierValue(DamageModifier modifier)
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0002: Unknown result type (might be due to invalid IL or missing references)
		//IL_0003: Unknown result type (might be due to invalid IL or missing references)
		//IL_0004: Unknown result type (might be due to invalid IL or missing references)
		//IL_0005: Unknown result type (might be due to invalid IL or missing references)
		//IL_0027: Expected I4, but got Unknown
		return (int)modifier switch
		{
			0 => 1f, 
			1 => 0.5f, 
			2 => 1.5f, 
			3 => 0f, 
			4 => 1f, 
			5 => 0.25f, 
			6 => 2f, 
			_ => 1f, 
		};
	}

	private float CalculateWeaponEffectiveness(ItemData weapon, DamageModifiers resourceModifiers)
	{
		//IL_000d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0012: Unknown result type (might be due to invalid IL or missing references)
		//IL_0013: Unknown result type (might be due to invalid IL or missing references)
		//IL_003a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0025: Unknown result type (might be due to invalid IL or missing references)
		//IL_002c: Unknown result type (might be due to invalid IL or missing references)
		//IL_002d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0061: Unknown result type (might be due to invalid IL or missing references)
		//IL_004c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0053: Unknown result type (might be due to invalid IL or missing references)
		//IL_0054: Unknown result type (might be due to invalid IL or missing references)
		//IL_008a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0075: Unknown result type (might be due to invalid IL or missing references)
		//IL_007c: Unknown result type (might be due to invalid IL or missing references)
		//IL_007d: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b3: Unknown result type (might be due to invalid IL or missing references)
		//IL_009e: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a5: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a6: Unknown result type (might be due to invalid IL or missing references)
		//IL_00dc: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c7: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ce: Unknown result type (might be due to invalid IL or missing references)
		//IL_00cf: Unknown result type (might be due to invalid IL or missing references)
		//IL_0105: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f7: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f8: Unknown result type (might be due to invalid IL or missing references)
		//IL_012e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0119: Unknown result type (might be due to invalid IL or missing references)
		//IL_0120: Unknown result type (might be due to invalid IL or missing references)
		//IL_0121: Unknown result type (might be due to invalid IL or missing references)
		//IL_0157: Unknown result type (might be due to invalid IL or missing references)
		//IL_0142: Unknown result type (might be due to invalid IL or missing references)
		//IL_0149: Unknown result type (might be due to invalid IL or missing references)
		//IL_014a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0180: Unknown result type (might be due to invalid IL or missing references)
		//IL_016b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0172: Unknown result type (might be due to invalid IL or missing references)
		//IL_0173: Unknown result type (might be due to invalid IL or missing references)
		//IL_0194: Unknown result type (might be due to invalid IL or missing references)
		//IL_019b: Unknown result type (might be due to invalid IL or missing references)
		//IL_019c: Unknown result type (might be due to invalid IL or missing references)
		float num = 0f;
		DamageTypes damages = weapon.m_shared.m_damages;
		if (damages.m_blunt > 0f)
		{
			num += damages.m_blunt * GetDamageModifierValue(resourceModifiers.m_blunt);
		}
		if (damages.m_slash > 0f)
		{
			num += damages.m_slash * GetDamageModifierValue(resourceModifiers.m_slash);
		}
		if (damages.m_pierce > 0f)
		{
			num += damages.m_pierce * GetDamageModifierValue(resourceModifiers.m_pierce);
		}
		if (damages.m_chop > 0f)
		{
			num += damages.m_chop * GetDamageModifierValue(resourceModifiers.m_chop);
		}
		if (damages.m_pickaxe > 0f)
		{
			num += damages.m_pickaxe * GetDamageModifierValue(resourceModifiers.m_pickaxe);
		}
		if (damages.m_fire > 0f)
		{
			num += damages.m_fire * GetDamageModifierValue(resourceModifiers.m_fire);
		}
		if (damages.m_frost > 0f)
		{
			num += damages.m_frost * GetDamageModifierValue(resourceModifiers.m_frost);
		}
		if (damages.m_lightning > 0f)
		{
			num += damages.m_lightning * GetDamageModifierValue(resourceModifiers.m_lightning);
		}
		if (damages.m_poison > 0f)
		{
			num += damages.m_poison * GetDamageModifierValue(resourceModifiers.m_poison);
		}
		if (damages.m_spirit > 0f)
		{
			num += damages.m_spirit * GetDamageModifierValue(resourceModifiers.m_spirit);
		}
		return num;
	}

	private float CalculateEfficiency(string name, string category, int minAmount, int maxAmount, float health, float weaponEffectiveness, float distance)
	{
		float num = (float)(minAmount + maxAmount) / 2f;
		if (weaponEffectiveness <= 5f)
		{
			if (category == "ItemDrop" || category == "Pickable")
			{
				return num / (1f + distance / 50f);
			}
			return 0f;
		}
		float num2 = num / (health / weaponEffectiveness);
		if (category == "ItemDrop" || category == "Pickable")
		{
			num2 = 1f;
		}
		else
		{
			switch (category)
			{
			case "DropOnDestroyed":
				num2 *= num;
				break;
			default:
				if (!(category == "Destructible"))
				{
					if (category == "CharacterDrop")
					{
						num2 *= 0.5f;
					}
					break;
				}
				goto case "TreeLog";
			case "TreeLog":
			case "TreeBase":
			case "MineRock":
			case "MineRock5":
				if (weaponEffectiveness <= 5f)
				{
					return 0f;
				}
				num2 *= num;
				if (name.ToLower().Contains("log"))
				{
					num2 *= 1.1f;
				}
				if (name.ToLower().Contains("half"))
				{
					num2 *= 1.1f;
				}
				break;
			}
		}
		float num3 = 1f / (1f + distance / 10f);
		return num2 * num3;
	}

	private void EquipBestClothes(Humanoid humanoid)
	{
		//IL_002b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0041: Unknown result type (might be due to invalid IL or missing references)
		//IL_005a: Unknown result type (might be due to invalid IL or missing references)
		//IL_007c: Unknown result type (might be due to invalid IL or missing references)
		Dictionary<ItemType, ItemData> dictionary = new Dictionary<ItemType, ItemData>();
		foreach (ItemData allItem in humanoid.m_inventory.GetAllItems())
		{
			if (IsClothing(allItem.m_shared.m_itemType) && (!dictionary.ContainsKey(allItem.m_shared.m_itemType) || allItem.GetArmor() > dictionary[allItem.m_shared.m_itemType].GetArmor()))
			{
				dictionary[allItem.m_shared.m_itemType] = allItem;
			}
		}
		foreach (KeyValuePair<ItemType, ItemData> item in dictionary)
		{
			humanoid.EquipItem(item.Value, true);
		}
	}

	private bool IsClothing(ItemType itemType)
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0003: Invalid comparison between Unknown and I4
		//IL_0005: Unknown result type (might be due to invalid IL or missing references)
		//IL_0008: Invalid comparison between Unknown and I4
		//IL_000a: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Invalid comparison between Unknown and I4
		//IL_000e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0011: Invalid comparison between Unknown and I4
		return (int)itemType == 7 || (int)itemType == 11 || (int)itemType == 6 || (int)itemType == 17;
	}

	private static int CountItemsInInventory(Inventory inventory, string itemName)
	{
		if (inventory == null)
		{
			return 0;
		}
		return (from item in inventory.GetAllItems()
			where ((Object)item.m_dropPrefab).name.ToLower() == itemName.ToLower()
			select item).Sum((ItemData item) => item.m_stack);
	}

	private static void PrintInventoryItems(Inventory inventory)
	{
		LogMessage("Character Inventory Items:");
		List<ItemData> allItems = inventory.GetAllItems();
		foreach (ItemData item in allItems)
		{
			LogMessage($"- {item.m_shared.m_name} (Quantity: {item.m_stack} | {((Object)item.m_dropPrefab).name})");
		}
	}

	private static bool IsRangedWeapon(ItemData item)
	{
		//IL_0013: Unknown result type (might be due to invalid IL or missing references)
		//IL_0019: Invalid comparison between Unknown and I4
		//IL_0021: Unknown result type (might be due to invalid IL or missing references)
		//IL_0028: Invalid comparison between Unknown and I4
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_003b: Invalid comparison between Unknown and I4
		if (item == null)
		{
			return false;
		}
		return (int)item.m_shared.m_itemType == 4 || (int)item.m_shared.m_itemType == 15 || (int)item.m_shared.m_attack.m_attackType == 2;
	}

	private static bool IsMeleeWeapon(ItemData item)
	{
		//IL_0013: Unknown result type (might be due to invalid IL or missing references)
		//IL_0019: Invalid comparison between Unknown and I4
		//IL_0021: Unknown result type (might be due to invalid IL or missing references)
		//IL_0028: Invalid comparison between Unknown and I4
		//IL_0030: Unknown result type (might be due to invalid IL or missing references)
		//IL_0037: Invalid comparison between Unknown and I4
		if (item == null)
		{
			return false;
		}
		return (int)item.m_shared.m_itemType == 3 || (int)item.m_shared.m_itemType == 14 || (int)item.m_shared.m_itemType == 22;
	}

	private static int CheckArrows(Inventory inventory)
	{
		List<ItemData> list = (from item in inventory.GetAllItems()
			where (int)item.m_shared.m_itemType == 9
			select item).ToList();
		if (list.Any())
		{
			foreach (ItemData item in list)
			{
			}
			return list.Count;
		}
		return 0;
	}

	private void DropAllItems(HumanoidNPC humanoidNPC)
	{
		//IL_0067: Unknown result type (might be due to invalid IL or missing references)
		//IL_006c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0076: Unknown result type (might be due to invalid IL or missing references)
		//IL_007b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0080: Unknown result type (might be due to invalid IL or missing references)
		//IL_008a: Unknown result type (might be due to invalid IL or missing references)
		//IL_008f: Unknown result type (might be due to invalid IL or missing references)
		//IL_009a: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a4: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a9: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ae: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c6: Unknown result type (might be due to invalid IL or missing references)
		//IL_00cb: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d4: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d6: Unknown result type (might be due to invalid IL or missing references)
		List<ItemData> allItems = ((Humanoid)humanoidNPC).m_inventory.GetAllItems();
		int num = 1;
		LogInfo($"{((Character)humanoidNPC).m_name} dropping {((Humanoid)humanoidNPC).m_inventory.GetAllItems().Count} items: ");
		foreach (ItemData item in allItems)
		{
			LogInfo(item.m_shared.m_name);
			Vector3 val = ((Component)humanoidNPC).transform.position + Vector3.up * 2f + Random.insideUnitSphere * 0.3f + ((Component)humanoidNPC).transform.forward * 2.5f;
			Quaternion val2 = Quaternion.Euler(0f, (float)Random.Range(0, 360), 0f);
			ItemDrop.DropItem(item, item.m_stack, val, val2);
			num++;
		}
		((Humanoid)humanoidNPC).m_inventory.RemoveAll();
	}

	private void DropItem(string ItemName, HumanoidNPC humanoidNPC)
	{
		//IL_008b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0090: Unknown result type (might be due to invalid IL or missing references)
		//IL_009a: Unknown result type (might be due to invalid IL or missing references)
		//IL_009f: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a4: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ae: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b3: Unknown result type (might be due to invalid IL or missing references)
		//IL_00be: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c8: Unknown result type (might be due to invalid IL or missing references)
		//IL_00cd: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d2: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ea: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ef: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f8: Unknown result type (might be due to invalid IL or missing references)
		//IL_00fa: Unknown result type (might be due to invalid IL or missing references)
		List<ItemData> allItems = ((Humanoid)humanoidNPC).m_inventory.GetAllItems();
		int num = 1;
		foreach (ItemData item in allItems)
		{
			if (((Object)(object)item.m_dropPrefab != (Object)null && ItemName == ((Object)item.m_dropPrefab).name) || ItemName == item.m_shared.m_name)
			{
				LogInfo(((Character)humanoidNPC).m_name + " dropping item: " + item.m_shared.m_name);
				Vector3 val = ((Component)humanoidNPC).transform.position + Vector3.up * 2f + Random.insideUnitSphere * 0.3f + ((Component)humanoidNPC).transform.forward * 5.5f;
				Quaternion val2 = Quaternion.Euler(0f, (float)Random.Range(0, 360), 0f);
				ItemDrop.DropItem(item, item.m_stack, val, val2);
				num++;
				((Humanoid)humanoidNPC).m_inventory.RemoveItem(item, item.m_stack);
				return;
			}
		}
		LogInfo(((Character)humanoidNPC).m_name + " couldn't drop item: " + ItemName);
	}

	private void EquipItem(string ItemName, HumanoidNPC humanoidNPC)
	{
		List<ItemData> allItems = ((Humanoid)humanoidNPC).m_inventory.GetAllItems();
		foreach (ItemData item in allItems)
		{
			if (ItemName == item.m_shared.m_name)
			{
				LogInfo(((Character)humanoidNPC).m_name + " equipping  " + item.m_shared.m_name);
				((Humanoid)humanoidNPC).EquipItem(item, true);
				break;
			}
		}
	}

	public void AddChatTalk(Character character, string name, string text, bool addToChat = true)
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Expected O, but got Unknown
		//IL_0018: Unknown result type (might be due to invalid IL or missing references)
		//IL_001f: Expected O, but got Unknown
		//IL_003c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0041: Unknown result type (might be due to invalid IL or missing references)
		//IL_004b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_0055: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ba: Unknown result type (might be due to invalid IL or missing references)
		UserInfo val = new UserInfo();
		if (character is Player)
		{
			Player val2 = (Player)character;
			val.Name = val2.GetPlayerName();
		}
		else
		{
			val.Name = character.m_name;
		}
		Vector3 val3 = character.GetEyePoint() + Vector3.up * -100f;
		long num = ((character is Player) ? 99991 : 99992);
		WorldTextInstance val4 = Chat.instance.FindExistingWorldText(num);
		if (val4 != null && Object.op_Implicit((Object)(object)val4.m_gui))
		{
			Object.Destroy((Object)(object)val4.m_gui);
			Chat.instance.m_worldTexts.Remove(val4);
		}
		Chat.instance.AddInworldText(((Component)character).gameObject, num, val3, (Type)2, val, text + "\n\n\n\n\n");
		if (text != "..." && addToChat)
		{
			((Terminal)Chat.instance).AddString((character is Player) ? Player.m_localPlayer.GetPlayerName() : character.m_name, text, (Type)1, false);
			Chat.instance.m_hideTimer = 0f;
			((Component)((Terminal)Chat.instance).m_chatWindow).gameObject.SetActive(true);
		}
	}

	public static Vector3 GetRandomReachableLocationInRadius(Vector3 center, float radius)
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Unknown result type (might be due to invalid IL or missing references)
		//IL_000d: Unknown result type (might be due to invalid IL or missing references)
		//IL_000e: Unknown result type (might be due to invalid IL or missing references)
		//IL_000f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0014: Unknown result type (might be due to invalid IL or missing references)
		//IL_0036: Unknown result type (might be due to invalid IL or missing references)
		//IL_001d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0023: Unknown result type (might be due to invalid IL or missing references)
		//IL_0028: Unknown result type (might be due to invalid IL or missing references)
		//IL_0029: Unknown result type (might be due to invalid IL or missing references)
		//IL_002a: Unknown result type (might be due to invalid IL or missing references)
		//IL_002b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0030: Unknown result type (might be due to invalid IL or missing references)
		//IL_004b: Unknown result type (might be due to invalid IL or missing references)
		//IL_004c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		Vector3 val = Random.insideUnitSphere * radius;
		Vector3 val2 = center + val;
		int num = 10;
		int num2 = 0;
		while (!IsLocationReachable(val2) && num2 < num)
		{
			val = Random.insideUnitSphere * radius;
			val2 = center + val;
			num2++;
		}
		return val2;
	}

	private static bool IsLocationReachable(Vector3 location)
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0002: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0011: Unknown result type (might be due to invalid IL or missing references)
		//IL_001b: Unknown result type (might be due to invalid IL or missing references)
		//IL_005e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0063: Unknown result type (might be due to invalid IL or missing references)
		RaycastHit val = default(RaycastHit);
		if (Physics.SphereCast(location + Vector3.up * 500f, 0.5f, Vector3.down, ref val, 1000f, LayerMask.GetMask(new string[4] { "Default", "static_solid", "Default_small", "Terrain" })))
		{
			float num = Vector3.Distance(((RaycastHit)(ref val)).point, location);
			if (num <= 1f)
			{
				return true;
			}
		}
		return false;
	}

	private Vector3 GetRandomSpawnPosition(float radius)
	{
		//IL_000b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0010: Unknown result type (might be due to invalid IL or missing references)
		//IL_001a: Unknown result type (might be due to invalid IL or missing references)
		//IL_001f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0024: Unknown result type (might be due to invalid IL or missing references)
		//IL_002e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0033: Unknown result type (might be due to invalid IL or missing references)
		//IL_0038: Unknown result type (might be due to invalid IL or missing references)
		//IL_0039: Unknown result type (might be due to invalid IL or missing references)
		//IL_003a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0085: Unknown result type (might be due to invalid IL or missing references)
		//IL_0086: Unknown result type (might be due to invalid IL or missing references)
		//IL_007d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0082: Unknown result type (might be due to invalid IL or missing references)
		//IL_0089: Unknown result type (might be due to invalid IL or missing references)
		Vector3 val = ((Component)Player.m_localPlayer).transform.position + Vector3.up * 20f + Vector3.forward * 20f;
		RaycastHit val2 = default(RaycastHit);
		if (Physics.Raycast(val, Vector3.down, ref val2, 1000f, LayerMask.GetMask(new string[4] { "Default", "static_solid", "Default_small", "Terrain" })))
		{
			return ((RaycastHit)(ref val2)).point;
		}
		return val;
	}

	public static string GetPlayerSteamID()
	{
		//IL_0013: Unknown result type (might be due to invalid IL or missing references)
		//IL_0018: Unknown result type (might be due to invalid IL or missing references)
		//IL_0019: Unknown result type (might be due to invalid IL or missing references)
		List<PlayerInfo> playerList = ZNet.instance.GetPlayerList();
		int num = 0;
		if (num < playerList.Count)
		{
			PlayerInfo val = playerList[num];
			return val.m_host;
		}
		return "NullID";
	}

	public static void ToggleNPCCurrentCommandType()
	{
		NPCCurrentMode = (NPCMode)((int)(NPCCurrentMode + 1) % Enum.GetValues(typeof(NPCMode)).Length);
		if (NPCCurrentMode == NPCMode.Passive)
		{
			instance.commandManager.RemoveCommandsOfType<AttackAction>();
			enemyList.Clear();
		}
	}

	private static string GetBrainAPIAddress()
	{
		return Decrypt("Ju1M0vL+9PbHCPO8Tr0Leb92JpHZZcYqtuCSwhjbizen4omyPMmvjXjfSZ9MBoCv");
	}

	public static bool IsInAWorld()
	{
		return (Object)(object)ZNetScene.instance != (Object)null && (Object)(object)Player.m_localPlayer != (Object)null;
	}

	public static bool IsLocalSingleplayer()
	{
		if ((Object)(object)ZNet.instance == (Object)null)
		{
			Debug.LogWarning((object)"ZNet instance is null. Unable to determine world type.");
			return false;
		}
		if (ZNet.instance.IsDedicated())
		{
			return false;
		}
		if (ZNet.instance.IsServer())
		{
			return ZNet.instance.GetPeers().Count <= 1;
		}
		return false;
	}

	private static void SetPassiveMode(ThrallAI __instance)
	{
		((BaseAI)__instance).m_aggravatable = false;
		((BaseAI)__instance).m_alerted = false;
		((BaseAI)__instance).m_aggravated = false;
		__instance.m_targetCreature = null;
		((BaseAI)__instance).SetHuntPlayer(false);
		((BaseAI)__instance).m_viewRange = 0f;
	}

	private static void SetDefensiveMode(ThrallAI __instance)
	{
		if (enemyList.Count > 0)
		{
			((BaseAI)__instance).m_viewRange = 80f;
			Character val = ((IEnumerable<Character>)enemyList).FirstOrDefault((Func<Character, bool>)((Character go) => (Object)(object)go != (Object)null));
			if ((Object)(object)val != (Object)null)
			{
				__instance.SetTarget(val);
				__instance.m_updateTargetTimer = float.MaxValue;
				LogError("New enemy in defensive mode: " + ((Object)val).name);
				((BaseAI)__instance).m_aggravatable = true;
				((BaseAI)__instance).SetHuntPlayer(true);
			}
		}
	}

	private static void SetAggressiveMode(ThrallAI __instance)
	{
		((BaseAI)__instance).m_aggravatable = true;
		((BaseAI)__instance).m_alerted = true;
		((BaseAI)__instance).m_aggravated = true;
		((BaseAI)__instance).SetHuntPlayer(true);
		((BaseAI)__instance).m_viewRange = 80f;
	}

	private static void SetMonsterAIAggravated(ThrallAI thrallAIcomp, bool Aggravated)
	{
		if (Aggravated)
		{
			((BaseAI)thrallAIcomp).m_aggravatable = true;
			return;
		}
		((BaseAI)thrallAIcomp).m_aggravated = false;
		((BaseAI)thrallAIcomp).m_aggravatable = false;
		((BaseAI)thrallAIcomp).m_alerted = false;
		thrallAIcomp.m_eventCreature = false;
		thrallAIcomp.m_targetCreature = null;
		thrallAIcomp.m_targetStatic = null;
		((BaseAI)thrallAIcomp).SetHuntPlayer(false);
	}

	private static Player GetLocalPlayerOrNull()
	{
		return Object.op_Implicit((Object)(object)Player.m_localPlayer) ? Player.m_localPlayer : null;
	}

	private static void AutoPickupItems()
	{
	}

	private static bool HandleEnemies(ThrallAI __instance)
	{
		((BaseAI)__instance).m_viewRange = 80f;
		if ((Object)(object)__instance.m_targetCreature == (Object)null || !enemyList.Contains(__instance.m_targetCreature))
		{
			if ((Object)(object)__instance.m_targetCreature == (Object)null)
			{
				LogError("__instance.m_targetCreature == null");
			}
			else if (!enemyList.Contains(__instance.m_targetCreature))
			{
				LogError($"{enemyList.Count} !enemyList.Contains(__instance.m_targetCreature.gameObject)");
			}
			_ = from go in enemyList
				where (Object)(object)go != (Object)null
				orderby VectorExtensions.DistanceTo(((Component)go).transform.position, ((Component)__instance).transform.position)
				select go;
			Character[] array = enemyList.ToArray();
			foreach (Character val in array)
			{
				if (Object.op_Implicit((Object)(object)val))
				{
					Character val2 = val;
					if ((Object)(object)val2 != (Object)null)
					{
						__instance.m_targetCreature = null;
						__instance.SetTarget(val2);
						__instance.m_updateTargetTimer = 1000000f;
						LogError("New enemy in defensive mode: " + ((Object)val2).name);
						((BaseAI)__instance).m_alerted = true;
						((BaseAI)__instance).m_aggravatable = true;
						((BaseAI)__instance).SetHuntPlayer(true);
						return true;
					}
					LogError("Defensive mode enemy from enemyList wasn't a character");
				}
			}
			if (!Object.op_Implicit((Object)(object)__instance.m_targetCreature) && enemyList.Count > 0)
			{
				enemyList.Clear();
				LogError("enemy list cleared");
			}
		}
		return false;
	}

	private static void PreProcessCommand()
	{
		NPCCommand nextCommand = instance.commandManager.GetNextCommand();
		if (NPCCurrentCommand == null || (nextCommand != null && NPCCurrentCommand != nextCommand))
		{
			NPCCurrentCommand = nextCommand;
			if (nextCommand is HarvestAction)
			{
				HarvestAction harvestAction = (HarvestAction)nextCommand;
				instance.Harvesting_Start(harvestAction.ResourceName, "");
			}
			if (nextCommand is PatrolAction)
			{
				PatrolAction patrolAction = (PatrolAction)nextCommand;
				instance.Patrol_Start("");
			}
			if (nextCommand is AttackAction)
			{
				AttackAction attackAction = (AttackAction)nextCommand;
				instance.Combat_StartAttacking(attackAction.TargetName, "");
			}
			if (nextCommand is FollowAction)
			{
				FollowAction followAction = (FollowAction)nextCommand;
				instance.Follow_Start(((Component)Player.m_localPlayer).gameObject, "");
			}
		}
		if (nextCommand == null && instance.commandManager.GetCommandsCount() == 0)
		{
			FollowAction command = new FollowAction();
			instance.commandManager.AddCommand(command);
		}
	}

	private static bool ProcessPatrolCommand(ThrallAI __instance, HumanoidNPC humanoidNPC)
	{
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Unknown result type (might be due to invalid IL or missing references)
		//IL_007f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0084: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ba: Unknown result type (might be due to invalid IL or missing references)
		//IL_02e5: Unknown result type (might be due to invalid IL or missing references)
		//IL_0145: Unknown result type (might be due to invalid IL or missing references)
		//IL_014a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0198: Unknown result type (might be due to invalid IL or missing references)
		//IL_0241: Unknown result type (might be due to invalid IL or missing references)
		//IL_0246: Unknown result type (might be due to invalid IL or missing references)
		//IL_0277: Unknown result type (might be due to invalid IL or missing references)
		//IL_0282: Unknown result type (might be due to invalid IL or missing references)
		float num = VectorExtensions.DistanceTo(((Component)__instance).transform.position, patrol_position);
		if (num > chaseUntilPatrolRadiusDistance && !MovementLock)
		{
			SetMonsterAIAggravated(__instance, Aggravated: false);
			MovementLock = true;
			LogInfo($"{((Character)humanoidNPC).m_name} went too far ({chaseUntilPatrolRadiusDistance}m away) from patrol position, heading back now!");
		}
		else if (num < instance.patrol_radius - 3f)
		{
			MovementLock = false;
			__instance.m_lastKnownTargetPos = patrol_position;
		}
		else if (num < instance.patrol_radius)
		{
			((BaseAI)__instance).m_aggravatable = true;
		}
		if (MovementLock)
		{
			((BaseAI)__instance).MoveTo(Time.deltaTime, patrol_position, 0f, false);
			return false;
		}
		GameObject follow = __instance.m_follow;
		if ((Object)(object)follow != (Object)null && (ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "Character" }) || ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "Humanoid" })))
		{
			return true;
		}
		if (instance.patrol_harvest)
		{
			if ((Object)(object)follow == (Object)null || VectorExtensions.DistanceTo(follow.transform.position, patrol_position) > chaseUntilPatrolRadiusDistance || (!ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "Pickable" }) && !ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "ItemDrop" })))
			{
				List<Pickable> list = SphereSearchForGameObjectsWithComponent<Pickable>(patrol_position, chaseUntilPatrolRadiusDistance - 2f);
				if (list.Count == 0)
				{
					LogMessage(((Character)humanoidNPC).m_name + " has picked up all dropped items around the patrolling area. Only keeping guard now!");
					instance.patrol_harvest = false;
					return true;
				}
				foreach (Pickable item in list)
				{
					if ((Object)(object)item == (Object)null)
					{
						LogMessage(((Character)humanoidNPC).m_name + " has picked up all dropped items around the patrolling area. Only keeping guard now!");
						instance.patrol_harvest = false;
						return true;
					}
					if (VectorExtensions.DistanceTo(((Component)item).transform.position, patrol_position) < chaseUntilPatrolRadiusDistance)
					{
						LogMessage($"{((Character)humanoidNPC).m_name} is going to pickup {((Object)item).name} in patrol area, distance: {VectorExtensions.DistanceTo(((Component)item).transform.position, ((Component)__instance).transform.position)}");
						__instance.SetFollowTarget(((Component)item).gameObject);
						return true;
					}
					LogInfo("Closest pickable's distance is too far!");
				}
			}
			return true;
		}
		((BaseAI)__instance).RandomMovementArroundPoint(Time.deltaTime, patrol_position, 7f, false);
		return false;
	}

	private static void ProcessHarvestCommand(ThrallAI __instance, HumanoidNPC humanoidNPC)
	{
		if ((!((Object)(object)__instance.m_follow == (Object)null) || !((Object)(object)__instance.m_targetCreature == (Object)null)) && (!Object.op_Implicit((Object)(object)__instance.m_follow) || ResourceNodesOneArray.Contains(CleanKey(((Object)__instance.m_follow).name))) && !((Object)(object)__instance.m_follow == (Object)(object)Player.m_localPlayer))
		{
			return;
		}
		ItemData currentWeapon = ((Humanoid)humanoidNPC).GetCurrentWeapon();
		List<(string, string, float, float, int)> source = instance.FindResourceSourcesRecursive(CurrentHarvestResourceName, currentWeapon);
		source = source.OrderByDescending<(string, string, float, float, int), float>(((string Category, string Name, float Efficiency, float Distance, int Depth) s) => s.Efficiency).ToList();
		bool flag = false;
		foreach (var item in source)
		{
			if (flag)
			{
				continue;
			}
			GameObject val = FindClosestResource(PlayerNPC, item.Item2, UnderwaterAllowed: false);
			if (!((Object)(object)val != (Object)null))
			{
				continue;
			}
			if (item.Item1 == "CharacterDrop")
			{
				Character characterFromGameObject = GetCharacterFromGameObject(val);
				if ((Object)(object)characterFromGameObject != (Object)null)
				{
					__instance.m_targetCreature = null;
					__instance.SetTarget(characterFromGameObject);
					__instance.m_updateTargetTimer = 1000000f;
					LogMessage(((Character)humanoidNPC).m_name + " is going to harvest " + ((Object)val).name + " by killing " + ((Object)characterFromGameObject).name);
					flag = true;
				}
				else
				{
					LogError("Harvesting failed! Closest resource was a CharacterDrop but has no Character component");
				}
			}
			else
			{
				__instance.SetFollowTarget(val);
				LogMessage(((Character)humanoidNPC).m_name + " is going to harvest " + ((Object)val).name);
				flag = true;
			}
		}
		if (!flag)
		{
			LogMessage("Couldnt find any resources to harvest for " + CurrentHarvestResourceName);
			LogInfo("Removing harvest " + CurrentHarvestResourceName + " command");
			CurrentHarvestResourceName = "Wood";
			instance.commandManager.RemoveCommand(0);
		}
	}

	private static void ProcessCombatCommand(ThrallAI __instance)
	{
		if ((Object)(object)__instance.m_targetCreature == (Object)null || (!IsStringStartingWith(CurrentEnemyName, ((Object)__instance.m_targetCreature).name, bCleanKey: true) && !enemyList.Contains(__instance.m_targetCreature)))
		{
			Character val = FindClosestEnemy(((Component)__instance).gameObject, CurrentEnemyName);
			if (Object.op_Implicit((Object)(object)val))
			{
				__instance.m_targetCreature = null;
				__instance.SetTarget(val);
				__instance.m_updateTargetTimer = 1000000f;
				LogMessage("CombatAttack new target set: " + CleanKey(((Object)val).name));
			}
			else
			{
				instance.commandManager.RemoveCommand(0);
				LogError("CommandType.CombatAttack, findclosestenemy returned null. Probably no more targets in the area. Removing combat command");
			}
		}
	}

	private static void ProcessFollowCommand(ThrallAI __instance)
	{
		if (Object.op_Implicit((Object)(object)__instance.m_follow) && (Object)(object)__instance.m_follow != (Object)(object)((Component)Player.m_localPlayer).gameObject && !ExposedGameObjectExtension.HasAnyComponent(__instance.m_follow, new string[2] { "ItemDrop", "Pickable" }) && enemyList.Count == 0)
		{
			__instance.SetFollowTarget(((Component)Player.m_localPlayer).gameObject);
			LogMessage("Following player again ");
		}
		else if (!Object.op_Implicit((Object)(object)__instance.m_follow))
		{
			__instance.SetFollowTarget(((Component)Player.m_localPlayer).gameObject);
			LogMessage("Following player again ");
		}
	}

	private static void NPCCurrentModeUpdate(ThrallAI __instance)
	{
		if (NPCCurrentMode == NPCMode.Passive)
		{
			((BaseAI)__instance).m_aggravatable = false;
			((BaseAI)__instance).m_alerted = false;
			((BaseAI)__instance).m_aggravated = false;
			__instance.m_targetCreature = null;
			((BaseAI)__instance).SetHuntPlayer(false);
			((BaseAI)__instance).m_viewRange = 0f;
		}
		else if (NPCCurrentMode == NPCMode.Defensive)
		{
			if (NPCCurrentCommandType == NPCCommand.CommandType.CombatAttack)
			{
				((BaseAI)__instance).m_alerted = false;
				((BaseAI)__instance).m_aggravatable = true;
				((BaseAI)__instance).SetHuntPlayer(true);
				((BaseAI)__instance).m_viewRange = 80f;
			}
		}
		else if (NPCCurrentMode == NPCMode.Aggressive)
		{
			SetMonsterAIAggravated(__instance, Aggravated: true);
			((BaseAI)__instance).m_aggravated = true;
			((BaseAI)__instance).SetAlerted(true);
			((BaseAI)__instance).SetHuntPlayer(true);
			((BaseAI)__instance).m_viewRange = 80f;
		}
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(ThrallAI), "UpdateAI")]
	private static bool MonsterAI_UpdateAI_Prefix(ThrallAI __instance)
	{
		//IL_008f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0094: Unknown result type (might be due to invalid IL or missing references)
		if (!Object.op_Implicit((Object)(object)Player.m_localPlayer) || !Object.op_Implicit((Object)(object)__instance))
		{
			return true;
		}
		if (!((Object)__instance).name.Contains("HumanoidNPC"))
		{
			return true;
		}
		HumanoidNPC component = ((Component)__instance).gameObject.GetComponent<HumanoidNPC>();
		if (NPCCurrentMode != 0 && enemyList.Count > 0 && HandleEnemies(__instance))
		{
			return true;
		}
		PreProcessCommand();
		if (NPCCurrentCommandType == NPCCommand.CommandType.PatrolArea && patrol_position != Vector3.zero)
		{
			return ProcessPatrolCommand(__instance, component);
		}
		if (NPCCurrentCommandType == NPCCommand.CommandType.HarvestResource && enemyList.Count == 0)
		{
			ProcessHarvestCommand(__instance, component);
		}
		if (NPCCurrentCommandType == NPCCommand.CommandType.CombatAttack)
		{
			ProcessCombatCommand(__instance);
		}
		if (NPCCurrentCommandType == NPCCommand.CommandType.FollowPlayer)
		{
			ProcessFollowCommand(__instance);
		}
		NPCCurrentModeUpdate(__instance);
		return true;
	}

	[HarmonyPostfix]
	[HarmonyPatch(typeof(HumanoidNPC), "CustomFixedUpdate")]
	private static void HumanoidNPC_CustomFixedUpdate_Postfix(HumanoidNPC __instance)
	{
		//IL_0057: Unknown result type (might be due to invalid IL or missing references)
		//IL_0062: Unknown result type (might be due to invalid IL or missing references)
		//IL_009f: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a4: Unknown result type (might be due to invalid IL or missing references)
		//IL_0169: Unknown result type (might be due to invalid IL or missing references)
		//IL_0174: Unknown result type (might be due to invalid IL or missing references)
		//IL_059e: Unknown result type (might be due to invalid IL or missing references)
		//IL_05a3: Unknown result type (might be due to invalid IL or missing references)
		//IL_05cd: Unknown result type (might be due to invalid IL or missing references)
		//IL_05d8: Unknown result type (might be due to invalid IL or missing references)
		//IL_05dd: Unknown result type (might be due to invalid IL or missing references)
		//IL_03e7: Unknown result type (might be due to invalid IL or missing references)
		//IL_0416: Unknown result type (might be due to invalid IL or missing references)
		//IL_0369: Unknown result type (might be due to invalid IL or missing references)
		//IL_0605: Unknown result type (might be due to invalid IL or missing references)
		//IL_0501: Unknown result type (might be due to invalid IL or missing references)
		//IL_0511: Unknown result type (might be due to invalid IL or missing references)
		//IL_0564: Unknown result type (might be due to invalid IL or missing references)
		ThrallAI component = ((Component)__instance).GetComponent<ThrallAI>();
		if (!Object.op_Implicit((Object)(object)component))
		{
			return;
		}
		if (NPCCurrentCommandType == NPCCommand.CommandType.FollowPlayer && ((Object)(object)Player.m_localPlayer == (Object)null || (Object)(object)component.m_follow == (Object)null))
		{
			component.SetFollowTarget((GameObject)null);
			return;
		}
		if (VectorExtensions.DistanceTo(__instance.LastPosition, ((Component)__instance).transform.position) > 1.5f || ((Character)__instance).m_lastHit != NPCLastHitData)
		{
			NPCLastHitData = ((Character)__instance).m_lastHit;
			__instance.LastPosition = ((Component)__instance).transform.position;
			__instance.LastMovedAtTime = Time.time;
		}
		GameObject follow = component.m_follow;
		Character val = null;
		if (Object.op_Implicit((Object)(object)follow))
		{
			val = follow.gameObject.GetComponent<Character>();
		}
		if ((Object.op_Implicit((Object)(object)component.m_targetCreature) && IsRangedWeapon(((Humanoid)__instance).GetCurrentWeapon()) && CheckArrows(((Humanoid)__instance).m_inventory) > 0) || !((Object)(object)follow != (Object)null) || !((Object)(object)follow != (Object)(object)((Component)Player.m_localPlayer).gameObject))
		{
			return;
		}
		if (useWeapon != null && !((Humanoid)__instance).IsItemEquiped(useWeapon))
		{
			((Humanoid)__instance).EquipItem(useWeapon, true);
		}
		float num = VectorExtensions.DistanceTo(follow.transform.position, ((Component)__instance).transform.position);
		if ((NPCCurrentCommandType == NPCCommand.CommandType.HarvestResource && ExposedGameObjectExtension.HasAnyComponent(follow, new string[5] { "Destructible", "TreeBase", "TreeLog", "MineRock", "MineRock5" }) && Time.time - NewFollowTargetLastRefresh > MaxChaseTimeForOneFollowTarget && NewFollowTargetLastRefresh != 0f) || (Time.time - __instance.LastMovedAtTime > MaxChaseTimeForOneFollowTarget && num < 8f))
		{
			LogMessage("NPC seems to be stuck for >20s while trying to harvest " + ((Object)follow.gameObject).name + ", evading task!");
			blacklistedItems.Add(follow.gameObject);
			__instance.LastMovedAtTime = Time.time;
			RefreshAllGameObjectInstances();
			component.SetFollowTarget((GameObject)null);
		}
		else
		{
			if (((Character)__instance).InAttack())
			{
				return;
			}
			float num2 = 0.8f;
			if (ExposedGameObjectExtension.HasAnyComponent(follow, new string[2] { "ItemDrop", "Pickable" }))
			{
				num2 = 2f;
			}
			else if (ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "TreeLog" }))
			{
				num2 = 1f;
			}
			else if (ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "TreeBase" }))
			{
				num2 = 1.25f;
			}
			if (num < FollowUntilDistance + num2 + 6f && NewFollowTargetLastRefresh == 0f)
			{
				NewFollowTargetLastRefresh = Time.time;
			}
			if (num < FollowUntilDistance + num2)
			{
				if (ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "ItemDrop" }))
				{
					instance.PickupItemDrop(__instance, component);
					if (!Object.op_Implicit((Object)(object)follow))
					{
						ItemDrop val2 = SphereSearchForGameObjectWithComponent<ItemDrop>(((Component)component).transform.position, 8f);
						if ((Object)(object)val2 != (Object)null)
						{
							LogInfo("Found another nearby item drop " + ((Object)val2).name);
							component.SetFollowTarget(((Component)val2).gameObject);
						}
						else
						{
							component.SetFollowTarget((GameObject)null);
						}
					}
				}
				else if (ExposedGameObjectExtension.HasAnyComponent(follow, new string[1] { "Pickable" }))
				{
					__instance.O_DoInteractAnimation(follow.transform.position);
					Pickable component2 = follow.GetComponent<Pickable>();
					component2.Interact((Humanoid)(object)Player.m_localPlayer, false, false);
					Object.Destroy((Object)(object)follow);
					ItemDrop val3 = SphereSearchForGameObjectWithComponent<ItemDrop>(((Component)component).transform.position, 8f);
					if ((Object)(object)val3 != (Object)null)
					{
						component.SetFollowTarget(((Component)val3).gameObject);
						LogInfo("Found nearby item drop " + ((Object)val3).name + " after interacting with pickable");
					}
					else
					{
						component.SetFollowTarget((GameObject)null);
						LogInfo("follow target set to null after interacting with pickable");
					}
				}
				else if ((Object)(object)follow != (Object)(object)((Component)Player.m_localPlayer).gameObject && !HasAnyChildComponent(follow, new List<Type> { typeof(Character) }))
				{
					bool flag = false;
					string text = ((Object)follow).name.ToLower();
					if ((text.Contains("log") && text.Contains("half")) || (text.Contains("log") && ((Component)__instance).transform.position.z - follow.transform.position.z > -5f))
					{
						flag = true;
					}
					else if (((Object)follow).name.ToLower().Contains("log"))
					{
						flag = Random.value > 0.25f;
					}
					((BaseAI)component).LookAt(follow.transform.position);
					((Character)__instance).StartAttack((Character)(Object.op_Implicit((Object)(object)val) ? ((object)val) : ((object)__instance)), flag);
					LogError("Attacking resource " + text);
				}
			}
			else
			{
				Vector3 velocity = ((Character)__instance).GetVelocity();
				if (((Vector3)(ref velocity)).magnitude < 0.2f && Time.time - __instance.LastMovedAtTime > 3f && !((BaseAI)component).CanMove(((Component)__instance).transform.position - follow.transform.position, 1f, 1f))
				{
					((BaseAI)component).LookAt(follow.transform.position);
					((Character)__instance).StartAttack((Character)(Object.op_Implicit((Object)(object)val) ? ((object)val) : ((object)__instance)), Random.value > 0.5f);
				}
			}
		}
	}

	[HarmonyPostfix]
	[HarmonyPatch(typeof(ThrallAI), "SetFollowTarget")]
	private static void MonsterAI_SetFollowTarget_Postfix(ThrallAI __instance)
	{
		//IL_0045: Unknown result type (might be due to invalid IL or missing references)
		//IL_007f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0084: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b4: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b9: Unknown result type (might be due to invalid IL or missing references)
		//IL_01f7: Unknown result type (might be due to invalid IL or missing references)
		//IL_0158: Unknown result type (might be due to invalid IL or missing references)
		//IL_015d: Unknown result type (might be due to invalid IL or missing references)
		//IL_00fe: Unknown result type (might be due to invalid IL or missing references)
		//IL_0103: Unknown result type (might be due to invalid IL or missing references)
		//IL_018a: Unknown result type (might be due to invalid IL or missing references)
		//IL_018f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0122: Unknown result type (might be due to invalid IL or missing references)
		//IL_0127: Unknown result type (might be due to invalid IL or missing references)
		//IL_01cf: Unknown result type (might be due to invalid IL or missing references)
		//IL_01bc: Unknown result type (might be due to invalid IL or missing references)
		//IL_01c1: Unknown result type (might be due to invalid IL or missing references)
		if (!IsStringEqual(((Object)__instance).name, NPCPrefabName))
		{
			return;
		}
		NewFollowTargetLastRefresh = 0f;
		useWeapon = null;
		if ((Object)(object)__instance.m_follow == (Object)null)
		{
			targetDamageModifiers = default(DamageModifiers);
			return;
		}
		GameObject gameObject = __instance.m_follow.gameObject;
		if (ExposedGameObjectExtension.HasAnyComponent(gameObject, new string[1] { "TreeLog" }))
		{
			TreeLog component = gameObject.GetComponent<TreeLog>();
			targetDamageModifiers = component.m_damages;
		}
		else if (ExposedGameObjectExtension.HasAnyComponent(gameObject, new string[1] { "TreeBase" }))
		{
			TreeBase component2 = gameObject.GetComponent<TreeBase>();
			targetDamageModifiers = component2.m_damageModifiers;
		}
		else if (ExposedGameObjectExtension.HasAnyComponent(gameObject, new string[2] { "Character", "Humanoid" }))
		{
			Character component3 = gameObject.GetComponent<Character>();
			if (Object.op_Implicit((Object)(object)component3))
			{
				targetDamageModifiers = component3.m_damageModifiers;
			}
			else
			{
				Humanoid component4 = gameObject.GetComponent<Humanoid>();
				if (Object.op_Implicit((Object)(object)component4))
				{
					targetDamageModifiers = ((Character)component4).m_damageModifiers;
				}
			}
		}
		else if (ExposedGameObjectExtension.HasAnyComponent(gameObject, new string[1] { "MineRock" }))
		{
			MineRock component5 = gameObject.GetComponent<MineRock>();
			targetDamageModifiers = component5.m_damageModifiers;
		}
		else if (ExposedGameObjectExtension.HasAnyComponent(gameObject, new string[1] { "MineRock5" }))
		{
			MineRock5 component6 = gameObject.GetComponent<MineRock5>();
			targetDamageModifiers = component6.m_damageModifiers;
		}
		else
		{
			if (!ExposedGameObjectExtension.HasAnyComponent(gameObject, new string[1] { "Destructible" }))
			{
				targetDamageModifiers = default(DamageModifiers);
				return;
			}
			Destructible component7 = gameObject.GetComponent<Destructible>();
			targetDamageModifiers = component7.m_damages;
		}
		if (Object.op_Implicit((Object)(object)humanoid_PlayerNPC))
		{
			ItemData bestHarvestingTool = GetBestHarvestingTool(((Humanoid)humanoid_PlayerNPC).m_inventory.m_inventory, targetDamageModifiers);
			if (bestHarvestingTool != null)
			{
				LogInfo("Equipping best weapon: " + bestHarvestingTool.m_shared.m_name + " for " + CleanKey(((Object)gameObject).name));
				useWeapon = bestHarvestingTool;
				((Humanoid)humanoid_PlayerNPC).EquipItem(bestHarvestingTool, true);
			}
		}
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Humanoid), "StartAttack")]
	private static bool Humanoid_StartAttack_Prefix(Humanoid __instance, Character target, bool secondaryAttack, bool __result)
	{
		//IL_0021: Unknown result type (might be due to invalid IL or missing references)
		//IL_0026: Unknown result type (might be due to invalid IL or missing references)
		if (!IsStringEqual(NPCPrefabName, ((Object)__instance).name))
		{
			return true;
		}
		ZDOID zDOID = target.GetZDOID();
		lastAttackedObjectZDOID = ((object)(ZDOID)(ref zDOID)).ToString();
		if ((((Character)__instance).InAttack() && !__instance.HaveQueuedChain()) || ((Character)__instance).InDodge() || !((Character)__instance).CanMove() || ((Character)__instance).IsKnockedBack() || ((Character)__instance).IsStaggering() || ((Character)__instance).InMinorAction())
		{
			__result = false;
			return false;
		}
		ItemData currentWeapon = __instance.GetCurrentWeapon();
		if (currentWeapon == null)
		{
			__result = false;
			return false;
		}
		if (secondaryAttack && !currentWeapon.HaveSecondaryAttack())
		{
			__result = false;
			return false;
		}
		if (!secondaryAttack && !currentWeapon.HavePrimaryAttack())
		{
			__result = false;
			return false;
		}
		if (__instance.m_currentAttack != null)
		{
			__instance.m_currentAttack.Stop();
			__instance.m_previousAttack = __instance.m_currentAttack;
			__instance.m_currentAttack = null;
		}
		Attack val = (secondaryAttack ? (val = currentWeapon.m_shared.m_secondaryAttack.Clone()) : (val = currentWeapon.m_shared.m_attack.Clone()));
		if (val.Start(__instance, ((Character)__instance).m_body, ((Character)__instance).m_zanim, ((Character)__instance).m_animEvent, __instance.m_visEquipment, currentWeapon, __instance.m_previousAttack, __instance.m_timeSinceLastAttack, 1f))
		{
			__instance.ClearActionQueue();
			__instance.StartAttackGroundCheck();
			__instance.m_currentAttack = val;
			__instance.m_currentAttackIsSecondary = secondaryAttack;
			__instance.m_lastCombatTimer = 0f;
			__result = true;
		}
		__result = false;
		return false;
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(BaseAI), "Follow")]
	private static bool BaseAI_Follow_Prefix(BaseAI __instance, GameObject go, float dt)
	{
		//IL_0077: Unknown result type (might be due to invalid IL or missing references)
		//IL_0082: Unknown result type (might be due to invalid IL or missing references)
		//IL_0107: Unknown result type (might be due to invalid IL or missing references)
		if (!Object.op_Implicit((Object)(object)Player.m_localPlayer))
		{
			return true;
		}
		if (!((Object)__instance).name.Contains(NPCPrefabName))
		{
			return true;
		}
		float num;
		float num2;
		if ((Object)(object)go == (Object)(object)((Component)Player.m_localPlayer).gameObject)
		{
			num = 10f;
			num2 = 7f;
		}
		else
		{
			num = RunUntilDistance;
			num2 = FollowUntilDistance;
		}
		float num3 = Vector3.Distance(go.transform.position, ((Component)__instance).transform.position);
		bool flag = num3 > num;
		if (NPCCurrentCommandType == NPCCommand.CommandType.FollowPlayer)
		{
			flag = flag && !((Character)Player.m_localPlayer).IsCrouching() && !((Character)Player.m_localPlayer).m_walk;
		}
		if (NPCCurrentCommandType == NPCCommand.CommandType.CombatSneakAttack)
		{
			flag = false;
		}
		if (num3 < num2 - (((Character)Player.m_localPlayer).IsCrouching() ? 5f : 2f))
		{
			__instance.StopMoving();
		}
		else
		{
			__instance.MoveTo(dt, go.transform.position, 0f, flag);
		}
		return false;
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Character), "GetHoverText")]
	private static bool Character_GetHoverText_Prefix(Character __instance, ref string __result)
	{
		//IL_003a: Unknown result type (might be due to invalid IL or missing references)
		//IL_003f: Unknown result type (might be due to invalid IL or missing references)
		//IL_006a: Unknown result type (might be due to invalid IL or missing references)
		//IL_006f: Unknown result type (might be due to invalid IL or missing references)
		//IL_009a: Unknown result type (might be due to invalid IL or missing references)
		//IL_009f: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ca: Unknown result type (might be due to invalid IL or missing references)
		//IL_00cf: Unknown result type (might be due to invalid IL or missing references)
		if (((Object)__instance).name.Contains("HumanoidNPC"))
		{
			HumanoidNPC component = ((Component)__instance).GetComponent<HumanoidNPC>();
			__result = __instance.m_name;
			string obj = __result;
			KeyCode value = instance.inventoryKey.Value;
			__result = obj + "\n<color=yellow><b>[" + ((object)(KeyCode)(ref value)).ToString() + "]</b></color> Inventory";
			string obj2 = __result;
			value = instance.talkKey.Value;
			__result = obj2 + "\n<color=yellow><b>[" + ((object)(KeyCode)(ref value)).ToString() + "]</b></color> Push to Talk";
			string obj3 = __result;
			value = instance.thrallMenuKey.Value;
			__result = obj3 + "\n<color=yellow><b>[" + ((object)(KeyCode)(ref value)).ToString() + "]</b></color> Menu";
			string obj4 = __result;
			value = instance.combatModeKey.Value;
			__result = obj4 + $"\n<color=yellow><b>[{((object)(KeyCode)(ref value)).ToString()}]</b></color> Combat Mode: <color=yellow>{NPCCurrentMode}</color>";
			return false;
		}
		return true;
	}

	private void PickupItemDrop(HumanoidNPC __instance, ThrallAI thrallAIcomp)
	{
		//IL_000d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0376: Unknown result type (might be due to invalid IL or missing references)
		//IL_037b: Unknown result type (might be due to invalid IL or missing references)
		__instance.O_DoInteractAnimation(thrallAIcomp.m_follow.transform.position);
		ItemDrop component = thrallAIcomp.m_follow.GetComponent<ItemDrop>();
		FloatingTerrainDummy val = null;
		if ((Object)(object)component == (Object)null || ((Humanoid)__instance).HaveUniqueKey(component.m_itemData.m_shared.m_name) || !((Component)component).GetComponent<ZNetView>().IsValid())
		{
			return;
		}
		if (!component.CanPickup(true))
		{
			component.RequestOwn();
		}
		else
		{
			if (component.InTar())
			{
				return;
			}
			component.Load();
			string name = ((Object)component).name;
			LogMessage(((Character)__instance).m_name + " is picking up " + ((Object)component).name);
			if ((Object)(object)component == (Object)null || component.m_itemData.m_shared.m_icons == null || component.m_itemData.m_shared.m_icons.Length == 0 || component.m_itemData.m_variant >= component.m_itemData.m_shared.m_icons.Length || !component.CanPickup(true) || ((Humanoid)__instance).m_inventory.ContainsItem(component.m_itemData))
			{
				return;
			}
			if (component.m_itemData.m_shared.m_questItem && ((Humanoid)__instance).HaveUniqueKey(component.m_itemData.m_shared.m_name))
			{
				LogInfo("Thrall cannot pickup item " + component.GetHoverName() + " " + ((Object)component).name);
				return;
			}
			int stack = component.m_itemData.m_stack;
			bool flag = ((Humanoid)__instance).m_inventory.AddItem(component.m_itemData);
			if (((Character)__instance).m_nview.GetZDO() == null)
			{
				Object.Destroy((Object)(object)((Component)component).gameObject);
				return;
			}
			if (!flag)
			{
				LogInfo("Thrall can't pickup item " + component.GetHoverName() + " " + ((Object)component).name + " because no room");
				return;
			}
			if (NPCCurrentCommandType == NPCCommand.CommandType.HarvestResource && IsStringEqual(CurrentHarvestResourceName, name))
			{
				if (NPCCurrentCommand != null && NPCCurrentCommand is HarvestAction)
				{
					HarvestAction harvestAction = (HarvestAction)NPCCurrentCommand;
					harvestAction.RequiredAmount = Math.Max(harvestAction.RequiredAmount - stack, 0);
				}
				else
				{
					LogInfo("NPC picked up CurrentHarvestResource " + name + " but currentcommand is null or not a HarvestAction");
				}
			}
			if (component.m_itemData.m_shared.m_questItem)
			{
				((Humanoid)__instance).AddUniqueKey(component.m_itemData.m_shared.m_name);
			}
			ZNetScene.instance.Destroy(((Component)component).gameObject);
			if (flag && component.m_itemData.IsWeapon() && ((Humanoid)__instance).m_rightItem == null && ((Humanoid)__instance).m_hiddenRightItem == null && (((Humanoid)__instance).m_leftItem == null || !((Humanoid)__instance).m_leftItem.IsTwoHanded()) && (((Humanoid)__instance).m_hiddenLeftItem == null || !((Humanoid)__instance).m_hiddenLeftItem.IsTwoHanded()))
			{
				((Humanoid)__instance).EquipItem(component.m_itemData, true);
			}
			((Humanoid)__instance).m_pickupEffects.Create(((Component)__instance).transform.position, Quaternion.identity, (Transform)null, 1f, -1);
		}
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Humanoid), "EquipBestWeapon")]
	private static bool Humanoid_EquipBestWeapon_Prefix(Humanoid __instance, Character targetCreature, StaticTarget targetStatic, Character hurtFriend, Character friend)
	{
		//IL_004c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0057: Unknown result type (might be due to invalid IL or missing references)
		//IL_007b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0086: Unknown result type (might be due to invalid IL or missing references)
		//IL_0127: Unknown result type (might be due to invalid IL or missing references)
		//IL_012d: Invalid comparison between Unknown and I4
		//IL_0200: Unknown result type (might be due to invalid IL or missing references)
		//IL_0206: Invalid comparison between Unknown and I4
		//IL_0279: Unknown result type (might be due to invalid IL or missing references)
		//IL_027f: Invalid comparison between Unknown and I4
		List<ItemData> allItems = __instance.m_inventory.GetAllItems();
		if (allItems.Count == 0 || ((Character)__instance).InAttack())
		{
			return false;
		}
		float num = 0f;
		if (Object.op_Implicit((Object)(object)targetCreature))
		{
			float radius = targetCreature.GetRadius();
			num = Vector3.Distance(((Component)targetCreature).transform.position, ((Component)__instance).transform.position) - radius;
		}
		else if (Object.op_Implicit((Object)(object)targetStatic))
		{
			num = Vector3.Distance(((Component)targetStatic).transform.position, ((Component)__instance).transform.position);
		}
		float time = Time.time;
		((Character)__instance).IsFlying();
		((Character)__instance).IsSwimming();
		Humanoid.optimalWeapons.Clear();
		Humanoid.outofRangeWeapons.Clear();
		Humanoid.allWeapons.Clear();
		foreach (ItemData item in allItems)
		{
			if (!item.IsWeapon() || !((Character)__instance).m_baseAI.CanUseAttack(item) || (IsRangedWeapon(item) && CheckArrows(__instance.m_inventory) == 0))
			{
				continue;
			}
			if ((int)item.m_shared.m_aiTargetType == 0)
			{
				if (num < item.m_shared.m_aiAttackRangeMin)
				{
					continue;
				}
				Humanoid.allWeapons.Add(item);
				if (((Object)(object)targetCreature == (Object)null && (Object)(object)targetStatic == (Object)null) || time - item.m_lastAttackTime < item.m_shared.m_aiAttackInterval)
				{
					continue;
				}
				if (num > item.m_shared.m_aiAttackRange)
				{
					Humanoid.outofRangeWeapons.Add(item);
					continue;
				}
				if (item.m_shared.m_aiPrioritized)
				{
					__instance.EquipItem(item, true);
					return false;
				}
				Humanoid.optimalWeapons.Add(item);
			}
			else if ((int)item.m_shared.m_aiTargetType == 1)
			{
				if (!((Object)(object)hurtFriend == (Object)null) && !(time - item.m_lastAttackTime < item.m_shared.m_aiAttackInterval))
				{
					if (item.m_shared.m_aiPrioritized)
					{
						__instance.EquipItem(item, true);
						return false;
					}
					Humanoid.optimalWeapons.Add(item);
				}
			}
			else if ((int)item.m_shared.m_aiTargetType == 2 && !((Object)(object)friend == (Object)null) && !(time - item.m_lastAttackTime < item.m_shared.m_aiAttackInterval))
			{
				if (item.m_shared.m_aiPrioritized)
				{
					__instance.EquipItem(item, true);
					return false;
				}
				Humanoid.optimalWeapons.Add(item);
			}
		}
		if (Humanoid.optimalWeapons.Count > 0)
		{
			foreach (ItemData optimalWeapon in Humanoid.optimalWeapons)
			{
				if (optimalWeapon.m_shared.m_aiPrioritized)
				{
					__instance.EquipItem(optimalWeapon, true);
					return false;
				}
			}
			__instance.EquipItem(Humanoid.optimalWeapons[Random.Range(0, Humanoid.optimalWeapons.Count)], true);
		}
		else if (Humanoid.outofRangeWeapons.Count > 0)
		{
			foreach (ItemData outofRangeWeapon in Humanoid.outofRangeWeapons)
			{
				if (outofRangeWeapon.m_shared.m_aiPrioritized)
				{
					__instance.EquipItem(outofRangeWeapon, true);
					return false;
				}
			}
			__instance.EquipItem(Humanoid.outofRangeWeapons[Random.Range(0, Humanoid.outofRangeWeapons.Count)], true);
		}
		else if (Humanoid.allWeapons.Count > 0)
		{
			foreach (ItemData allWeapon in Humanoid.allWeapons)
			{
				if (allWeapon.m_shared.m_aiPrioritized)
				{
					__instance.EquipItem(allWeapon, true);
					return false;
				}
			}
			__instance.EquipItem(Humanoid.allWeapons[Random.Range(0, Humanoid.allWeapons.Count)], true);
		}
		else
		{
			ItemData currentWeapon = __instance.GetCurrentWeapon();
			__instance.UnequipItem(currentWeapon, false);
		}
		return false;
	}

	[HarmonyPostfix]
	[HarmonyPatch(typeof(Humanoid), "EquipItem")]
	private static void HumanoidNPC_EquipItem_Postfix(Humanoid __instance, ItemData item, bool triggerEquipEffects = true)
	{
		//IL_0021: Unknown result type (might be due to invalid IL or missing references)
		//IL_0027: Invalid comparison between Unknown and I4
		if (IsStringEqual(((Object)__instance).name, NPCPrefabName) && (int)item.m_shared.m_skillType == 8 && item.m_shared.m_aiAttackRange < 10f)
		{
			item.m_shared.m_aiAttackRange = 20f;
		}
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Humanoid), "OnDamaged")]
	public static void Character_OnDamaged_Prefix(Humanoid __instance, HitData hit)
	{
		Player localPlayerOrNull = GetLocalPlayerOrNull();
		if (NPCCurrentMode != 0 && Object.op_Implicit((Object)(object)PlayerNPC) && ((Object)(object)__instance == (Object)(object)localPlayerOrNull || __instance is HumanoidNPC))
		{
			Character attacker = hit.GetAttacker();
			if ((Object)(object)attacker != (Object)null && !enemyList.Contains(attacker) && (Object)(object)attacker != (Object)(object)localPlayerOrNull)
			{
				enemyList.Add(attacker);
			}
		}
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Character), "OnDeath")]
	private static void Character_OnDeath_Prefix(Character __instance)
	{
		//IL_0089: Unknown result type (might be due to invalid IL or missing references)
		//IL_008e: Unknown result type (might be due to invalid IL or missing references)
		if (!Object.op_Implicit((Object)(object)PlayerNPC) || (NPCCurrentCommandType != NPCCommand.CommandType.CombatAttack && NPCCurrentCommandType != NPCCommand.CommandType.CombatSneakAttack))
		{
			return;
		}
		Debug.LogError((object)"Character_OnDeath_Prefix");
		if (NPCCurrentCommand == null || !(NPCCurrentCommand is AttackAction))
		{
			return;
		}
		Debug.LogError((object)"is AttackAction");
		AttackAction attackAction = (AttackAction)NPCCurrentCommand;
		if (IsStringEqual(((Object)((Component)__instance).gameObject).name, attackAction.TargetName))
		{
			ZDOID zDOID = __instance.GetZDOID();
			if (((object)(ZDOID)(ref zDOID)).ToString() == lastAttackedObjectZDOID)
			{
				Debug.LogError((object)("target " + attackAction.TargetName + " killed "));
				attackAction.TargetQuantity = Math.Max(attackAction.TargetQuantity - 1, 0);
				LogInfo($"{attackAction.TargetQuantity} {attackAction.TargetName} remaining to kill");
			}
		}
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Character), "RPC_Damage")]
	private static bool Character_RPC_Damage_Prefix(Character __instance, long sender, HitData hit)
	{
		//IL_0124: Unknown result type (might be due to invalid IL or missing references)
		//IL_01a9: Unknown result type (might be due to invalid IL or missing references)
		//IL_023f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0244: Unknown result type (might be due to invalid IL or missing references)
		//IL_028a: Unknown result type (might be due to invalid IL or missing references)
		//IL_028f: Unknown result type (might be due to invalid IL or missing references)
		//IL_03a6: Unknown result type (might be due to invalid IL or missing references)
		//IL_03ab: Unknown result type (might be due to invalid IL or missing references)
		//IL_03ad: Unknown result type (might be due to invalid IL or missing references)
		//IL_0470: Unknown result type (might be due to invalid IL or missing references)
		if (__instance.IsDebugFlying())
		{
			return false;
		}
		if ((Object)(object)hit.GetAttacker() == (Object)(object)Player.m_localPlayer)
		{
			Game.instance.IncrementPlayerStat((PlayerStatType)(__instance.IsPlayer() ? 8 : 5), 1f);
			__instance.m_localPlayerHasHit = true;
		}
		if (!__instance.m_nview.IsOwner() || __instance.GetHealth() <= 0f || __instance.IsDead() || __instance.IsTeleporting() || __instance.InCutscene() || (hit.m_dodgeable && __instance.IsDodgeInvincible()))
		{
			return false;
		}
		Character attacker = hit.GetAttacker();
		if ((hit.HaveAttacker() && (Object)(object)attacker == (Object)null) || (__instance.IsPlayer() && !__instance.IsPVPEnabled() && (Object)(object)attacker != (Object)null && attacker.IsPlayer() && !hit.m_ignorePVP))
		{
			return false;
		}
		if ((Object)(object)attacker != (Object)null && !attacker.IsPlayer())
		{
			float difficultyDamageScalePlayer = Game.instance.GetDifficultyDamageScalePlayer(((Component)__instance).transform.position);
			hit.ApplyModifier(difficultyDamageScalePlayer);
			hit.ApplyModifier(Game.m_enemyDamageRate);
		}
		__instance.m_seman.OnDamaged(hit, attacker);
		if ((Object)(object)__instance.m_baseAI != (Object)null && __instance.m_baseAI.IsAggravatable() && !__instance.m_baseAI.IsAggravated() && Object.op_Implicit((Object)(object)attacker) && attacker.IsPlayer() && hit.GetTotalDamage() > 0f)
		{
			BaseAI.AggravateAllInArea(((Component)__instance).transform.position, 20f, (AggravatedReason)0);
		}
		if ((Object)(object)__instance.m_baseAI != (Object)null && !__instance.m_baseAI.IsAlerted() && hit.m_backstabBonus > 1f && Time.time - __instance.m_backstabTime > 300f && (!ZoneSystem.instance.GetGlobalKey((GlobalKeys)24) || !__instance.m_baseAI.CanSeeTarget(attacker)))
		{
			__instance.m_backstabTime = Time.time;
			hit.ApplyModifier(hit.m_backstabBonus);
			__instance.m_backstabHitEffects.Create(hit.m_point, Quaternion.identity, ((Component)__instance).transform, 1f, -1);
		}
		if (__instance.IsStaggering() && !__instance.IsPlayer())
		{
			hit.ApplyModifier(2f);
			__instance.m_critHitEffects.Create(hit.m_point, Quaternion.identity, ((Component)__instance).transform, 1f, -1);
		}
		if (hit.m_blockable && __instance.IsBlocking())
		{
			__instance.BlockAttack(hit, attacker);
		}
		__instance.ApplyPushback(hit);
		if (hit.m_statusEffectHash != 0)
		{
			StatusEffect val = __instance.m_seman.GetStatusEffect(hit.m_statusEffectHash);
			if ((Object)(object)val == (Object)null)
			{
				val = __instance.m_seman.AddStatusEffect(hit.m_statusEffectHash, false, (int)hit.m_itemLevel, hit.m_skillLevel);
			}
			else
			{
				val.ResetTime();
				val.SetLevel((int)hit.m_itemLevel, hit.m_skillLevel);
			}
			if ((Object)(object)val != (Object)null && (Object)(object)attacker != (Object)null)
			{
				val.SetAttacker(attacker);
			}
		}
		WeakSpot weakSpot = __instance.GetWeakSpot(hit.m_weakSpot);
		if ((Object)(object)weakSpot != (Object)null)
		{
			ZLog.Log((object)("HIT Weakspot:" + ((Object)((Component)weakSpot).gameObject).name));
		}
		DamageModifiers damageModifiers = __instance.GetDamageModifiers(weakSpot);
		DamageModifier val2 = default(DamageModifier);
		hit.ApplyResistance(damageModifiers, ref val2);
		if (__instance.IsPlayer() || __instance is HumanoidNPC)
		{
			float bodyArmor = __instance.GetBodyArmor();
			hit.ApplyArmor(bodyArmor);
			__instance.DamageArmorDurability(hit);
		}
		else if (Game.m_worldLevel > 0)
		{
			hit.ApplyArmor((float)(Game.m_worldLevel * Game.instance.m_worldLevelEnemyBaseAC));
		}
		float poison = hit.m_damage.m_poison;
		float fire = hit.m_damage.m_fire;
		float spirit = hit.m_damage.m_spirit;
		hit.m_damage.m_poison = 0f;
		hit.m_damage.m_fire = 0f;
		hit.m_damage.m_spirit = 0f;
		__instance.ApplyDamage(hit, true, true, val2);
		__instance.AddFireDamage(fire);
		__instance.AddSpiritDamage(spirit);
		__instance.AddPoisonDamage(poison);
		__instance.AddFrostDamage(hit.m_damage.m_frost);
		__instance.AddLightningDamage(hit.m_damage.m_lightning);
		return false;
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Player), "UpdateFood")]
	private static bool Player_UpdateFood_Prefix(Player __instance, float dt, bool forceUpdate)
	{
		__instance.m_foodUpdateTimer += dt;
		if (__instance.m_foodUpdateTimer >= 1f || forceUpdate)
		{
			__instance.m_foodUpdateTimer -= 1f;
			foreach (Food food in __instance.m_foods)
			{
				food.m_time -= 1f;
				float num = Mathf.Clamp01(food.m_time / food.m_item.m_shared.m_foodBurnTime);
				num = Mathf.Pow(num, 0.3f);
				food.m_health = food.m_item.m_shared.m_food * num;
				food.m_stamina = food.m_item.m_shared.m_foodStamina * num;
				food.m_eitr = food.m_item.m_shared.m_foodEitr * num;
				if (food.m_time <= 0f)
				{
					__instance.m_foods.Remove(food);
					break;
				}
			}
			float num2 = default(float);
			float num3 = default(float);
			float num4 = default(float);
			__instance.GetTotalFoodValue(ref num2, ref num3, ref num4);
			__instance.SetMaxHealth(num2, true);
			__instance.SetMaxStamina(num3, true);
			__instance.SetMaxEitr(num4, true);
			if ((Object)(object)humanoid_PlayerNPC != (Object)null && (Math.Abs(((Character)humanoid_PlayerNPC).GetMaxHealth() - num2) > 1.5f || Math.Abs(humanoid_PlayerNPC.m_maxStamina - num3) > 1.5f))
			{
				((Character)humanoid_PlayerNPC).SetMaxHealth(num2);
				humanoid_PlayerNPC.m_maxStamina = num3;
				MessageHud.instance.ShowMessage((MessageType)1, ((Character)humanoid_PlayerNPC).m_name + " stats updated:\n Max Health: " + num2.ToString("F1") + "\nMax Stamina: " + num3.ToString("F1") + "\n\n\n", 0, (Sprite)null);
			}
			if (num4 > 0f)
			{
				__instance.ShowTutorial("eitr", false);
			}
		}
		if (forceUpdate)
		{
			return false;
		}
		__instance.m_foodRegenTimer += dt;
		if (!(__instance.m_foodRegenTimer >= 10f))
		{
			return false;
		}
		__instance.m_foodRegenTimer = 0f;
		float num5 = 0f;
		foreach (Food food2 in __instance.m_foods)
		{
			num5 += food2.m_item.m_shared.m_foodRegen;
		}
		if (num5 > 0f)
		{
			float num6 = 1f;
			((Character)__instance).m_seman.ModifyHealthRegen(ref num6);
			num5 *= num6;
			((Character)__instance).Heal(num5, true);
			if (Object.op_Implicit((Object)(object)PlayerNPC))
			{
				HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
				if ((Object)(object)component != (Object)null)
				{
					((Character)component).Heal(num5, true);
				}
			}
		}
		return false;
	}

	[HarmonyPostfix]
	[HarmonyPatch(typeof(Player), "SetCrouch")]
	private static void Player_SetCrouch_Postfix(Player __instance, bool crouch)
	{
		if (Object.op_Implicit((Object)(object)PlayerNPC) && Object.op_Implicit((Object)(object)humanoid_PlayerNPC) && NPCCurrentCommandType == NPCCommand.CommandType.FollowPlayer)
		{
			((Character)humanoid_PlayerNPC).SetCrouch(crouch);
		}
	}

	[HarmonyPostfix]
	[HarmonyPatch(typeof(Character), "SetWalk")]
	private static void Character_SetWalk_Postfix(Character __instance, bool walk)
	{
		if (__instance is Player && Object.op_Implicit((Object)(object)PlayerNPC) && Object.op_Implicit((Object)(object)humanoid_PlayerNPC) && NPCCurrentCommandType == NPCCommand.CommandType.FollowPlayer)
		{
			((Character)humanoid_PlayerNPC).SetWalk(walk);
		}
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(BaseAI), "FindRandomStaticTarget")]
	private static bool BaseAI_FindRandomStaticTarget_Prefix(BaseAI __instance, float maxDistance, StaticTarget __result)
	{
		if (!IsStringEqual(((Object)__instance).name, NPCPrefabName))
		{
			return true;
		}
		__result = null;
		return false;
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(BaseAI), "FindClosestStaticPriorityTarget")]
	private static bool BaseAI_FindClosestStaticPriorityTarget_Prefix(BaseAI __instance, StaticTarget __result)
	{
		if (!IsStringEqual(((Object)__instance).name, NPCPrefabName))
		{
			return true;
		}
		__result = null;
		return false;
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(InventoryGui), "OnSelectedItem")]
	private static bool InventoryGui_OnSelectedItem_Prefix(InventoryGui __instance, InventoryGrid grid, ItemData item, Vector2i pos, Modifier mod)
	{
		//IL_0400: Unknown result type (might be due to invalid IL or missing references)
		//IL_0402: Unknown result type (might be due to invalid IL or missing references)
		//IL_0404: Unknown result type (might be due to invalid IL or missing references)
		//IL_0406: Unknown result type (might be due to invalid IL or missing references)
		//IL_0408: Unknown result type (might be due to invalid IL or missing references)
		//IL_040b: Unknown result type (might be due to invalid IL or missing references)
		//IL_041d: Expected I4, but got Unknown
		//IL_0607: Unknown result type (might be due to invalid IL or missing references)
		//IL_060c: Unknown result type (might be due to invalid IL or missing references)
		//IL_01ed: Unknown result type (might be due to invalid IL or missing references)
		//IL_01f2: Unknown result type (might be due to invalid IL or missing references)
		//IL_05be: Unknown result type (might be due to invalid IL or missing references)
		//IL_05c3: Unknown result type (might be due to invalid IL or missing references)
		//IL_0227: Unknown result type (might be due to invalid IL or missing references)
		//IL_022c: Unknown result type (might be due to invalid IL or missing references)
		//IL_057a: Unknown result type (might be due to invalid IL or missing references)
		//IL_057f: Unknown result type (might be due to invalid IL or missing references)
		//IL_02dd: Unknown result type (might be due to invalid IL or missing references)
		//IL_0320: Unknown result type (might be due to invalid IL or missing references)
		//IL_0326: Unknown result type (might be due to invalid IL or missing references)
		//IL_0381: Unknown result type (might be due to invalid IL or missing references)
		//IL_0388: Unknown result type (might be due to invalid IL or missing references)
		Player localPlayer = Player.m_localPlayer;
		if (((Character)localPlayer).IsTeleporting())
		{
			return false;
		}
		if (Object.op_Implicit((Object)(object)__instance.m_dragGo))
		{
			if (Object.op_Implicit((Object)(object)humanoid_PlayerNPC) && (Object)(object)__instance.m_currentContainer == (Object)(object)humanoid_PlayerNPC.inventoryContainer && __instance.m_dragInventory != null)
			{
				if (__instance.m_dragInventory == ((Humanoid)humanoid_PlayerNPC).m_inventory && (Object)(object)__instance.m_containerGrid != (Object)(object)grid)
				{
					((Humanoid)localPlayer).GetInventory().MoveItemToThis(grid.GetInventory(), __instance.m_dragItem);
					if (__instance.m_dragItem != null && __instance.m_dragItem.IsEquipable())
					{
						((Humanoid)humanoid_PlayerNPC).UnequipItem(__instance.m_dragItem, true);
						if (item != null && item.IsEquipable())
						{
							((Humanoid)humanoid_PlayerNPC).UnequipItem(item, true);
						}
					}
				}
				else if (__instance.m_dragInventory == ((Humanoid)localPlayer).m_inventory && (Object)(object)__instance.m_containerGrid == (Object)(object)grid)
				{
					__instance.m_currentContainer.GetInventory().MoveItemToThis(((Humanoid)localPlayer).GetInventory(), __instance.m_dragItem);
					if (__instance.m_dragItem != null && __instance.m_dragItem.IsEquipable())
					{
						if (((Humanoid)Player.m_localPlayer).IsItemEquiped(__instance.m_dragItem) || ((Humanoid)Player.m_localPlayer).GetCurrentWeapon() == __instance.m_dragItem)
						{
							((Humanoid)Player.m_localPlayer).UnequipItem(__instance.m_dragItem, true);
						}
						((Humanoid)humanoid_PlayerNPC).EquipItem(__instance.m_dragItem, true);
						if (item != null && item.IsEquipable())
						{
							((Humanoid)humanoid_PlayerNPC).EquipItem(item, true);
						}
					}
				}
			}
			__instance.m_moveItemEffects.Create(((Component)__instance).transform.position, Quaternion.identity, (Transform)null, 1f, -1);
			bool flag = ((Humanoid)localPlayer).IsItemEquiped(__instance.m_dragItem);
			bool flag2 = item != null && ((Humanoid)localPlayer).IsItemEquiped(item);
			Vector2i gridPos = __instance.m_dragItem.m_gridPos;
			if ((__instance.m_dragItem.m_shared.m_questItem || (item != null && item.m_shared.m_questItem)) && __instance.m_dragInventory != grid.GetInventory())
			{
				return false;
			}
			if (!__instance.m_dragInventory.ContainsItem(__instance.m_dragItem))
			{
				__instance.SetupDragItem((ItemData)null, (Inventory)null, 1);
				return false;
			}
			((Humanoid)localPlayer).RemoveEquipAction(item);
			((Humanoid)localPlayer).RemoveEquipAction(__instance.m_dragItem);
			((Humanoid)localPlayer).UnequipItem(__instance.m_dragItem, false);
			((Humanoid)localPlayer).UnequipItem(item, false);
			bool flag3 = grid.DropItem(__instance.m_dragInventory, __instance.m_dragItem, __instance.m_dragAmount, pos);
			if (__instance.m_dragItem.m_stack < __instance.m_dragAmount)
			{
				__instance.m_dragAmount = __instance.m_dragItem.m_stack;
			}
			if (flag)
			{
				ItemData itemAt = grid.GetInventory().GetItemAt(pos.x, pos.y);
				if (itemAt != null)
				{
					((Humanoid)localPlayer).EquipItem(itemAt, false);
				}
				if (((Humanoid)localPlayer).GetInventory().ContainsItem(__instance.m_dragItem))
				{
					((Humanoid)localPlayer).EquipItem(__instance.m_dragItem, false);
				}
			}
			if (flag2)
			{
				ItemData itemAt2 = __instance.m_dragInventory.GetItemAt(gridPos.x, gridPos.y);
				if (itemAt2 != null)
				{
					((Humanoid)localPlayer).EquipItem(itemAt2, false);
				}
				if (((Humanoid)localPlayer).GetInventory().ContainsItem(item))
				{
					((Humanoid)localPlayer).EquipItem(item, false);
				}
			}
			if (flag3)
			{
				__instance.SetupDragItem((ItemData)null, (Inventory)null, 1);
				__instance.UpdateCraftingPanel(false);
			}
		}
		else
		{
			if (item == null)
			{
				return false;
			}
			switch (mod - 1)
			{
			case 1:
				if (item.m_shared.m_questItem)
				{
					return false;
				}
				if ((Object)(object)__instance.m_currentContainer != (Object)null)
				{
					((Humanoid)localPlayer).RemoveEquipAction(item);
					((Humanoid)localPlayer).UnequipItem(item, true);
					if (grid.GetInventory() == __instance.m_currentContainer.GetInventory())
					{
						((Humanoid)localPlayer).GetInventory().MoveItemToThis(grid.GetInventory(), item);
						if (Object.op_Implicit((Object)(object)PlayerNPC))
						{
							HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
							if (grid.GetInventory() == ((Humanoid)component).m_inventory && item.IsEquipable())
							{
								((Humanoid)component).UnequipItem(item, true);
							}
						}
					}
					else
					{
						__instance.m_currentContainer.GetInventory().MoveItemToThis(((Humanoid)localPlayer).GetInventory(), item);
						if (Object.op_Implicit((Object)(object)PlayerNPC))
						{
							HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
							if (__instance.m_currentContainer.GetInventory() == ((Humanoid)component2).m_inventory && item.IsEquipable())
							{
								((Humanoid)component2).EquipItem(item, true);
							}
							if (item != null && ((Humanoid)localPlayer).IsItemEquiped(item))
							{
								((Humanoid)humanoid_PlayerNPC).UnequipItem(item, true);
							}
						}
					}
					__instance.m_moveItemEffects.Create(((Component)__instance).transform.position, Quaternion.identity, (Transform)null, 1f, -1);
				}
				else if (((Humanoid)Player.m_localPlayer).DropItem(grid.GetInventory(), item, item.m_stack))
				{
					__instance.m_moveItemEffects.Create(((Component)__instance).transform.position, Quaternion.identity, (Transform)null, 1f, -1);
				}
				return false;
			case 2:
				if (((Humanoid)Player.m_localPlayer).DropItem(grid.GetInventory(), item, item.m_stack))
				{
					__instance.m_moveItemEffects.Create(((Component)__instance).transform.position, Quaternion.identity, (Transform)null, 1f, -1);
				}
				return false;
			case 0:
				if (item.m_stack > 1)
				{
					__instance.ShowSplitDialog(item, grid.GetInventory());
					return false;
				}
				break;
			}
			__instance.SetupDragItem(item, grid.GetInventory(), item.m_stack);
		}
		return false;
	}

	private static string GetChatInputText()
	{
		//IL_001a: Unknown result type (might be due to invalid IL or missing references)
		if ((Object)(object)Chat.instance != (Object)null)
		{
			return ((TMP_InputField)((Terminal)Chat.instance).m_input).text;
		}
		return "";
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Chat), "InputText")]
	private static bool Chat_InputText_Prefix(Chat __instance)
	{
		string chatInputText = GetChatInputText();
		if (IsLocalSingleplayer() && Object.op_Implicit((Object)(object)PlayerNPC) && !chatInputText.StartsWith("/"))
		{
			instance.BrainSendInstruction(PlayerNPC, Voice: false);
			if (Object.op_Implicit((Object)(object)Player.m_localPlayer))
			{
				instance.AddChatTalk((Character)(object)Player.m_localPlayer, "NPC", chatInputText);
			}
			instance.AddChatTalk((Character)(object)humanoid_PlayerNPC, "NPC", "...", addToChat: false);
		}
		return false;
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(ItemDrop), "RPC_RequestOwn")]
	private static bool ItemDrop_RPC_RequestOwn_Prefix(ItemDrop __instance, long uid)
	{
		ZLog.Log((object)("Player " + uid + " wants to pickup " + ((Object)((Component)__instance).gameObject).name + "   im: " + ZDOMan.GetSessionID()));
		if (__instance.m_nview.IsOwner())
		{
			__instance.m_nview.GetZDO().SetOwner(uid);
		}
		else if (__instance.m_nview.GetZDO().GetOwner() == uid)
		{
			ZLog.Log((object)"  but they are already the owner");
		}
		else
		{
			ZLog.Log((object)"  but neither I nor the requesting player are the owners");
			__instance.m_nview.GetZDO().SetOwner(uid);
		}
		return false;
	}

	private static void LogInfo(string s)
	{
		logger.LogInfo((object)s);
		logEntries.Add("[Info] [" + DateTime.Now.ToString() + "] " + s);
	}

	private static void LogMessage(string s)
	{
		logger.LogMessage((object)s);
		logEntries.Add("[Message] [" + DateTime.Now.ToString() + "] " + s);
	}

	private static void LogWarning(string s)
	{
		logger.LogWarning((object)s);
		logEntries.Add("[Warning] [" + DateTime.Now.ToString() + "] " + s);
	}

	private static void LogError(string s)
	{
		logger.LogError((object)s);
		logEntries.Add("[Error] [" + DateTime.Now.ToString() + "] " + s);
	}

	private void CaptureLog(string logString, string stackTrace, LogType type)
	{
		//IL_0010: Unknown result type (might be due to invalid IL or missing references)
		//IL_001d: Unknown result type (might be due to invalid IL or missing references)
		//IL_001f: Invalid comparison between Unknown and I4
		string text = $"[{Time.time}] [{type}] {logString}";
		if ((int)type == 4)
		{
			text = text + "\n" + stackTrace;
		}
		logEntries.Add(text);
		if (logEntries.Count > 10000)
		{
			logEntries.RemoveAt(0);
		}
	}

	private void RestartSendLogTimer()
	{
		instance.SetTimer(30f, delegate
		{
			instance.SendLogToBrain();
			instance.RestartSendLogTimer();
		});
	}

	[HarmonyPostfix]
	[HarmonyPriority(200)]
	[HarmonyPatch(typeof(Player), "Awake")]
	public static void Player_Awake_Postfix(Player __instance)
	{
		if ((Object)(object)__instance == (Object)null || (Object)(object)ZNetScene.instance == (Object)null)
		{
			return;
		}
		if (!ModInitComplete)
		{
			instance.DoModInit();
		}
		else
		{
			LogInfo("Skipping Thrall mod init because it is already initialized.");
		}
		FindPlayerNPC();
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			return;
		}
		instance.SetTimer(1f, delegate
		{
			if (!Object.op_Implicit((Object)(object)PlayerNPC))
			{
				LogWarning("Spawning a Thrall into the world!");
				instance.SpawnCompanion();
				if (Object.op_Implicit((Object)(object)humanoid_PlayerNPC))
				{
					string text = "Hey there, I'm " + ((((Character)humanoid_PlayerNPC).m_name != "") ? ((Character)humanoid_PlayerNPC).m_name : "your Thrall") + ". Press and hold T to talk with me.";
					instance.AddChatTalk((Character)(object)humanoid_PlayerNPC, "NPC", text);
					instance.BrainSynthesizeAudio(text, npcVoices[instance.npcVoice].ToLower());
				}
			}
		});
	}

	[HarmonyPostfix]
	[HarmonyPatch(typeof(Player), "Update")]
	private static void Player_Update_Postfix(Player __instance)
	{
		//IL_0197: Unknown result type (might be due to invalid IL or missing references)
		//IL_01f8: Unknown result type (might be due to invalid IL or missing references)
		//IL_0277: Unknown result type (might be due to invalid IL or missing references)
		//IL_02d1: Unknown result type (might be due to invalid IL or missing references)
		//IL_02fd: Unknown result type (might be due to invalid IL or missing references)
		//IL_0382: Unknown result type (might be due to invalid IL or missing references)
		//IL_043c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0531: Unknown result type (might be due to invalid IL or missing references)
		//IL_05a2: Unknown result type (might be due to invalid IL or missing references)
		//IL_05db: Unknown result type (might be due to invalid IL or missing references)
		if (!FindPlayerNPCTimer)
		{
			instance.SetTimer(0.5f, delegate
			{
				FindPlayerNPC();
				FindPlayerNPCTimer = false;
			});
			FindPlayerNPCTimer = true;
		}
		if (((Object)(object)EventSystem.current.currentSelectedGameObject != (Object)null && Object.op_Implicit((Object)(object)EventSystem.current.currentSelectedGameObject.GetComponent<InputField>())) || !Object.op_Implicit((Object)(object)ZNetScene.instance) || !Object.op_Implicit((Object)(object)Player.m_localPlayer) || ((Character)Player.m_localPlayer).IsTeleporting())
		{
			return;
		}
		if (Object.op_Implicit((Object)(object)humanoid_PlayerNPC))
		{
			List<PinData> list = new List<PinData>();
			foreach (PinData pin in Minimap.instance.m_pins)
			{
				if (pin.m_author == "NPC" && humanoid_PlayerNPC.npcPinData != null && pin != humanoid_PlayerNPC.npcPinData)
				{
					list.Add(pin);
				}
			}
			foreach (PinData item in list)
			{
				Minimap.instance.RemovePin(item);
			}
		}
		if (IsInventoryShowing && (ZInput.GetKeyDown((KeyCode)27, true) || ZInput.GetKeyDown(instance.inventoryKey.Value, true)))
		{
			SaveNPCData(PlayerNPC);
			IsInventoryShowing = false;
		}
		else if (IsModMenuShowing && ZInput.GetKeyDown((KeyCode)27, true))
		{
			instance.ToggleModMenu();
		}
		else if (ZInput.GetKeyDown(instance.inventoryKey.Value, true) && (Object)(object)__instance.m_hovering == (Object)(object)PlayerNPC && (Object)(object)PlayerNPC != (Object)null)
		{
			IsInventoryShowing = InventoryGui.instance.m_animator.GetBool("visible");
			SaveNPCData(PlayerNPC);
		}
		else
		{
			if (Console.IsVisible())
			{
				return;
			}
			if (IsModMenuShowing && ZInput.GetKeyDown(instance.thrallMenuKey.Value, true))
			{
				instance.ToggleModMenu();
			}
			else
			{
				if (Menu.IsVisible() || Chat.instance.HasFocus() || !((Character)__instance).TakeInput())
				{
					return;
				}
				if (ZInput.GetKeyDown(instance.thrallMenuKey.Value, true))
				{
					instance.ToggleModMenu();
					return;
				}
				if (ZInput.GetKeyDown(instance.spawnKey.Value, true))
				{
					FindPlayerNPC();
					if (Object.op_Implicit((Object)(object)PlayerNPC))
					{
						SaveNPCData(PlayerNPC);
						((Character)humanoid_PlayerNPC).AddPoisonDamage(100000f);
						((Character)humanoid_PlayerNPC).m_health = 0f;
						MessageHud.instance.ShowMessage((MessageType)2, "Thrall left the world!", 0, (Sprite)null);
					}
					else
					{
						instance.SpawnCompanion();
					}
					return;
				}
				if (ZInput.GetKeyDown(instance.followKey.Value, true) && Object.op_Implicit((Object)(object)PlayerNPC))
				{
					HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
					if (NPCCurrentCommandType != NPCCommand.CommandType.FollowPlayer)
					{
						MessageHud.instance.ShowMessage((MessageType)2, ((Character)component).m_name + " now following you!", 0, (Sprite)null);
						instance.Follow_Start(((Component)__instance).gameObject);
					}
					else
					{
						MessageHud.instance.ShowMessage((MessageType)2, ((Character)component).m_name + " now patrolling this area!", 0, (Sprite)null);
						instance.Patrol_Start();
					}
					return;
				}
				if (ZInput.GetKeyDown(instance.harvestKey.Value, true) && Object.op_Implicit((Object)(object)PlayerNPC))
				{
					HumanoidNPC component2 = PlayerNPC.GetComponent<HumanoidNPC>();
					if (NPCCurrentCommandType == NPCCommand.CommandType.HarvestResource)
					{
						instance.commandManager.RemoveCommandsOfType<HarvestAction>();
						MessageHud.instance.ShowMessage((MessageType)2, ((Character)component2).m_name + " stopped harvesting!", 0, (Sprite)null);
						return;
					}
					HarvestAction harvestAction = new HarvestAction();
					harvestAction.humanoidNPC = component2;
					harvestAction.ResourceName = "Wood";
					harvestAction.RequiredAmount = 20;
					harvestAction.OriginalRequiredAmount = 20;
					instance.commandManager.AddCommand(harvestAction);
					MessageHud.instance.ShowMessage((MessageType)2, ((Character)component2).m_name + " harvesting " + harvestAction.ResourceName.ToLower() + "!", 0, (Sprite)null);
					return;
				}
				if (ZInput.GetKeyDown(instance.combatModeKey.Value, true) && Object.op_Implicit((Object)(object)PlayerNPC))
				{
					HumanoidNPC component3 = PlayerNPC.GetComponent<HumanoidNPC>();
					ToggleNPCCurrentCommandType();
					MessageHud.instance.ShowMessage((MessageType)2, ((Character)component3).m_name + " is now " + NPCCurrentMode, 0, (Sprite)null);
				}
				if (ZInput.GetKey(instance.talkKey.Value, true) && !IsRecording)
				{
					instance.StartRecording();
				}
				else if (!ZInput.GetKey(instance.talkKey.Value, true) && IsRecording)
				{
					if (Time.time - recordingStartedTime > 1f)
					{
						shortRecordingWarningShown = false;
						instance.StopRecording();
						instance.SendRecordingToBrain();
					}
					else if (!shortRecordingWarningShown)
					{
						shortRecordingWarningShown = true;
					}
				}
				else
				{
					if (!ZInput.GetKeyDown((KeyCode)112, true))
					{
						return;
					}
					string currentHarvestResourceName = CurrentHarvestResourceName;
					List<(string, string, float, float, int)> source = instance.FindResourceSourcesRecursive(currentHarvestResourceName, ((Humanoid)__instance).GetCurrentWeapon());
					source = source.OrderByDescending<(string, string, float, float, int), float>(((string Category, string Name, float Efficiency, float Distance, int Depth) s) => s.Efficiency).ToList();
					if (source.Count == 0)
					{
						Debug.Log((object)("No sources found for " + currentHarvestResourceName + " in nearby resources."));
						return;
					}
					Debug.Log((object)("Sources for " + currentHarvestResourceName + ", sorted by efficiency:"));
					for (int i = 0; i < source.Count; i++)
					{
						var (text, text2, num, num2, num3) = source[i];
						if (num > 0f)
						{
							Debug.Log((object)$"{i + 1}. {text} - {text2} (Efficiency: {num:F2}, Distance: {num2:F2}, Depth: {num3})");
						}
						else
						{
							Debug.Log((object)$"{i + 1}. {text} - {text2} (Not interactable with current weapon, Distance: {num2:F2}, Depth: {num3})");
						}
					}
				}
			}
		}
	}

	private void OnInventoryKeyPressed(Player player, bool Show)
	{
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			SaveNPCData(PlayerNPC);
			if (!Show)
			{
				InventoryGui.instance.Hide();
				IsInventoryShowing = false;
			}
			else
			{
				HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
				InventoryGui.instance.Show(component.inventoryContainer, 1);
				IsInventoryShowing = true;
			}
		}
		else
		{
			LogError("OnInventoryKeyPressed PlayerNPC is null ");
		}
	}

	private void SpawnCompanion()
	{
		//IL_0079: Unknown result type (might be due to invalid IL or missing references)
		//IL_0084: Unknown result type (might be due to invalid IL or missing references)
		//IL_008e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0093: Unknown result type (might be due to invalid IL or missing references)
		//IL_0098: Unknown result type (might be due to invalid IL or missing references)
		//IL_009f: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a4: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a6: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a7: Unknown result type (might be due to invalid IL or missing references)
		FindPlayerNPC();
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			LogError("Spawning more than one NPC is disabled");
			return;
		}
		Player localPlayer = Player.m_localPlayer;
		GameObject prefab = ZNetScene.instance.GetPrefab("HumanoidNPC");
		instance.commandManager.RemoveAllCommands();
		enemyList.Clear();
		if ((Object)(object)prefab == (Object)null)
		{
			LogError("ScriptNPC prefab not found!");
		}
		Vector3 val = ((Component)localPlayer).transform.position + ((Component)localPlayer).transform.forward * 2f;
		Quaternion rotation = ((Component)localPlayer).transform.rotation;
		GameObject val2 = Object.Instantiate<GameObject>(prefab, val, rotation);
		val2.SetActive(true);
		CapsuleCollider component = val2.GetComponent<CapsuleCollider>();
		component.radius = 0.7f;
		VisEquipment component2 = val2.GetComponent<VisEquipment>();
		VisEquipment component3 = ((Component)localPlayer).GetComponent<VisEquipment>();
		component2.m_isPlayer = true;
		component2.m_emptyBodyTexture = component3.m_emptyBodyTexture;
		component2.m_emptyLegsTexture = component3.m_emptyLegsTexture;
		PlayerNPC = val2;
		if (ExposedGameObjectExtension.HasAnyComponent(val2, new string[1] { "Tameable" }))
		{
			Object.Destroy((Object)(object)val2.GetComponent<Tameable>());
		}
		ThrallAI component4 = val2.GetComponent<ThrallAI>();
		SetMonsterAIAggravated(component4, Aggravated: false);
		component4.MakeTame();
		component4.SetFollowTarget(((Component)localPlayer).gameObject);
		((BaseAI)component4).m_viewRange = 80f;
		component4.m_alertRange = 800f;
		component4.m_maxChaseDistance = 500f;
		component4.m_fleeIfLowHealth = 0f;
		component4.m_fleeIfNotAlerted = false;
		component4.m_fleeIfHurtWhenTargetCantBeReached = false;
		((BaseAI)component4).m_aggravatable = false;
		((BaseAI)component4).m_alerted = false;
		((BaseAI)component4).m_aggravated = false;
		component4.m_targetCreature = null;
		((BaseAI)component4).SetHuntPlayer(false);
		((BaseAI)component4).m_viewRange = 0f;
		NPCCurrentMode = NPCMode.Defensive;
		HumanoidNPC val3 = (humanoid_PlayerNPC = val2.GetComponent<HumanoidNPC>());
		if ((Object)(object)val3 != (Object)null)
		{
			LoadNPCData(val3);
			EquipBestClothes((Humanoid)(object)val3);
			MessageHud.instance.ShowMessage((MessageType)2, ((Character)val3).m_name + " has entered the world!", 0, (Sprite)null);
			Character val4 = (Character)(object)val3;
			val4.m_onDeath = (Action)Delegate.Combine(val4.m_onDeath, new Action(OnNPCDeath));
			if (((Humanoid)val3).m_inventory.m_inventory.Count == 0)
			{
				GameObject prefab2 = ZNetScene.instance.GetPrefab("ArmorRagsChest");
				ItemData val5 = ((Humanoid)val3).PickupPrefab(prefab2, 1, true);
				((Humanoid)val3).EquipItem(val5, true);
				prefab2 = ZNetScene.instance.GetPrefab("ArmorRagsLegs");
				val5 = ((Humanoid)val3).PickupPrefab(prefab2, 1, true);
				((Humanoid)val3).EquipItem(val5, true);
				LogInfo("Thrall's inventory size was 0, giving default rags");
			}
			((Character)val3).m_walkSpeed = ((Character)localPlayer).m_walkSpeed;
			((Character)val3).m_runSpeed = ((Character)localPlayer).m_runSpeed;
			((Humanoid)val3).SetHair("Hair17");
			((Character)val3).SetMaxHealth(300f);
			((Character)val3).SetHealth(300f);
			val3.inventoryContainer = val2.AddComponent<Container>();
			val3.inventoryContainer.m_inventory = ((Humanoid)val3).m_inventory;
		}
		else
		{
			LogError("humanoidNpc_Component component not found on the instantiated ScriptNPC prefab!");
		}
	}

	protected virtual void OnNPCDeath()
	{
		MessageHud.instance.ShowMessage((MessageType)2, "Your Thrall died! Press [G] to respawn", 0, (Sprite)null);
		HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
		SaveNPCData(PlayerNPC);
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(ZNetScene), "RemoveObjects")]
	private static bool ZNetScene_RemoveObjects_Prefix(ZNetScene __instance, List<ZDO> currentNearObjects, List<ZDO> currentDistantObjects)
	{
		byte b = (byte)((uint)Time.frameCount & 0xFFu);
		foreach (ZDO currentNearObject in currentNearObjects)
		{
			currentNearObject.TempRemoveEarmark = b;
		}
		foreach (ZDO currentDistantObject in currentDistantObjects)
		{
			currentDistantObject.TempRemoveEarmark = b;
		}
		__instance.m_tempRemoved.Clear();
		foreach (ZNetView value in __instance.m_instances.Values)
		{
			if (Object.op_Implicit((Object)(object)value) && value.GetZDO() != null && value.GetZDO().TempRemoveEarmark != b)
			{
				__instance.m_tempRemoved.Add(value);
			}
		}
		for (int i = 0; i < __instance.m_tempRemoved.Count; i++)
		{
			ZNetView val = __instance.m_tempRemoved[i];
			ZDO zDO = val.GetZDO();
			val.ResetZDO();
			Object.Destroy((Object)(object)((Component)val).gameObject);
			if (!zDO.Persistent && zDO.IsOwner())
			{
				ZDOMan.instance.DestroyZDO(zDO);
			}
			__instance.m_instances.Remove(zDO);
		}
		return false;
	}

	[HarmonyPrefix]
	[HarmonyPatch(typeof(Game), "UpdateSaving")]
	private static bool Game_UpdateSaving_Prefix()
	{
		if (instance.DisableAutoSave == null)
		{
			return false;
		}
		return !instance.DisableAutoSave.Value;
	}

	private void ToggleModMenu()
	{
		if (!Object.op_Implicit((Object)(object)PlayerNPC))
		{
			MessageHud.instance.ShowMessage((MessageType)2, "Cannot open Thrall Menu without a Thrall in the world!", 0, (Sprite)null);
			return;
		}
		instance.panelManager.TogglePanel("Settings");
		instance.panelManager.TogglePanel("Thrall Customization");
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			SaveNPCData(PlayerNPC);
		}
	}

	private void CreateModMenuUI()
	{
		//IL_001d: Unknown result type (might be due to invalid IL or missing references)
		//IL_002c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0037: Unknown result type (might be due to invalid IL or missing references)
		//IL_0051: Unknown result type (might be due to invalid IL or missing references)
		//IL_0076: Unknown result type (might be due to invalid IL or missing references)
		//IL_0085: Unknown result type (might be due to invalid IL or missing references)
		//IL_0090: Unknown result type (might be due to invalid IL or missing references)
		//IL_00aa: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d5: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e4: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f3: Unknown result type (might be due to invalid IL or missing references)
		//IL_010c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0137: Unknown result type (might be due to invalid IL or missing references)
		//IL_0146: Unknown result type (might be due to invalid IL or missing references)
		//IL_0155: Unknown result type (might be due to invalid IL or missing references)
		//IL_016e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0199: Unknown result type (might be due to invalid IL or missing references)
		//IL_01a8: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b7: Unknown result type (might be due to invalid IL or missing references)
		//IL_01d0: Unknown result type (might be due to invalid IL or missing references)
		//IL_01fb: Unknown result type (might be due to invalid IL or missing references)
		//IL_020a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0219: Unknown result type (might be due to invalid IL or missing references)
		//IL_0232: Unknown result type (might be due to invalid IL or missing references)
		//IL_025d: Unknown result type (might be due to invalid IL or missing references)
		//IL_026c: Unknown result type (might be due to invalid IL or missing references)
		//IL_027b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0294: Unknown result type (might be due to invalid IL or missing references)
		//IL_02bf: Unknown result type (might be due to invalid IL or missing references)
		//IL_02ce: Unknown result type (might be due to invalid IL or missing references)
		//IL_02dd: Unknown result type (might be due to invalid IL or missing references)
		//IL_02f6: Unknown result type (might be due to invalid IL or missing references)
		//IL_0321: Unknown result type (might be due to invalid IL or missing references)
		//IL_0330: Unknown result type (might be due to invalid IL or missing references)
		//IL_033f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0358: Unknown result type (might be due to invalid IL or missing references)
		//IL_0383: Unknown result type (might be due to invalid IL or missing references)
		//IL_0392: Unknown result type (might be due to invalid IL or missing references)
		//IL_03a1: Unknown result type (might be due to invalid IL or missing references)
		//IL_03ba: Unknown result type (might be due to invalid IL or missing references)
		//IL_03e5: Unknown result type (might be due to invalid IL or missing references)
		//IL_03f4: Unknown result type (might be due to invalid IL or missing references)
		//IL_0403: Unknown result type (might be due to invalid IL or missing references)
		//IL_041c: Unknown result type (might be due to invalid IL or missing references)
		float num = 375f;
		settingsPanel = panelManager.CreatePanel("Settings", new Vector2(0f, 0.5f), new Vector2(0f, 0.5f), new Vector2(100f, num), 480f, 760f, draggable: false, new Vector2(0f, 1f));
		thrallCustomizationPanel = panelManager.CreatePanel("Thrall Customization", new Vector2(1f, 0.5f), new Vector2(1f, 0.5f), new Vector2(-100f, num), 450f, 880f, draggable: false, new Vector2(1f, 1f));
		taskQueueSubPanel = panelManager.CreateSubPanel(settingsPanel, "Task Queue", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -100f), 430f, 180f, new Vector2(0.5f, 1f));
		keybindsSubPanel = panelManager.CreateSubPanel(settingsPanel, "Keybinds", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -300f), 430f, 260f, new Vector2(0.5f, 1f));
		micInputSubPanel = panelManager.CreateSubPanel(settingsPanel, "Mic Input", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -580f), 430f, 80f, new Vector2(0.5f, 1f));
		egoBannerSubPanel = panelManager.CreateSubPanel(settingsPanel, "Ego Banner", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -680f), 430f, 30f, new Vector2(0.5f, 1f));
		npcNameSubPanel = panelManager.CreateSubPanel(thrallCustomizationPanel, "Name", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -100f), 400f, 80f, new Vector2(0.5f, 1f));
		npcPersonalitySubPanel = panelManager.CreateSubPanel(npcNameSubPanel, "Personality", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -90f), 400f, 250f, new Vector2(0.5f, 1f));
		npcVoiceSubPanel = panelManager.CreateSubPanel(npcPersonalitySubPanel, "Voice", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -260f), 400f, 110f, new Vector2(0.5f, 1f));
		npcBodyTypeSubPanel = panelManager.CreateSubPanel(npcVoiceSubPanel, "Body Type", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -120f), 400f, 100f, new Vector2(0.5f, 1f));
		npcAppearanceSubPanel = panelManager.CreateSubPanel(npcBodyTypeSubPanel, "Appearance", new Vector2(0.5f, 1f), new Vector2(0.5f, 1f), new Vector2(0f, -110f), 400f, 120f, new Vector2(0.5f, 1f));
		CreateScrollableTaskQueue();
		CreateKeyBindings();
		CreateMicInput();
		CreateEgoBanner();
		CreateNameSection();
		CreatePersonalitySection();
		CreateVoiceAndVolumeControls();
		CreateBodyTypeToggle();
		CreateAppearanceSection();
		CreateSaveButton();
	}

	private void CreateScrollableTaskQueue()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_004a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_0076: Unknown result type (might be due to invalid IL or missing references)
		//IL_0093: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = GUIManager.Instance.CreateText("Task Queue", taskQueueSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, MenuSectionTitleFontSize, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		TaskListScrollBox = CreateScrollBox(taskQueueSubPanel, new Vector2(-10f, -10f), 400f, 140f);
	}

	public GameObject CreateScrollBox(GameObject parent, Vector2 position, float width, float height)
	{
		//IL_0006: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Expected O, but got Unknown
		//IL_0038: Unknown result type (might be due to invalid IL or missing references)
		//IL_004e: Unknown result type (might be due to invalid IL or missing references)
		//IL_005a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0065: Unknown result type (might be due to invalid IL or missing references)
		//IL_0075: Unknown result type (might be due to invalid IL or missing references)
		//IL_007b: Expected O, but got Unknown
		//IL_0098: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a5: Unknown result type (might be due to invalid IL or missing references)
		//IL_00bc: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c9: Unknown result type (might be due to invalid IL or missing references)
		//IL_00de: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ff: Unknown result type (might be due to invalid IL or missing references)
		//IL_0106: Expected O, but got Unknown
		//IL_0141: Unknown result type (might be due to invalid IL or missing references)
		//IL_0158: Unknown result type (might be due to invalid IL or missing references)
		//IL_016f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0186: Unknown result type (might be due to invalid IL or missing references)
		//IL_0193: Unknown result type (might be due to invalid IL or missing references)
		//IL_01a8: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b2: Expected O, but got Unknown
		//IL_020b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0212: Expected O, but got Unknown
		//IL_024e: Unknown result type (might be due to invalid IL or missing references)
		//IL_026e: Unknown result type (might be due to invalid IL or missing references)
		//IL_027b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0292: Unknown result type (might be due to invalid IL or missing references)
		//IL_029f: Unknown result type (might be due to invalid IL or missing references)
		//IL_02af: Unknown result type (might be due to invalid IL or missing references)
		//IL_02b6: Expected O, but got Unknown
		//IL_02ea: Unknown result type (might be due to invalid IL or missing references)
		//IL_0300: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = new GameObject("ScrollView");
		val.transform.SetParent(parent.transform, false);
		ScrollRect val2 = val.AddComponent<ScrollRect>();
		RectTransform component = val.GetComponent<RectTransform>();
		component.anchorMin = new Vector2(0.5f, 0.5f);
		component.anchorMax = new Vector2(0.5f, 0.5f);
		component.anchoredPosition = position;
		component.sizeDelta = new Vector2(width, height);
		GameObject val3 = new GameObject("Viewport");
		val3.transform.SetParent(val.transform, false);
		RectTransform val4 = val3.AddComponent<RectTransform>();
		val4.anchorMin = Vector2.zero;
		val4.anchorMax = Vector2.one;
		val4.sizeDelta = new Vector2(-20f, 0f);
		val4.anchoredPosition = Vector2.zero;
		Image val5 = val3.AddComponent<Image>();
		((Graphic)val5).color = Color.white;
		Mask val6 = val3.AddComponent<Mask>();
		val6.showMaskGraphic = false;
		GameObject val7 = new GameObject("Content");
		val7.transform.SetParent(val3.transform, false);
		RectTransform val8 = val7.AddComponent<RectTransform>();
		VerticalLayoutGroup val9 = val7.AddComponent<VerticalLayoutGroup>();
		ContentSizeFitter val10 = val7.AddComponent<ContentSizeFitter>();
		val8.anchorMin = new Vector2(0f, 1f);
		val8.anchorMax = new Vector2(1f, 1f);
		val8.pivot = new Vector2(0f, 1f);
		val8.sizeDelta = new Vector2(0f, 0f);
		val8.anchoredPosition = Vector2.zero;
		((LayoutGroup)val9).padding = new RectOffset(10, 10, 10, 10);
		((HorizontalOrVerticalLayoutGroup)val9).spacing = 10f;
		((LayoutGroup)val9).childAlignment = (TextAnchor)0;
		((HorizontalOrVerticalLayoutGroup)val9).childForceExpandWidth = true;
		((HorizontalOrVerticalLayoutGroup)val9).childControlWidth = true;
		val10.verticalFit = (FitMode)2;
		val2.content = val8;
		val2.viewport = val4;
		val2.horizontal = false;
		val2.vertical = true;
		GameObject val11 = new GameObject("Scrollbar");
		val11.transform.SetParent(val.transform, false);
		Scrollbar val12 = val11.AddComponent<Scrollbar>();
		Image val13 = val11.AddComponent<Image>();
		((Graphic)val13).color = new Color(0.5f, 0.5f, 0.5f, 0.5f);
		RectTransform component2 = val11.GetComponent<RectTransform>();
		component2.anchorMin = new Vector2(1f, 0f);
		component2.anchorMax = Vector2.one;
		component2.sizeDelta = new Vector2(20f, 0f);
		component2.anchoredPosition = Vector2.zero;
		GameObject val14 = new GameObject("Handle");
		val14.transform.SetParent(val11.transform, false);
		Image val15 = val14.AddComponent<Image>();
		((Graphic)val15).color = new Color(0.7f, 0.7f, 0.7f, 0.7f);
		RectTransform component3 = val14.GetComponent<RectTransform>();
		component3.sizeDelta = Vector2.zero;
		val12.handleRect = component3;
		val12.direction = (Direction)2;
		val2.verticalScrollbar = val12;
		return val;
	}

	public void AddItemToScrollBox(GameObject scrollBox, string text, Sprite icon, int index)
	{
		//IL_0042: Unknown result type (might be due to invalid IL or missing references)
		//IL_004c: Expected O, but got Unknown
		//IL_0072: Unknown result type (might be due to invalid IL or missing references)
		//IL_007c: Expected O, but got Unknown
		//IL_00d1: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d8: Expected O, but got Unknown
		//IL_0118: Unknown result type (might be due to invalid IL or missing references)
		//IL_0158: Unknown result type (might be due to invalid IL or missing references)
		//IL_015f: Expected O, but got Unknown
		//IL_01bc: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b5: Unknown result type (might be due to invalid IL or missing references)
		//IL_0213: Unknown result type (might be due to invalid IL or missing references)
		//IL_021a: Expected O, but got Unknown
		//IL_024e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0255: Expected O, but got Unknown
		//IL_0282: Unknown result type (might be due to invalid IL or missing references)
		//IL_02a2: Unknown result type (might be due to invalid IL or missing references)
		//IL_02ef: Unknown result type (might be due to invalid IL or missing references)
		//IL_02f6: Expected O, but got Unknown
		//IL_033f: Unknown result type (might be due to invalid IL or missing references)
		//IL_035e: Unknown result type (might be due to invalid IL or missing references)
		//IL_036b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0378: Unknown result type (might be due to invalid IL or missing references)
		//IL_0391: Unknown result type (might be due to invalid IL or missing references)
		//IL_039b: Expected O, but got Unknown
		Transform val = scrollBox.transform.Find("Viewport/Content");
		if ((Object)(object)val != (Object)null)
		{
			GameObject itemObject = new GameObject("Item");
			itemObject.transform.SetParent(val, false);
			HorizontalLayoutGroup val2 = itemObject.AddComponent<HorizontalLayoutGroup>();
			((LayoutGroup)val2).padding = new RectOffset(5, 5, 5, 5);
			((HorizontalOrVerticalLayoutGroup)val2).spacing = 10f;
			((LayoutGroup)val2).childAlignment = (TextAnchor)3;
			((HorizontalOrVerticalLayoutGroup)val2).childForceExpandWidth = false;
			((HorizontalOrVerticalLayoutGroup)val2).childControlWidth = true;
			LayoutElement val3 = itemObject.AddComponent<LayoutElement>();
			val3.minHeight = 40f;
			val3.flexibleWidth = 1f;
			GameObject val4 = new GameObject("Icon");
			val4.transform.SetParent(itemObject.transform, false);
			Image val5 = val4.AddComponent<Image>();
			val5.sprite = icon;
			RectTransform component = val4.GetComponent<RectTransform>();
			component.sizeDelta = new Vector2(30f, 30f);
			LayoutElement val6 = val4.AddComponent<LayoutElement>();
			val6.minWidth = 30f;
			val6.minHeight = 30f;
			val6.flexibleWidth = 0f;
			GameObject val7 = new GameObject("Text");
			val7.transform.SetParent(itemObject.transform, false);
			Text val8 = val7.AddComponent<Text>();
			val8.text = text;
			val8.font = GUIManager.Instance.AveriaSerifBold;
			val8.fontSize = 17;
			((Graphic)val8).color = ((index == 0) ? Color.white : Color.gray);
			val8.alignment = (TextAnchor)3;
			val8.horizontalOverflow = (HorizontalWrapMode)0;
			val8.verticalOverflow = (VerticalWrapMode)0;
			RectTransform component2 = val7.GetComponent<RectTransform>();
			LayoutElement val9 = val7.AddComponent<LayoutElement>();
			val9.flexibleWidth = 1f;
			val9.minWidth = 0f;
			GameObject val10 = new GameObject("Spacer");
			val10.transform.SetParent(itemObject.transform, false);
			LayoutElement val11 = val10.AddComponent<LayoutElement>();
			val11.flexibleWidth = 1f;
			GameObject val12 = new GameObject("DeleteButton");
			val12.transform.SetParent(itemObject.transform, false);
			Button val13 = val12.AddComponent<Button>();
			Image val14 = val12.AddComponent<Image>();
			((Graphic)val14).color = Color.clear;
			RectTransform component3 = val12.GetComponent<RectTransform>();
			component3.sizeDelta = new Vector2(25f, 25f);
			LayoutElement val15 = val12.AddComponent<LayoutElement>();
			val15.minWidth = 25f;
			val15.minHeight = 25f;
			val15.flexibleWidth = 0f;
			val15.preferredWidth = 25f;
			GameObject val16 = new GameObject("ButtonText");
			val16.transform.SetParent(val12.transform, false);
			Text val17 = val16.AddComponent<Text>();
			val17.text = "X";
			val17.font = Resources.GetBuiltinResource<Font>("Arial.ttf");
			val17.fontSize = 18;
			((Graphic)val17).color = Color.white;
			val17.alignment = (TextAnchor)4;
			RectTransform component4 = val16.GetComponent<RectTransform>();
			component4.anchorMin = Vector2.zero;
			component4.anchorMax = Vector2.one;
			component4.sizeDelta = Vector2.zero;
			((UnityEvent)val13.onClick).AddListener((UnityAction)delegate
			{
				Object.Destroy((Object)(object)itemObject);
				LogMessage($"Removing npc command [{index}]");
				instance.commandManager.RemoveCommand(index);
				instance.RefreshTaskList();
			});
			CollectionExtensions.AddItem<GameObject>((IEnumerable<GameObject>)TasksList, itemObject);
		}
	}

	public void DeleteAllTasks()
	{
		//IL_0033: Unknown result type (might be due to invalid IL or missing references)
		//IL_0039: Expected O, but got Unknown
		Transform val = TaskListScrollBox.transform.Find("Viewport/Content");
		if (!((Object)(object)val != (Object)null))
		{
			return;
		}
		foreach (Transform item in val)
		{
			Transform val2 = item;
			Object.Destroy((Object)(object)((Component)val2).gameObject);
		}
	}

	public void RefreshTaskList()
	{
		//IL_0021: Unknown result type (might be due to invalid IL or missing references)
		//IL_0026: Unknown result type (might be due to invalid IL or missing references)
		//IL_0030: Unknown result type (might be due to invalid IL or missing references)
		DeleteAllTasks();
		Sprite icon = Sprite.Create(Texture2D.whiteTexture, new Rect(0f, 0f, 1f, 1f), Vector2.one * 0.5f);
		int num = 0;
		foreach (NPCCommand allCommand in instance.commandManager.GetAllCommands())
		{
			if (allCommand is HarvestAction)
			{
				HarvestAction harvestAction = (HarvestAction)allCommand;
				AddItemToScrollBox(TaskListScrollBox, $"Gathering {harvestAction.ResourceName} ({harvestAction.RequiredAmount})", icon, num);
			}
			if (allCommand is PatrolAction)
			{
				PatrolAction patrolAction = (PatrolAction)allCommand;
				AddItemToScrollBox(TaskListScrollBox, "Patrolling area: " + ((object)(Vector3)(ref patrolAction.patrol_position)).ToString(), icon, num);
			}
			if (allCommand is AttackAction)
			{
				AttackAction attackAction = (AttackAction)allCommand;
				AddItemToScrollBox(TaskListScrollBox, $"Attacking: {attackAction.TargetName} ({attackAction.TargetQuantity})", icon, num);
			}
			if (allCommand is FollowAction)
			{
				AddItemToScrollBox(TaskListScrollBox, "Following Player", icon, num);
			}
			num++;
		}
	}

	private IEnumerator ListenForNewKeybind(int keybindIndex)
	{
		yield return (object)new WaitForSeconds(0.1f);
		while (true)
		{
			foreach (KeyCode value in Enum.GetValues(typeof(KeyCode)))
			{
				KeyCode keyCode = value;
				if (!ZInput.GetKeyDown(keyCode, false))
				{
					continue;
				}
				bool flag = false;
				foreach (ConfigEntry<KeyCode> entry in allKeybinds)
				{
					if (entry.Value == keyCode)
					{
						LogError($"{((object)(KeyCode)(ref keyCode)).ToString()} is already used for {((ConfigEntryBase)entry).Definition}!");
						flag = true;
						yield return null;
					}
				}
				if (!flag)
				{
					allKeybinds[keybindIndex].Value = keyCode;
					LogWarning($"Keybind for {((ConfigEntryBase)allKeybinds[keybindIndex]).Definition} set to Key: {((object)(KeyCode)(ref keyCode)).ToString()}");
				}
				RefreshKeyBindings();
				yield break;
			}
			yield return null;
		}
	}

	private void RefreshKeyBindings()
	{
		//IL_001b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0021: Expected O, but got Unknown
		foreach (Transform item in keybindsSubPanel.transform)
		{
			Transform val = item;
			Object.Destroy((Object)(object)((Component)val).gameObject);
		}
		editButtons.Clear();
		CreateKeyBindings();
	}

	private void CreateKeyBindings()
	{
		//IL_0014: Unknown result type (might be due to invalid IL or missing references)
		//IL_0019: Unknown result type (might be due to invalid IL or missing references)
		//IL_003f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0044: Unknown result type (might be due to invalid IL or missing references)
		//IL_006a: Unknown result type (might be due to invalid IL or missing references)
		//IL_006f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0095: Unknown result type (might be due to invalid IL or missing references)
		//IL_009a: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c5: Unknown result type (might be due to invalid IL or missing references)
		//IL_00eb: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f0: Unknown result type (might be due to invalid IL or missing references)
		//IL_0116: Unknown result type (might be due to invalid IL or missing references)
		//IL_011b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0193: Unknown result type (might be due to invalid IL or missing references)
		//IL_01a2: Unknown result type (might be due to invalid IL or missing references)
		//IL_01a8: Unknown result type (might be due to invalid IL or missing references)
		//IL_01bd: Unknown result type (might be due to invalid IL or missing references)
		//IL_01c3: Unknown result type (might be due to invalid IL or missing references)
		//IL_01e9: Unknown result type (might be due to invalid IL or missing references)
		//IL_021d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0224: Expected O, but got Unknown
		//IL_024d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0264: Unknown result type (might be due to invalid IL or missing references)
		//IL_0282: Unknown result type (might be due to invalid IL or missing references)
		//IL_0299: Unknown result type (might be due to invalid IL or missing references)
		//IL_02be: Unknown result type (might be due to invalid IL or missing references)
		//IL_02cd: Unknown result type (might be due to invalid IL or missing references)
		//IL_02d2: Unknown result type (might be due to invalid IL or missing references)
		//IL_02e8: Unknown result type (might be due to invalid IL or missing references)
		//IL_02ee: Unknown result type (might be due to invalid IL or missing references)
		//IL_031f: Unknown result type (might be due to invalid IL or missing references)
		//IL_032e: Unknown result type (might be due to invalid IL or missing references)
		//IL_033d: Unknown result type (might be due to invalid IL or missing references)
		//IL_034e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0354: Unknown result type (might be due to invalid IL or missing references)
		//IL_0380: Unknown result type (might be due to invalid IL or missing references)
		//IL_038d: Unknown result type (might be due to invalid IL or missing references)
		//IL_03ad: Unknown result type (might be due to invalid IL or missing references)
		//IL_03d3: Unknown result type (might be due to invalid IL or missing references)
		//IL_03e2: Unknown result type (might be due to invalid IL or missing references)
		//IL_03f1: Unknown result type (might be due to invalid IL or missing references)
		//IL_041c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0433: Unknown result type (might be due to invalid IL or missing references)
		//IL_045f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0469: Expected O, but got Unknown
		string[] array = new string[7];
		KeyCode value = spawnKey.Value;
		array[0] = "[" + ((object)(KeyCode)(ref value)).ToString() + "]";
		value = harvestKey.Value;
		array[1] = "[" + ((object)(KeyCode)(ref value)).ToString() + "]";
		value = followKey.Value;
		array[2] = "[" + ((object)(KeyCode)(ref value)).ToString() + "]";
		value = inventoryKey.Value;
		array[3] = "[" + ((object)(KeyCode)(ref value)).ToString() + "]";
		value = talkKey.Value;
		array[4] = "[" + ((object)(KeyCode)(ref value)).ToString() + "]";
		value = thrallMenuKey.Value;
		array[5] = "[" + ((object)(KeyCode)(ref value)).ToString() + "]";
		value = combatModeKey.Value;
		array[6] = "[" + ((object)(KeyCode)(ref value)).ToString() + "]";
		string[] array2 = array;
		string[] array3 = new string[7] { "Spawn/Dismiss", "Harvest", "Follow/Patrol", "Inventory", "Push To Talk", "Thrall Menu", "Switch Combat Mode" };
		GameObject val = GUIManager.Instance.CreateText("Keybinds", keybindsSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, MenuSectionTitleFontSize, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		for (int i = 0; i < array2.Length; i++)
		{
			GameObject val2 = new GameObject($"KeybindRow_{i}");
			RectTransform val3 = val2.AddComponent<RectTransform>();
			((Transform)val3).SetParent(keybindsSubPanel.transform, false);
			val3.anchorMin = new Vector2(0f, 1f);
			val3.anchorMax = new Vector2(1f, 1f);
			val3.anchoredPosition = new Vector2(10f, -60f - (float)(i * 30));
			val3.sizeDelta = new Vector2(0f, 30f);
			GameObject val4 = GUIManager.Instance.CreateText(array2[i], val2.transform, new Vector2(0f, 0f), new Vector2(1f, 1f), Vector2.zero, GUIManager.Instance.AveriaSerif, 20, GUIManager.Instance.ValheimYellow, true, Color.black, 300f, 30f, false);
			GameObject val5 = GUIManager.Instance.CreateText(array3[i], val2.transform, new Vector2(0f, 0f), new Vector2(1f, 1f), new Vector2(35f, 0f), GUIManager.Instance.AveriaSerif, 20, Color.white, true, Color.black, 300f, 30f, false);
			RectTransform component = val4.GetComponent<RectTransform>();
			component.pivot = new Vector2(0f, 1f);
			component.anchoredPosition = Vector2.zero;
			RectTransform component2 = val5.GetComponent<RectTransform>();
			component2.pivot = new Vector2(0f, 1f);
			GameObject val6 = GUIManager.Instance.CreateButton("Edit", val2.transform, new Vector2(1f, 0f), new Vector2(1f, 1f), new Vector2(-5f, 0f), 60f, 25f);
			RectTransform component3 = val6.GetComponent<RectTransform>();
			component3.pivot = new Vector2(1f, 1f);
			component3.anchoredPosition = new Vector2(-20f, 0f);
			Button component4 = val6.GetComponent<Button>();
			int index = i;
			((UnityEvent)component4.onClick).AddListener((UnityAction)delegate
			{
				OnEditKeybind(index);
			});
			editButtons.Add(component4);
		}
	}

	private void OnEditKeybind(int index)
	{
		foreach (Button editButton in editButtons)
		{
			((Selectable)editButton).interactable = false;
		}
		if (allKeybinds.Count >= 0 && allKeybinds.Count > index)
		{
			LogInfo("Waiting for new keybind...");
			((MonoBehaviour)this).StartCoroutine(ListenForNewKeybind(index));
		}
	}

	private void CreateMicInput()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_0046: Unknown result type (might be due to invalid IL or missing references)
		//IL_004c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0072: Unknown result type (might be due to invalid IL or missing references)
		//IL_0097: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a6: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b5: Unknown result type (might be due to invalid IL or missing references)
		//IL_0118: Unknown result type (might be due to invalid IL or missing references)
		//IL_012e: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = GUIManager.Instance.CreateText("Mic Input", micInputSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, 26, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		GameObject val2 = GUIManager.Instance.CreateDropDown(micInputSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(0f, 0f), 16, 280f, 30f);
		micDropdownComp = val2.GetComponent<Dropdown>();
		List<string> list = (from option in Microphone.devices.ToList()
			select TruncateText(option, 27)).ToList();
		micDropdownComp.AddOptions(list);
		RectTransform component = val2.GetComponent<RectTransform>();
		component.pivot = new Vector2(0f, 1f);
		component.anchoredPosition = new Vector2(10f, -40f);
		((UnityEvent<int>)(object)micDropdownComp.onValueChanged).AddListener((UnityAction<int>)OnMicInputDropdownChanged);
	}

	private string TruncateText(string text, int maxLength)
	{
		if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
		{
			return text;
		}
		return text.Substring(0, maxLength - 3) + "...";
	}

	private void OnMicInputDropdownChanged(int index)
	{
		instance.MicrophoneIndex = index;
		LogWarning("New microphone picked: " + Microphone.devices[index]);
	}

	private void CreateEgoBanner()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_003e: Unknown result type (might be due to invalid IL or missing references)
		//IL_004f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0055: Unknown result type (might be due to invalid IL or missing references)
		//IL_007d: Unknown result type (might be due to invalid IL or missing references)
		//IL_008f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0095: Expected O, but got Unknown
		//IL_0097: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = GUIManager.Instance.CreateText("ego.ai's Discord Server", egoBannerSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(10f, -2f), GUIManager.Instance.AveriaSerifBold, 22, Color.white, true, Color.blue, 350f, 40f, false);
		RectTransform component = val.GetComponent<RectTransform>();
		component.pivot = new Vector2(0f, 1f);
		EventTrigger val2 = val.AddComponent<EventTrigger>();
		Entry val3 = new Entry();
		val3.eventID = (EventTriggerType)4;
		((UnityEvent<BaseEventData>)(object)val3.callback).AddListener((UnityAction<BaseEventData>)delegate
		{
			OnClickEgoBanner();
		});
		val2.triggers.Add(val3);
	}

	private void OnClickEgoBanner()
	{
		string text = "https://discord.gg/egoai";
		Application.OpenURL(text);
		LogInfo("Ego discord url clicked!");
	}

	private void CreateNameSection()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_004e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0054: Unknown result type (might be due to invalid IL or missing references)
		//IL_007a: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = GUIManager.Instance.CreateText("Name", npcNameSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, instance.MenuSectionTitleFontSize, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		CreateNameInputField(npcNameSubPanel.transform, "Bilbo");
	}

	public void CreateNameInputField(Transform parent, string placeholder, int fontSize = 18, int width = 380, int height = 30)
	{
		//IL_0006: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Expected O, but got Unknown
		//IL_0036: Unknown result type (might be due to invalid IL or missing references)
		//IL_008a: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b6: Expected O, but got Unknown
		//IL_010b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0121: Unknown result type (might be due to invalid IL or missing references)
		//IL_012e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0145: Unknown result type (might be due to invalid IL or missing references)
		//IL_015c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0173: Unknown result type (might be due to invalid IL or missing references)
		//IL_0183: Unknown result type (might be due to invalid IL or missing references)
		//IL_018a: Expected O, but got Unknown
		//IL_01c4: Unknown result type (might be due to invalid IL or missing references)
		//IL_01da: Unknown result type (might be due to invalid IL or missing references)
		//IL_01e7: Unknown result type (might be due to invalid IL or missing references)
		//IL_01fe: Unknown result type (might be due to invalid IL or missing references)
		//IL_0215: Unknown result type (might be due to invalid IL or missing references)
		//IL_022c: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = new GameObject("CustomInputField");
		val.transform.SetParent(parent, false);
		Image val2 = val.AddComponent<Image>();
		((Graphic)val2).color = new Color(0.7f, 0.7f, 0.7f, 0.3f);
		nameInputField = val.AddComponent<InputField>();
		nameInputField.lineType = (LineType)0;
		((UnityEvent<string>)(object)nameInputField.onValueChanged).AddListener((UnityAction<string>)OnNPCNameChanged);
		RectTransform component = ((Component)nameInputField).GetComponent<RectTransform>();
		component.sizeDelta = new Vector2((float)width, (float)height);
		component.anchoredPosition = new Vector2(0f, -15f);
		GameObject val3 = new GameObject("Placeholder");
		val3.transform.SetParent(val.transform, false);
		Text val4 = val3.AddComponent<Text>();
		val4.text = placeholder;
		val4.font = GUIManager.Instance.AveriaSerifBold;
		val4.fontSize = fontSize;
		((Graphic)val4).color = new Color(0.7f, 0.7f, 0.7f, 0.5f);
		RectTransform component2 = ((Component)val4).GetComponent<RectTransform>();
		component2.anchorMin = Vector2.zero;
		component2.anchorMax = Vector2.one;
		component2.offsetMin = new Vector2(10f, 0f);
		component2.offsetMax = new Vector2(-10f, 0f);
		component2.anchoredPosition = new Vector2(0f, -4f);
		GameObject val5 = new GameObject("Text");
		val5.transform.SetParent(val.transform, false);
		Text val6 = val5.AddComponent<Text>();
		val6.font = GUIManager.Instance.AveriaSerifBold;
		val6.fontSize = fontSize;
		((Graphic)val6).color = Color.white;
		RectTransform component3 = ((Component)val6).GetComponent<RectTransform>();
		component3.anchorMin = Vector2.zero;
		component3.anchorMax = Vector2.one;
		component3.offsetMin = new Vector2(10f, 0f);
		component3.offsetMax = new Vector2(-10f, 0f);
		component3.anchoredPosition = new Vector2(0f, -4f);
		nameInputField.placeholder = (Graphic)(object)val4;
		nameInputField.textComponent = val6;
	}

	private void OnNPCNameChanged(string newValue)
	{
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			instance.npcName = newValue;
			HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
			((Character)component).m_name = newValue;
			nameInputField.SetTextWithoutNotify(newValue);
		}
	}

	private void CreatePersonalitySection()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_004e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0054: Unknown result type (might be due to invalid IL or missing references)
		//IL_007c: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a1: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00bf: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e8: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = GUIManager.Instance.CreateText("Personality", npcPersonalitySubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, instance.MenuSectionTitleFontSize, Color.white, true, Color.black, 350f, 40f, false);
		RectTransform component = val.GetComponent<RectTransform>();
		component.pivot = new Vector2(0f, 1f);
		GameObject val2 = GUIManager.Instance.CreateDropDown(npcPersonalitySubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(10f, -40f), 20, 300f, 30f);
		component = val2.GetComponent<RectTransform>();
		component.pivot = new Vector2(0f, 1f);
		instance.personalityDropdownComp = val2.GetComponent<Dropdown>();
		instance.personalityDropdownComp.AddOptions(npcPersonalities);
		((UnityEvent<int>)(object)instance.personalityDropdownComp.onValueChanged).AddListener((UnityAction<int>)OnNPCPersonalityDropdownChanged);
		CreateMultilineInputField(npcPersonalitySubPanel.transform, "She's strong, stoic, tomboyish, confident and serious...", 14);
	}

	private void OnNPCPersonalityDropdownChanged(int index)
	{
		instance.npcPersonalityIndex = index;
		if (index < npcPersonalities.Count - 1)
		{
			instance.npcPersonality = npcPersonalitiesMap[npcPersonalities[index]];
			instance.personalityInputField.SetTextWithoutNotify(npcPersonalitiesMap[npcPersonalities[index]]);
			if (Object.op_Implicit((Object)(object)PlayerNPC))
			{
				instance.OnNPCNameChanged(npcPersonalities[index]);
			}
		}
		LogInfo("New NPCPersonality picked from dropdown: " + npcPersonalities[instance.npcPersonalityIndex]);
	}

	public void CreateMultilineInputField(Transform parent, string placeholder, int fontSize = 16, int width = 380, int height = 150)
	{
		//IL_0006: Unknown result type (might be due to invalid IL or missing references)
		//IL_000c: Expected O, but got Unknown
		//IL_0036: Unknown result type (might be due to invalid IL or missing references)
		//IL_008a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0097: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ab: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c6: Expected O, but got Unknown
		//IL_011b: Unknown result type (might be due to invalid IL or missing references)
		//IL_013b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0152: Unknown result type (might be due to invalid IL or missing references)
		//IL_0169: Unknown result type (might be due to invalid IL or missing references)
		//IL_0180: Unknown result type (might be due to invalid IL or missing references)
		//IL_0190: Unknown result type (might be due to invalid IL or missing references)
		//IL_0197: Expected O, but got Unknown
		//IL_01d1: Unknown result type (might be due to invalid IL or missing references)
		//IL_01f1: Unknown result type (might be due to invalid IL or missing references)
		//IL_0208: Unknown result type (might be due to invalid IL or missing references)
		//IL_021f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0236: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = new GameObject("CustomInputField");
		val.transform.SetParent(parent, false);
		Image val2 = val.AddComponent<Image>();
		((Graphic)val2).color = new Color(0.7f, 0.7f, 0.7f, 0.3f);
		personalityInputField = val.AddComponent<InputField>();
		personalityInputField.lineType = (LineType)2;
		((UnityEvent<string>)(object)personalityInputField.onValueChanged).AddListener((UnityAction<string>)OnPersonalityTextChanged);
		RectTransform component = ((Component)personalityInputField).GetComponent<RectTransform>();
		component.sizeDelta = new Vector2((float)width, (float)height);
		((Transform)component).position = ((Transform)component).position + new Vector3(0f, -40f, 0f);
		GameObject val3 = new GameObject("Placeholder");
		val3.transform.SetParent(val.transform, false);
		Text val4 = val3.AddComponent<Text>();
		val4.text = placeholder;
		val4.font = GUIManager.Instance.AveriaSerifBold;
		val4.fontSize = fontSize;
		((Graphic)val4).color = new Color(0.7f, 0.7f, 0.7f, 0.5f);
		RectTransform component2 = ((Component)val4).GetComponent<RectTransform>();
		component2.anchorMin = new Vector2(0f, 0f);
		component2.anchorMax = new Vector2(1f, 1f);
		component2.offsetMin = new Vector2(10f, 10f);
		component2.offsetMax = new Vector2(-10f, -10f);
		GameObject val5 = new GameObject("Text");
		val5.transform.SetParent(val.transform, false);
		Text val6 = val5.AddComponent<Text>();
		val6.font = GUIManager.Instance.AveriaSerifBold;
		val6.fontSize = fontSize;
		((Graphic)val6).color = Color.white;
		RectTransform component3 = ((Component)val6).GetComponent<RectTransform>();
		component3.anchorMin = new Vector2(0f, 0f);
		component3.anchorMax = new Vector2(1f, 1f);
		component3.offsetMin = new Vector2(10f, 10f);
		component3.offsetMax = new Vector2(-10f, -10f);
		personalityInputField.placeholder = (Graphic)(object)val4;
		personalityInputField.textComponent = val6;
	}

	private void OnPersonalityTextChanged(string newText)
	{
		instance.personalityDropdownComp.SetValueWithoutNotify(npcPersonalities.Count - 1);
		instance.npcPersonality = newText;
	}

	private void CreateVoiceAndVolumeControls()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_004a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_0076: Unknown result type (might be due to invalid IL or missing references)
		//IL_009b: Unknown result type (might be due to invalid IL or missing references)
		//IL_00aa: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b9: Unknown result type (might be due to invalid IL or missing references)
		//IL_0135: Unknown result type (might be due to invalid IL or missing references)
		//IL_0144: Unknown result type (might be due to invalid IL or missing references)
		//IL_0153: Unknown result type (might be due to invalid IL or missing references)
		//IL_0185: Unknown result type (might be due to invalid IL or missing references)
		//IL_01bf: Unknown result type (might be due to invalid IL or missing references)
		//IL_01c9: Expected O, but got Unknown
		//IL_01e9: Unknown result type (might be due to invalid IL or missing references)
		//IL_01f8: Unknown result type (might be due to invalid IL or missing references)
		//IL_0207: Unknown result type (might be due to invalid IL or missing references)
		//IL_0218: Unknown result type (might be due to invalid IL or missing references)
		//IL_021e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0244: Unknown result type (might be due to invalid IL or missing references)
		//IL_0265: Unknown result type (might be due to invalid IL or missing references)
		//IL_0274: Unknown result type (might be due to invalid IL or missing references)
		//IL_0283: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = GUIManager.Instance.CreateText("Voice", npcVoiceSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, MenuSectionTitleFontSize, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		GameObject val2 = GUIManager.Instance.CreateDropDown(npcVoiceSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(110f, -50f), 20, 200f, 30f);
		instance.voiceDropdownComp = val2.GetComponent<Dropdown>();
		instance.voiceDropdownComp.AddOptions(npcVoices);
		((UnityEvent<int>)(object)instance.voiceDropdownComp.onValueChanged).AddListener((UnityAction<int>)OnNPCVoiceDropdownChanged);
		instance.previewVoiceButton = GUIManager.Instance.CreateButton("Preview", val2.transform, new Vector2(0.5f, 0f), new Vector2(0.5f, 0f), new Vector2(190f, 0f), 100f, 30f);
		instance.previewVoiceButton.GetComponent<RectTransform>().pivot = new Vector2(0.5f, 0f);
		instance.previewVoiceButtonComp = instance.previewVoiceButton.GetComponent<Button>();
		((UnityEvent)instance.previewVoiceButtonComp.onClick).AddListener((UnityAction)delegate
		{
			OnPreviewVoiceButtonClick(instance.previewVoiceButtonComp);
		});
		val = GUIManager.Instance.CreateText("Volume", npcVoiceSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(10f, -75f), GUIManager.Instance.AveriaSerifBold, 20, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		Slider val3 = CreateSlider(npcVoiceSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(230f, -87.5f), 250f, 15f);
		instance.volumeSliderComp = ((Component)val3).GetComponent<Slider>();
		((UnityEvent<float>)(object)instance.volumeSliderComp.onValueChanged).AddListener((UnityAction<float>)OnVolumeSliderValueChanged);
	}

	private void CreatePreviewVoiceButton()
	{
	}

	private void OnPreviewVoiceButtonClick(Button button)
	{
		instance.BrainSynthesizeAudio("Hello, I am your friend sent by the team at Ego", npcVoices[instance.npcVoice].ToLower());
		SetPreviewVoiceButtonState(button, interactable: false, 0.5f);
	}

	private void SetPreviewVoiceButtonState(Button button, bool interactable, float opacity)
	{
		//IL_001d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0022: Unknown result type (might be due to invalid IL or missing references)
		//IL_002c: Unknown result type (might be due to invalid IL or missing references)
		//IL_004a: Unknown result type (might be due to invalid IL or missing references)
		//IL_004f: Unknown result type (might be due to invalid IL or missing references)
		//IL_005a: Unknown result type (might be due to invalid IL or missing references)
		((Selectable)button).interactable = interactable;
		Image component = ((Component)button).GetComponent<Image>();
		if ((Object)(object)component != (Object)null)
		{
			Color color = ((Graphic)component).color;
			color.a = opacity;
			((Graphic)component).color = color;
		}
		Text componentInChildren = ((Component)button).GetComponentInChildren<Text>();
		if ((Object)(object)componentInChildren != (Object)null)
		{
			Color color2 = ((Graphic)componentInChildren).color;
			color2.a = opacity;
			((Graphic)componentInChildren).color = color2;
		}
	}

	private void OnNPCVoiceDropdownChanged(int index)
	{
		instance.npcVoice = index;
		LogInfo("New NPCVoice picked: " + npcVoices[instance.npcVoice]);
	}

	private void OnVolumeSliderValueChanged(float value)
	{
		instance.npcVolume = value;
	}

	private void CreateBodyTypeToggle()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_004a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_0076: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = GUIManager.Instance.CreateText("Body Type", npcBodyTypeSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, MenuSectionTitleFontSize, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		GameObject val2 = CreateToggle(npcBodyTypeSubPanel.transform, "Masculine", "Masculine", -20f);
		GameObject val3 = CreateToggle(npcBodyTypeSubPanel.transform, "Feminine", "Feminine", -50f);
		instance.toggleMasculine = val2.GetComponent<Toggle>();
		instance.toggleFeminine = val3.GetComponent<Toggle>();
		instance.toggleMasculine.isOn = true;
		((UnityEvent<bool>)(object)instance.toggleMasculine.onValueChanged).AddListener((UnityAction<bool>)delegate(bool isOn)
		{
			OnBodyTypeToggleChanged(instance.toggleMasculine, instance.toggleFeminine, isOn);
		});
		((UnityEvent<bool>)(object)instance.toggleFeminine.onValueChanged).AddListener((UnityAction<bool>)delegate(bool isOn)
		{
			OnBodyTypeToggleChanged(instance.toggleFeminine, instance.toggleMasculine, isOn);
		});
	}

	private void OnBodyTypeToggleChanged(Toggle changedToggle, Toggle otherToggle, bool isOn)
	{
		if (isOn && otherToggle.isOn)
		{
			otherToggle.isOn = false;
		}
		instance.npcGender = ((!(((Object)changedToggle).name == "Masculine")) ? 1 : 0);
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			VisEquipment component = PlayerNPC.GetComponent<VisEquipment>();
			component.SetModel(instance.npcGender);
		}
		LogInfo("New NPCGender picked: " + ((Object)changedToggle).name);
	}

	private void CreateAppearanceSection()
	{
		//IL_0020: Unknown result type (might be due to invalid IL or missing references)
		//IL_002f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_004a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_0076: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a0: Unknown result type (might be due to invalid IL or missing references)
		//IL_00af: Unknown result type (might be due to invalid IL or missing references)
		//IL_00be: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e3: Unknown result type (might be due to invalid IL or missing references)
		//IL_0108: Unknown result type (might be due to invalid IL or missing references)
		//IL_0117: Unknown result type (might be due to invalid IL or missing references)
		//IL_0126: Unknown result type (might be due to invalid IL or missing references)
		//IL_0137: Unknown result type (might be due to invalid IL or missing references)
		//IL_013d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0163: Unknown result type (might be due to invalid IL or missing references)
		//IL_0180: Unknown result type (might be due to invalid IL or missing references)
		//IL_018a: Expected O, but got Unknown
		//IL_01aa: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b9: Unknown result type (might be due to invalid IL or missing references)
		//IL_01c8: Unknown result type (might be due to invalid IL or missing references)
		//IL_01ed: Unknown result type (might be due to invalid IL or missing references)
		//IL_0212: Unknown result type (might be due to invalid IL or missing references)
		//IL_0221: Unknown result type (might be due to invalid IL or missing references)
		//IL_0230: Unknown result type (might be due to invalid IL or missing references)
		//IL_0241: Unknown result type (might be due to invalid IL or missing references)
		//IL_0247: Unknown result type (might be due to invalid IL or missing references)
		//IL_026f: Unknown result type (might be due to invalid IL or missing references)
		//IL_028c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0296: Expected O, but got Unknown
		GameObject val = GUIManager.Instance.CreateText("Appearance", npcAppearanceSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), MenuSectionTitlePosition, GUIManager.Instance.AveriaSerifBold, MenuSectionTitleFontSize, Color.white, true, Color.black, 350f, 40f, false);
		val.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		GameObject val2 = GUIManager.Instance.CreateButton("", npcAppearanceSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(10f, -40f), 50f, 30f);
		val2.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		GameObject val3 = GUIManager.Instance.CreateText("Skin Tone", val2.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(60f, -3f), GUIManager.Instance.AveriaSerifBold, 20, Color.white, true, Color.black, 350f, 40f, false);
		val3.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		((UnityEvent)val2.GetComponent<Button>().onClick).AddListener(new UnityAction(CreateSkinColorPicker));
		GameObject val4 = GUIManager.Instance.CreateButton("", npcAppearanceSubPanel.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(10f, -80f), 50f, 30f);
		val4.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		GameObject val5 = GUIManager.Instance.CreateText("Hair Color", val4.transform, new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(60f, -3f), GUIManager.Instance.AveriaSerifBold, 20, Color.white, true, Color.black, 350f, 40f, false);
		val5.GetComponent<RectTransform>().pivot = new Vector2(0f, 1f);
		((UnityEvent)val4.GetComponent<Button>().onClick).AddListener(new UnityAction(CreateHairColorPicker));
	}

	private void CreateSkinColorPicker()
	{
		//IL_0010: Unknown result type (might be due to invalid IL or missing references)
		//IL_001f: Unknown result type (might be due to invalid IL or missing references)
		//IL_002e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0033: Unknown result type (might be due to invalid IL or missing references)
		//IL_0044: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_005b: Expected O, but got Unknown
		//IL_005b: Expected O, but got Unknown
		GUIManager.Instance.CreateColorPicker(new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(500f, -500f), Color.yellow, "Skin Tone", new ColorEvent(OnSkinColorChanged), new ColorEvent(OnSkinColorSelected), false);
	}

	private void OnSkinColorChanged(Color changedColor)
	{
		//IL_0052: Unknown result type (might be due to invalid IL or missing references)
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
			((Humanoid)component).m_visEquipment.SetSkinColor(new Vector3(instance.skinColor.r, instance.skinColor.g, instance.skinColor.b));
		}
	}

	private void OnSkinColorSelected(Color selectedColor)
	{
		//IL_0019: Unknown result type (might be due to invalid IL or missing references)
		//IL_001a: Unknown result type (might be due to invalid IL or missing references)
		//IL_005d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0072: Unknown result type (might be due to invalid IL or missing references)
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			instance.skinColor = selectedColor;
			HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
			((Humanoid)component).m_visEquipment.SetSkinColor(new Vector3(instance.skinColor.r, instance.skinColor.g, instance.skinColor.b));
			LogInfo($"Selected color: {instance.skinColor}");
		}
	}

	private void CreateHairColorPicker()
	{
		//IL_0010: Unknown result type (might be due to invalid IL or missing references)
		//IL_001f: Unknown result type (might be due to invalid IL or missing references)
		//IL_002e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0033: Unknown result type (might be due to invalid IL or missing references)
		//IL_0044: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_005b: Expected O, but got Unknown
		//IL_005b: Expected O, but got Unknown
		GUIManager.Instance.CreateColorPicker(new Vector2(0f, 1f), new Vector2(0f, 1f), new Vector2(500f, -500f), Color.yellow, "Hair Color", new ColorEvent(OnHairColorChanged), new ColorEvent(OnHairColorSelected), false);
	}

	private void OnHairColorChanged(Color changedColor)
	{
		//IL_0052: Unknown result type (might be due to invalid IL or missing references)
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
			((Humanoid)component).m_visEquipment.SetHairColor(new Vector3(instance.hairColor.r, instance.hairColor.g, instance.hairColor.b));
		}
	}

	private void OnHairColorSelected(Color selectedColor)
	{
		//IL_0019: Unknown result type (might be due to invalid IL or missing references)
		//IL_001a: Unknown result type (might be due to invalid IL or missing references)
		//IL_005d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0072: Unknown result type (might be due to invalid IL or missing references)
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			instance.hairColor = selectedColor;
			HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
			((Humanoid)component).m_visEquipment.SetHairColor(new Vector3(instance.hairColor.r, instance.hairColor.g, instance.hairColor.b));
			LogInfo($"Selected color: {instance.hairColor}");
		}
	}

	private void CreateSaveButton()
	{
		//IL_002d: Unknown result type (might be due to invalid IL or missing references)
		//IL_003c: Unknown result type (might be due to invalid IL or missing references)
		//IL_004b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0070: Unknown result type (might be due to invalid IL or missing references)
		//IL_0099: Unknown result type (might be due to invalid IL or missing references)
		//IL_00a3: Expected O, but got Unknown
		GameObject val = GUIManager.Instance.CreateButton("SAVE", thrallCustomizationPanel.transform, new Vector2(0.5f, 0f), new Vector2(0.5f, 0f), new Vector2(0f, 25f), 250f, 40f);
		val.GetComponent<RectTransform>().pivot = new Vector2(0.5f, 0f);
		Button saveButtonComp = val.GetComponent<Button>();
		((UnityEvent)saveButtonComp.onClick).AddListener((UnityAction)delegate
		{
			OnSaveButtonClick(saveButtonComp);
		});
	}

	private void OnSaveButtonClick(Button button)
	{
		instance.panelManager.TogglePanel("Settings");
		instance.panelManager.TogglePanel("Thrall Customization");
		IsModMenuShowing = false;
		GUIManager.BlockInput(false);
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			SaveNPCData(PlayerNPC);
		}
	}

	private Slider CreateSlider(Transform parent, Vector2 anchorMin, Vector2 anchorMax, Vector2 position, float width, float height)
	{
		//IL_0019: Unknown result type (might be due to invalid IL or missing references)
		//IL_001f: Expected O, but got Unknown
		//IL_0035: Unknown result type (might be due to invalid IL or missing references)
		//IL_003d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0045: Unknown result type (might be due to invalid IL or missing references)
		//IL_0052: Unknown result type (might be due to invalid IL or missing references)
		//IL_0068: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c3: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c9: Expected O, but got Unknown
		//IL_00f1: Unknown result type (might be due to invalid IL or missing references)
		//IL_0106: Unknown result type (might be due to invalid IL or missing references)
		//IL_0113: Unknown result type (might be due to invalid IL or missing references)
		//IL_0120: Unknown result type (might be due to invalid IL or missing references)
		//IL_0143: Unknown result type (might be due to invalid IL or missing references)
		//IL_014a: Expected O, but got Unknown
		//IL_0173: Unknown result type (might be due to invalid IL or missing references)
		//IL_018a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0197: Unknown result type (might be due to invalid IL or missing references)
		//IL_01c7: Unknown result type (might be due to invalid IL or missing references)
		//IL_01ce: Expected O, but got Unknown
		//IL_01f9: Unknown result type (might be due to invalid IL or missing references)
		//IL_020f: Unknown result type (might be due to invalid IL or missing references)
		//IL_021c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0229: Unknown result type (might be due to invalid IL or missing references)
		//IL_024c: Unknown result type (might be due to invalid IL or missing references)
		//IL_0253: Expected O, but got Unknown
		//IL_0272: Unknown result type (might be due to invalid IL or missing references)
		//IL_027f: Unknown result type (might be due to invalid IL or missing references)
		//IL_028c: Unknown result type (might be due to invalid IL or missing references)
		//IL_02bc: Unknown result type (might be due to invalid IL or missing references)
		//IL_02c3: Expected O, but got Unknown
		//IL_02e4: Unknown result type (might be due to invalid IL or missing references)
		//IL_02fa: Unknown result type (might be due to invalid IL or missing references)
		//IL_0307: Unknown result type (might be due to invalid IL or missing references)
		//IL_031e: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = new GameObject("VolumeSlider", new Type[1] { typeof(RectTransform) });
		val.transform.SetParent(parent, false);
		RectTransform component = val.GetComponent<RectTransform>();
		component.anchorMin = anchorMin;
		component.anchorMax = anchorMax;
		component.anchoredPosition = position;
		component.sizeDelta = new Vector2(width, height);
		component.pivot = new Vector2(0.5f, 0.5f);
		Slider val2 = val.AddComponent<Slider>();
		val2.minValue = 0f;
		val2.maxValue = 100f;
		val2.value = 90f;
		GameObject val3 = new GameObject("Background", new Type[2]
		{
			typeof(RectTransform),
			typeof(Image)
		});
		val3.transform.SetParent(val.transform, false);
		((Graphic)val3.GetComponent<Image>()).color = new Color(0.2f, 0.2f, 0.2f);
		RectTransform component2 = val3.GetComponent<RectTransform>();
		component2.anchorMin = Vector2.zero;
		component2.anchorMax = Vector2.one;
		component2.sizeDelta = Vector2.zero;
		GameObject val4 = new GameObject("Fill Area", new Type[1] { typeof(RectTransform) });
		val4.transform.SetParent(val.transform, false);
		RectTransform component3 = val4.GetComponent<RectTransform>();
		component3.anchorMin = new Vector2(0f, 0.25f);
		component3.anchorMax = new Vector2(1f, 0.75f);
		component3.sizeDelta = Vector2.zero;
		GameObject val5 = new GameObject("Fill", new Type[2]
		{
			typeof(RectTransform),
			typeof(Image)
		});
		val5.transform.SetParent(val4.transform, false);
		((Graphic)val5.GetComponent<Image>()).color = new Color(0.7f, 0.7f, 0.7f);
		RectTransform component4 = val5.GetComponent<RectTransform>();
		component4.anchorMin = Vector2.zero;
		component4.anchorMax = Vector2.one;
		component4.sizeDelta = Vector2.zero;
		GameObject val6 = new GameObject("Handle Slide Area", new Type[1] { typeof(RectTransform) });
		val6.transform.SetParent(val.transform, false);
		RectTransform component5 = val6.GetComponent<RectTransform>();
		component5.anchorMin = Vector2.zero;
		component5.anchorMax = Vector2.one;
		component5.sizeDelta = Vector2.zero;
		GameObject val7 = new GameObject("Handle", new Type[2]
		{
			typeof(RectTransform),
			typeof(Image)
		});
		val7.transform.SetParent(val6.transform, false);
		((Graphic)val7.GetComponent<Image>()).color = GUIManager.Instance.ValheimOrange;
		RectTransform component6 = val7.GetComponent<RectTransform>();
		component6.anchorMin = Vector2.zero;
		component6.anchorMax = Vector2.one;
		component6.sizeDelta = new Vector2(20f, 0f);
		val2.fillRect = component4;
		val2.handleRect = component6;
		((Selectable)val2).targetGraphic = (Graphic)(object)val7.GetComponent<Image>();
		return val2;
	}

	private GameObject CreateToggle(Transform parent, string name, string label, float positionY)
	{
		//IL_0022: Unknown result type (might be due to invalid IL or missing references)
		//IL_0028: Expected O, but got Unknown
		//IL_0048: Unknown result type (might be due to invalid IL or missing references)
		//IL_005e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0071: Unknown result type (might be due to invalid IL or missing references)
		//IL_007d: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = new GameObject(name, new Type[2]
		{
			typeof(RectTransform),
			typeof(Toggle)
		});
		val.transform.SetParent(parent, false);
		RectTransform component = val.GetComponent<RectTransform>();
		component.anchorMin = new Vector2(0f, 1f);
		component.anchorMax = new Vector2(0f, 1f);
		component.anchoredPosition = new Vector2(10f, positionY);
		component.sizeDelta = Vector2.zero;
		Toggle component2 = val.GetComponent<Toggle>();
		CreateToggleVisuals(component2, label);
		return val;
	}

	private void CreateToggleVisuals(Toggle toggle, string label)
	{
		//IL_0026: Unknown result type (might be due to invalid IL or missing references)
		//IL_002c: Expected O, but got Unknown
		//IL_0051: Unknown result type (might be due to invalid IL or missing references)
		//IL_0067: Unknown result type (might be due to invalid IL or missing references)
		//IL_007d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0093: Unknown result type (might be due to invalid IL or missing references)
		//IL_00b3: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e3: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e9: Expected O, but got Unknown
		//IL_0110: Unknown result type (might be due to invalid IL or missing references)
		//IL_0127: Unknown result type (might be due to invalid IL or missing references)
		//IL_0134: Unknown result type (might be due to invalid IL or missing references)
		//IL_015c: Unknown result type (might be due to invalid IL or missing references)
		//IL_019c: Unknown result type (might be due to invalid IL or missing references)
		//IL_01a3: Expected O, but got Unknown
		//IL_01cc: Unknown result type (might be due to invalid IL or missing references)
		//IL_01e3: Unknown result type (might be due to invalid IL or missing references)
		//IL_01fa: Unknown result type (might be due to invalid IL or missing references)
		//IL_0219: Unknown result type (might be due to invalid IL or missing references)
		GameObject val = new GameObject("Background", new Type[2]
		{
			typeof(RectTransform),
			typeof(Image)
		});
		val.transform.SetParent(((Component)toggle).transform, false);
		RectTransform component = val.GetComponent<RectTransform>();
		component.anchorMin = new Vector2(0f, 0.5f);
		component.anchorMax = new Vector2(0f, 0.5f);
		component.anchoredPosition = new Vector2(10f, -30f);
		component.sizeDelta = new Vector2(20f, 20f);
		Image component2 = val.GetComponent<Image>();
		component2.sprite = CreateCircleSprite();
		((Graphic)component2).color = Color.white;
		GameObject val2 = new GameObject("Checkmark", new Type[2]
		{
			typeof(RectTransform),
			typeof(Image)
		});
		val2.transform.SetParent(val.transform, false);
		RectTransform component3 = val2.GetComponent<RectTransform>();
		component3.anchorMin = new Vector2(0.15f, 0.15f);
		component3.anchorMax = new Vector2(0.85f, 0.85f);
		component3.sizeDelta = Vector2.zero;
		Image component4 = val2.GetComponent<Image>();
		component4.sprite = CreateCircleSprite();
		((Graphic)component4).color = GUIManager.Instance.ValheimOrange;
		((Selectable)toggle).targetGraphic = (Graphic)(object)component2;
		toggle.graphic = (Graphic)(object)component4;
		GameObject val3 = new GameObject("Label", new Type[2]
		{
			typeof(RectTransform),
			typeof(Text)
		});
		val3.transform.SetParent(((Component)toggle).transform, false);
		RectTransform component5 = val3.GetComponent<RectTransform>();
		component5.anchorMin = new Vector2(1f, 1f);
		component5.anchorMax = new Vector2(1f, 1f);
		component5.anchoredPosition = new Vector2(80f, -30f);
		Text component6 = val3.GetComponent<Text>();
		component6.text = label;
		((Graphic)component6).color = Color.white;
		component6.font = GUIManager.Instance.AveriaSerif;
		component6.fontSize = 18;
		component6.alignment = (TextAnchor)3;
	}

	private Sprite CreateCircleSprite()
	{
		//IL_000b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0011: Expected O, but got Unknown
		//IL_00b3: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c2: Unknown result type (might be due to invalid IL or missing references)
		//IL_002a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0039: Unknown result type (might be due to invalid IL or missing references)
		//IL_005f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0058: Unknown result type (might be due to invalid IL or missing references)
		//IL_0064: Unknown result type (might be due to invalid IL or missing references)
		Texture2D val = new Texture2D(128, 128);
		Color[] array = (Color[])(object)new Color[16384];
		for (int i = 0; i < 128; i++)
		{
			for (int j = 0; j < 128; j++)
			{
				float num = Vector2.Distance(new Vector2((float)j, (float)i), new Vector2(64f, 64f));
				array[i * 128 + j] = ((num < 64f) ? Color.white : Color.clear);
			}
		}
		val.SetPixels(array);
		val.Apply();
		return Sprite.Create(val, new Rect(0f, 0f, 128f, 128f), new Vector2(0.5f, 0.5f));
	}

	private Sprite CreateRectangleSprite()
	{
		//IL_000b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0011: Expected O, but got Unknown
		//IL_0023: Unknown result type (might be due to invalid IL or missing references)
		//IL_0028: Unknown result type (might be due to invalid IL or missing references)
		//IL_0060: Unknown result type (might be due to invalid IL or missing references)
		//IL_006f: Unknown result type (might be due to invalid IL or missing references)
		Texture2D val = new Texture2D(128, 128);
		Color[] array = (Color[])(object)new Color[16384];
		for (int i = 0; i < array.Length; i++)
		{
			array[i] = Color.white;
		}
		val.SetPixels(array);
		val.Apply();
		return Sprite.Create(val, new Rect(0f, 0f, 128f, 128f), new Vector2(0.5f, 0.5f));
	}

	private Sprite CreateCheckmarkSprite()
	{
		//IL_000b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0011: Expected O, but got Unknown
		//IL_00e2: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f1: Unknown result type (might be due to invalid IL or missing references)
		//IL_008a: Unknown result type (might be due to invalid IL or missing references)
		//IL_008f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0072: Unknown result type (might be due to invalid IL or missing references)
		//IL_0077: Unknown result type (might be due to invalid IL or missing references)
		Texture2D val = new Texture2D(128, 128);
		Color[] array = (Color[])(object)new Color[16384];
		for (int i = 0; i < 128; i++)
		{
			for (int j = 0; j < 128; j++)
			{
				if ((j > i - 30 && j < i + 10 && i > 64) || (j > 128 - i - 30 && j < 128 - i + 10 && i < 64))
				{
					array[i * 128 + j] = Color.white;
				}
				else
				{
					array[i * 128 + j] = Color.clear;
				}
			}
		}
		val.SetPixels(array);
		val.Apply();
		return Sprite.Create(val, new Rect(0f, 0f, 128f, 128f), new Vector2(0.5f, 0.5f));
	}

	private static T SphereSearchForGameObjectWithComponent<T>(Vector3 p, float radius) where T : Component
	{
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_0008: Unknown result type (might be due to invalid IL or missing references)
		//IL_0011: Unknown result type (might be due to invalid IL or missing references)
		int num = -1;
		Collider[] array = Physics.OverlapSphere(p, radius, num, (QueryTriggerInteraction)2);
		List<T> list = new List<T>();
		Collider[] array2 = array;
		foreach (Collider val in array2)
		{
			T componentInParentOrSelf = GetComponentInParentOrSelf<T>(((Component)val).gameObject);
			if ((Object)(object)componentInParentOrSelf != (Object)null)
			{
				list.Add(componentInParentOrSelf);
			}
		}
		if (list.Count > 0)
		{
			return list.OrderBy((T go) => VectorExtensions.DistanceTo(((Component)go).transform.position, p)).First();
		}
		return default(T);
	}

	private static List<T> SphereSearchForGameObjectsWithComponent<T>(Vector3 p, float radius) where T : Component
	{
		//IL_0003: Unknown result type (might be due to invalid IL or missing references)
		int num = -1;
		Collider[] array = Physics.OverlapSphere(p, radius, num, (QueryTriggerInteraction)2);
		List<T> list = new List<T>();
		Collider[] array2 = array;
		foreach (Collider val in array2)
		{
			T componentInParentOrSelf = GetComponentInParentOrSelf<T>(((Component)val).gameObject);
			if ((Object)(object)componentInParentOrSelf != (Object)null)
			{
				list.Add(componentInParentOrSelf);
			}
		}
		return list;
	}

	private static void SphereSearchForGameObjects(Vector3 p, float radius)
	{
		//IL_0003: Unknown result type (might be due to invalid IL or missing references)
		int num = -1;
		Collider[] array = Physics.OverlapSphere(p, radius, num, (QueryTriggerInteraction)2);
		Collider[] array2 = array;
		foreach (Collider val in array2)
		{
			GameObject gameObject = ((Component)val).gameObject;
			Character componentInParentOrSelf = GetComponentInParentOrSelf<Character>(gameObject);
			ItemDrop componentInParentOrSelf2 = GetComponentInParentOrSelf<ItemDrop>(gameObject);
			TreeBase componentInParentOrSelf3 = GetComponentInParentOrSelf<TreeBase>(gameObject);
			Pickable componentInParentOrSelf4 = GetComponentInParentOrSelf<Pickable>(gameObject);
			if ((Object)(object)componentInParentOrSelf != (Object)null)
			{
				if (!componentInParentOrSelf.IsPlayer())
				{
					Debug.Log((object)("Character detected: " + ((Object)componentInParentOrSelf).name + " (Type: " + componentInParentOrSelf.GetHoverName() + ")"));
				}
			}
			else if ((Object)(object)componentInParentOrSelf2 != (Object)null)
			{
				Debug.Log((object)("Item drop detected: " + ((Object)componentInParentOrSelf2).name + " (Item: " + ((Object)componentInParentOrSelf2.m_itemData.m_dropPrefab).name + ")"));
			}
			else if ((Object)(object)componentInParentOrSelf3 != (Object)null)
			{
				Debug.Log((object)("Tree detected: " + ((Object)componentInParentOrSelf3).name));
			}
			else if ((Object)(object)componentInParentOrSelf4 != (Object)null)
			{
				Debug.Log((object)("Pickable object detected: " + ((Object)componentInParentOrSelf4).name));
			}
		}
	}

	private static GameObject PerformRaycast(Character player)
	{
		//IL_0002: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_0009: Unknown result type (might be due to invalid IL or missing references)
		//IL_000e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0015: Unknown result type (might be due to invalid IL or missing references)
		//IL_0016: Unknown result type (might be due to invalid IL or missing references)
		Vector3 eyePoint = player.GetEyePoint();
		Vector3 lookDir = player.GetLookDir();
		float num = 50f;
		RaycastHit val = default(RaycastHit);
		if (Physics.Raycast(eyePoint, lookDir, ref val, num))
		{
			GameObject val2 = FindTopLevelObject(((Component)((RaycastHit)(ref val)).collider).gameObject);
			Debug.Log((object)("raycast hit " + ((Object)val2).name));
			return val2;
		}
		player.Message((MessageType)1, "Raycast didn't hit anything", 0, (Sprite)null);
		return null;
	}

	public static bool IsStringEqual(string a, string b, bool bCleanKey = true)
	{
		if (bCleanKey)
		{
			return CleanKey(a).ToLower().Equals(CleanKey(b).ToLower());
		}
		return a.ToLower().Equals(b.ToLower());
	}

	public static bool IsStringStartingWith(string a, string b, bool bCleanKey)
	{
		if (bCleanKey)
		{
			return CleanKey(a).ToLower().StartsWith(CleanKey(b).ToLower());
		}
		return a.ToLower().StartsWith(b.ToLower());
	}

	public static bool DoesStringContains(string a, string b, bool bCleanKey)
	{
		if (bCleanKey)
		{
			return CleanKey(a).ToLower().Contains(CleanKey(b).ToLower());
		}
		return a.ToLower().StartsWith(b.ToLower());
	}

	public static string CleanKey(string key)
	{
		int num = key.LastIndexOf('(');
		if (num != -1)
		{
			key = key.Substring(0, num);
		}
		key = key.Trim();
		return key;
	}

	private static string RemoveCustomText(string text)
	{
		string[] array = text.Split(new char[1] { '\n' });
		List<string> list = new List<string>();
		string[] array2 = array;
		foreach (string text2 in array2)
		{
			if (!text2.Contains("<color=orange>") && !text2.Contains("<color=purple>"))
			{
				list.Add(text2);
			}
		}
		return string.Join("\n", list);
	}

	private static float DistanceBetween(GameObject a, GameObject b)
	{
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_0012: Unknown result type (might be due to invalid IL or missing references)
		return VectorExtensions.DistanceTo(a.transform.position, b.transform.position);
	}

	private static float CalculateXYDistance(Vector3 point1, Vector3 point2)
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_000f: Unknown result type (might be due to invalid IL or missing references)
		//IL_0015: Unknown result type (might be due to invalid IL or missing references)
		float num = point2.x - point1.x;
		float num2 = point2.y - point1.y;
		return Mathf.Sqrt(num * num + num2 * num2);
	}

	private static GameObject GetClosestFromArray(GameObject[] gos, Vector3 position)
	{
		//IL_0007: Unknown result type (might be due to invalid IL or missing references)
		//IL_0008: Unknown result type (might be due to invalid IL or missing references)
		return gos.OrderBy((GameObject go) => Vector3.Distance(position, go.transform.position)).FirstOrDefault();
	}

	public void SetTimer(float duration, Action onComplete)
	{
		((MonoBehaviour)this).StartCoroutine(TimerCoroutine(duration, onComplete));
	}

	private IEnumerator TimerCoroutine(float duration, Action onComplete)
	{
		yield return (object)new WaitForSeconds(duration);
		onComplete?.Invoke();
	}

	private static GameObject FindTopLevelObject(GameObject obj)
	{
		while ((Object)(object)obj.transform.parent != (Object)null)
		{
			obj = ((Component)obj.transform.parent).gameObject;
		}
		return obj;
	}

	public static bool HasAnyChildComponent(GameObject gameObject, List<Type> componentTypes)
	{
		Component[] components = gameObject.GetComponents<Component>();
		Component[] array = components;
		foreach (Component val in array)
		{
			Type type = ((object)val).GetType();
			foreach (Type componentType in componentTypes)
			{
				if (componentType.IsAssignableFrom(type))
				{
					return true;
				}
			}
		}
		return false;
	}

	public static Component GetParentFromChildComponent(GameObject gameObject, Type parentType)
	{
		Component[] components = gameObject.GetComponents<Component>();
		Component[] array = components;
		foreach (Component val in array)
		{
			Type type = ((object)val).GetType();
			if (parentType.IsAssignableFrom(type))
			{
				return val;
			}
		}
		return null;
	}

	private static T GetComponentInParentOrSelf<T>(GameObject obj) where T : Component
	{
		T val = obj.GetComponent<T>();
		if ((Object)(object)val == (Object)null)
		{
			val = obj.GetComponentInParent<T>();
		}
		return val;
	}

	private T CopyComponent<T>(GameObject source, GameObject destination) where T : Component
	{
		T component = source.GetComponent<T>();
		if ((Object)(object)component != (Object)null)
		{
			T component2 = destination.GetComponent<T>();
			FieldInfo[] fields = typeof(T).GetFields();
			FieldInfo[] array = fields;
			foreach (FieldInfo fieldInfo in array)
			{
				fieldInfo.SetValue(component2, fieldInfo.GetValue(component));
			}
			return component2;
		}
		return default(T);
	}

	private static T GetComponentFromGameObject<T>(GameObject go) where T : Component
	{
		if ((Object)(object)go == (Object)null)
		{
			return default(T);
		}
		Component parentFromChildComponent = GetParentFromChildComponent(go, typeof(T));
		T val = (T)(object)((parentFromChildComponent is T) ? parentFromChildComponent : null);
		if (val != null)
		{
			return val;
		}
		return default(T);
	}

	private static Character GetCharacterFromGameObject(GameObject go)
	{
		if ((Object)(object)go == (Object)null)
		{
			return null;
		}
		Component parentFromChildComponent = GetParentFromChildComponent(go, typeof(Character));
		if (Object.op_Implicit((Object)(object)parentFromChildComponent) && parentFromChildComponent is Character)
		{
			return (Character)(object)((parentFromChildComponent is Character) ? parentFromChildComponent : null);
		}
		return null;
	}

	public static string IndentJson(string json)
	{
		int num = 0;
		bool flag = false;
		StringBuilder stringBuilder = new StringBuilder();
		for (int i = 0; i < json.Length; i++)
		{
			char c = json[i];
			switch (c)
			{
			case '[':
			case '{':
				stringBuilder.Append(c);
				if (!flag)
				{
					stringBuilder.AppendLine();
					Indent(++num, stringBuilder);
				}
				break;
			case ']':
			case '}':
				if (!flag)
				{
					stringBuilder.AppendLine();
					Indent(--num, stringBuilder);
				}
				stringBuilder.Append(c);
				break;
			case ',':
				stringBuilder.Append(c);
				if (!flag)
				{
					stringBuilder.AppendLine();
					Indent(num, stringBuilder);
				}
				break;
			case ':':
				stringBuilder.Append(c);
				if (!flag)
				{
					stringBuilder.Append(" ");
				}
				break;
			case '"':
			{
				stringBuilder.Append(c);
				bool flag2 = false;
				int num2 = i;
				while (num2 > 0 && json[--num2] == '\\')
				{
					flag2 = !flag2;
				}
				if (!flag2)
				{
					flag = !flag;
				}
				break;
			}
			default:
				stringBuilder.Append(c);
				break;
			}
		}
		return stringBuilder.ToString();
	}

	private static void Indent(int count, StringBuilder sb)
	{
		for (int i = 0; i < count; i++)
		{
			sb.Append("    ");
		}
	}

	public static string Decrypt(string cipherText)
	{
		using Aes aes = Aes.Create();
		aes.Key = Key;
		aes.IV = IV;
		ICryptoTransform transform = aes.CreateDecryptor(aes.Key, aes.IV);
		using MemoryStream stream = new MemoryStream(Convert.FromBase64String(cipherText));
		using CryptoStream stream2 = new CryptoStream(stream, transform, CryptoStreamMode.Read);
		using StreamReader streamReader = new StreamReader(stream2);
		return streamReader.ReadToEnd();
	}

	private void DoModInit()
	{
		LogWarning("Initializing Thrall Mod!");
		Chat.instance.SendText((Type)1, "EGO.AI THRALL MOD LOADED!");
		CreateModMenuUI();
		NPCCurrentMode = NPCMode.Defensive;
		FindPlayerNPC();
		if (Object.op_Implicit((Object)(object)PlayerNPC))
		{
			HumanoidNPC component = PlayerNPC.GetComponent<HumanoidNPC>();
			LoadNPCData(component);
		}
		PopulateDatabase();
		ModInitComplete = true;
		LogMessage("Thrall mod initialization complete");
	}

	private void Awake()
	{
		logger = ((BaseUnityPlugin)this).Logger;
		instance = this;
		LogMessage("ego.ai Thrall ValheimAIModLivePatch Loaded! :)");
		LogWarning("This mod is designed for single-player gameplay and may not function correctly when used alongside other mods.");
		ConfigBindings();
		playerDialogueAudioPath = Path.Combine(Application.persistentDataPath, "playerdialogue.wav");
		npcDialogueAudioPath = Path.Combine(Application.persistentDataPath, "npcdialogue.wav");
		npcDialogueRawAudioPath = Path.Combine(Application.persistentDataPath, "npcdialogue_raw.wav");
		LogInfo("Setting up logging for Thrall");
		instance.RestartSendLogTimer();
		if (IsInAWorld())
		{
			instance.DoModInit();
		}
		else
		{
			LogWarning("Thrall mod loaded at startup. Mod not initalized yet! Waiting for player to join a world...");
		}
		harmony.PatchAll(typeof(ValheimAIModLivePatch));
	}

	private void ConfigBindings()
	{
		LogToBrain = ((BaseUnityPlugin)this).Config.Bind<bool>("Bool", "LogToBrain", true, "Log To Brain?");
		DisableAutoSave = ((BaseUnityPlugin)this).Config.Bind<bool>("Bool", "DisableAutoSave", false, "Disable auto saving the game world?");
		spawnKey = ((BaseUnityPlugin)this).Config.Bind<KeyCode>("Keybinds", "Spawn", (KeyCode)103, "Key for spawning a Thrall");
		harvestKey = ((BaseUnityPlugin)this).Config.Bind<KeyCode>("Keybinds", "Harvest", (KeyCode)104, "Key for spawning a Thrall");
		followKey = ((BaseUnityPlugin)this).Config.Bind<KeyCode>("Keybinds", "Follow", (KeyCode)102, "Key for spawning a Thrall");
		talkKey = ((BaseUnityPlugin)this).Config.Bind<KeyCode>("Keybinds", "Talk", (KeyCode)116, "Key for spawning a Thrall");
		inventoryKey = ((BaseUnityPlugin)this).Config.Bind<KeyCode>("Keybinds", "Inventory", (KeyCode)101, "Key for spawning a Thrall");
		thrallMenuKey = ((BaseUnityPlugin)this).Config.Bind<KeyCode>("Keybinds", "Menu", (KeyCode)121, "Key for spawning a Thrall");
		combatModeKey = ((BaseUnityPlugin)this).Config.Bind<KeyCode>("Keybinds", "CombatMode", (KeyCode)106, "Key for spawning a Thrall");
		allKeybinds = new List<ConfigEntry<KeyCode>> { instance.spawnKey, instance.harvestKey, instance.followKey, instance.inventoryKey, instance.talkKey, instance.thrallMenuKey, instance.combatModeKey };
	}

	private void OnDestroy()
	{
		if (panelManager != null)
		{
			panelManager.DestroyAllPanels();
		}
		if (!ZInput.GetKey((KeyCode)287, true))
		{
			instance.SendLogToBrain();
		}
		harmony.UnpatchSelf();
	}

	private void OnUnload()
	{
		if (panelManager != null)
		{
			panelManager.DestroyAllPanels();
		}
	}

	private void PopulateDatabase()
	{
		foreach (GameObject prefab in ZNetScene.instance.m_prefabs)
		{
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "TreeBase" }))
			{
				CheckTreeBase(prefab);
			}
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "TreeLog" }))
			{
				CheckTreeLog(prefab);
			}
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "Pickable" }))
			{
				CheckPickables(prefab);
			}
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "ItemDrop" }))
			{
				CheckItemDrop(prefab);
			}
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "MineRock" }))
			{
				CheckMineRock(prefab);
			}
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "MineRock5" }))
			{
				CheckMineRock5(prefab);
			}
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "Destructible" }))
			{
				CheckDestructibles(prefab);
			}
			else if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "DropOnDestroyed" }))
			{
				CheckDropOnDestroyed(prefab);
			}
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "CharacterDrop" }))
			{
				CheckCharacterDrop(prefab);
			}
		}
		AddResourceRelationships();
	}

	private void AddResourceRelationships()
	{
		foreach (KeyValuePair<string, Dictionary<string, List<Resource>>> item in resourceDatabase)
		{
			Dictionary<string, List<Resource>> value = item.Value;
			List<Resource> list = new List<Resource>();
			list.AddRange(value["TreeLog"]);
			foreach (Resource item2 in value["TreeLog"])
			{
				if (logToLogMap.ContainsKey(item2.Name))
				{
					list.AddRange(logToLogMap[item2.Name]);
				}
			}
			resourceDatabase[item.Key]["TreeLog"] = list.ToList();
			list.Clear();
			list.AddRange(value["TreeBase"]);
			foreach (Resource item3 in value["TreeLog"])
			{
				if (logToTreeMap.ContainsKey(item3.Name))
				{
					list.AddRange(logToTreeMap[item3.Name]);
				}
			}
			resourceDatabase[item.Key]["TreeBase"] = list.ToList();
			list.Clear();
			list.AddRange(value["MineRock5"]);
			foreach (Resource item4 in value["MineRock5"])
			{
				if (destructibleToSpawnMap.ContainsKey(item4.Name))
				{
					list.AddRange(destructibleToSpawnMap[item4.Name]);
				}
			}
			resourceDatabase[item.Key]["MineRock5"] = list.ToList();
		}
	}

	private void CheckTreeBase(GameObject prefab)
	{
		//IL_004b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f6: Unknown result type (might be due to invalid IL or missing references)
		//IL_0103: Unknown result type (might be due to invalid IL or missing references)
		//IL_01e9: Unknown result type (might be due to invalid IL or missing references)
		TreeBase component = prefab.GetComponent<TreeBase>();
		if (!((Object)(object)component != (Object)null) || component.m_dropWhenDestroyed == null || component.m_dropWhenDestroyed.m_drops == null)
		{
			return;
		}
		foreach (DropData drop in component.m_dropWhenDestroyed.m_drops)
		{
			float value = -1f;
			if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
			{
				resourceHealthMap[((Object)prefab).name] = Math.Max(component.m_health, value);
			}
			else
			{
				resourceHealthMap[((Object)prefab).name] = component.m_health;
			}
			resourceQuantityMap[((Object)prefab).name] = component.m_dropWhenDestroyed.m_dropMax;
			Resource sourceResource = new Resource(((Object)prefab).name, component.m_dropWhenDestroyed.m_dropMin, component.m_dropWhenDestroyed.m_dropMax, resourceHealthMap[((Object)prefab).name], component.m_damageModifiers);
			AddToDatabase(((Object)drop.m_item).name, "TreeBase", sourceResource);
		}
		if ((Object)(object)component.m_logPrefab != (Object)null)
		{
			TreeLog component2 = component.m_logPrefab.GetComponent<TreeLog>();
			TreeLog val = null;
			if (Object.op_Implicit((Object)(object)component2) && Object.op_Implicit((Object)(object)component2.m_subLogPrefab))
			{
				val = component2.m_subLogPrefab.GetComponent<TreeLog>();
			}
			int minAmount = ((!Object.op_Implicit((Object)(object)val)) ? 1 : ((int)((float)val.m_dropWhenDestroyed.m_dropMin * 0.6f)));
			int maxAmount = ((!Object.op_Implicit((Object)(object)val)) ? 1 : ((int)((float)val.m_dropWhenDestroyed.m_dropMax * 0.6f)));
			Resource resource = new Resource(((Object)prefab).name, minAmount, maxAmount, component.m_health, component.m_damageModifiers);
			AddToDatabase(((Object)component.m_logPrefab).name, "TreeBase", resource);
			if (!logToTreeMap.ContainsKey(((Object)component.m_logPrefab).name))
			{
				logToTreeMap[((Object)component.m_logPrefab).name] = new List<Resource>();
			}
			logToTreeMap[((Object)component.m_logPrefab).name].Add(resource);
		}
	}

	private void CheckTreeLog(GameObject prefab)
	{
		//IL_004b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0050: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f6: Unknown result type (might be due to invalid IL or missing references)
		//IL_0103: Unknown result type (might be due to invalid IL or missing references)
		//IL_01b1: Unknown result type (might be due to invalid IL or missing references)
		TreeLog component = prefab.GetComponent<TreeLog>();
		if (!((Object)(object)component != (Object)null) || component.m_dropWhenDestroyed == null || component.m_dropWhenDestroyed.m_drops == null)
		{
			return;
		}
		foreach (DropData drop in component.m_dropWhenDestroyed.m_drops)
		{
			float value = -1f;
			if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
			{
				resourceHealthMap[((Object)prefab).name] = Math.Max(component.m_health, value);
			}
			else
			{
				resourceHealthMap[((Object)prefab).name] = component.m_health;
			}
			resourceQuantityMap[((Object)prefab).name] = component.m_dropWhenDestroyed.m_dropMax;
			Resource sourceResource = new Resource(((Object)prefab).name, component.m_dropWhenDestroyed.m_dropMin, component.m_dropWhenDestroyed.m_dropMax, resourceHealthMap[((Object)prefab).name], component.m_damages);
			AddToDatabase(((Object)drop.m_item).name, "TreeLog", sourceResource);
		}
		if ((Object)(object)component.m_subLogPrefab != (Object)null)
		{
			TreeLog component2 = component.m_subLogPrefab.GetComponent<TreeLog>();
			int minAmount = ((!Object.op_Implicit((Object)(object)component2)) ? 1 : ((int)((float)component2.m_dropWhenDestroyed.m_dropMin * 0.8f)));
			int maxAmount = ((!Object.op_Implicit((Object)(object)component2)) ? 1 : ((int)((float)component2.m_dropWhenDestroyed.m_dropMax * 0.8f)));
			Resource resource = new Resource(((Object)prefab).name, minAmount, maxAmount, component.m_health, component.m_damages);
			AddToDatabase(((Object)component.m_subLogPrefab).name, "TreeLog", resource);
			if (!logToLogMap.ContainsKey(((Object)component.m_subLogPrefab).name))
			{
				logToLogMap[((Object)component.m_subLogPrefab).name] = new List<Resource>();
			}
			logToLogMap[((Object)component.m_subLogPrefab).name].Add(resource);
		}
	}

	private void CheckCharacterDrop(GameObject prefab)
	{
		//IL_000a: Unknown result type (might be due to invalid IL or missing references)
		//IL_0058: Unknown result type (might be due to invalid IL or missing references)
		//IL_005d: Unknown result type (might be due to invalid IL or missing references)
		//IL_00dd: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e2: Unknown result type (might be due to invalid IL or missing references)
		//IL_0193: Unknown result type (might be due to invalid IL or missing references)
		CharacterDrop component = prefab.GetComponent<CharacterDrop>();
		DamageModifiers damageModifiers = default(DamageModifiers);
		if (!((Object)(object)component != (Object)null) || component.m_drops == null)
		{
			return;
		}
		float value = -1f;
		if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "Humanoid" }))
		{
			Humanoid component2 = prefab.GetComponent<Humanoid>();
			damageModifiers = ((Character)component2).m_damageModifiers;
			if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
			{
				resourceHealthMap[((Object)prefab).name] = Math.Max(((Character)component2).m_health, value);
			}
			else
			{
				resourceHealthMap[((Object)prefab).name] = ((Character)component2).m_health;
			}
		}
		else if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "Character" }))
		{
			Character component3 = prefab.GetComponent<Character>();
			damageModifiers = component3.m_damageModifiers;
			if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
			{
				resourceHealthMap[((Object)prefab).name] = Math.Max(component3.m_health, value);
			}
			else
			{
				resourceHealthMap[((Object)prefab).name] = component3.m_health;
			}
		}
		foreach (Drop drop in component.m_drops)
		{
			resourceQuantityMap[((Object)prefab).name] = component.m_drops.Count;
			Resource sourceResource = new Resource(((Object)prefab).name, drop.m_amountMin, drop.m_amountMax, resourceHealthMap[((Object)prefab).name], damageModifiers);
			AddToDatabase(((Object)drop.m_prefab).name, "CharacterDrop", sourceResource);
		}
	}

	private void CheckDropOnDestroyed(GameObject prefab)
	{
		//IL_000a: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ea: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ef: Unknown result type (might be due to invalid IL or missing references)
		//IL_010d: Unknown result type (might be due to invalid IL or missing references)
		//IL_0112: Unknown result type (might be due to invalid IL or missing references)
		//IL_015e: Unknown result type (might be due to invalid IL or missing references)
		//IL_0166: Unknown result type (might be due to invalid IL or missing references)
		//IL_0179: Unknown result type (might be due to invalid IL or missing references)
		DropOnDestroyed component = prefab.GetComponent<DropOnDestroyed>();
		DamageModifiers damageModifiers = default(DamageModifiers);
		if (!((Object)(object)component != (Object)null) || component.m_dropWhenDestroyed == null || component.m_dropWhenDestroyed.m_drops == null)
		{
			return;
		}
		float value = -1f;
		if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
		{
			resourceHealthMap[((Object)prefab).name] = value;
		}
		else
		{
			resourceHealthMap[((Object)prefab).name] = value;
			if (resourceHealthMap[((Object)prefab).name] <= 0f && ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "WearNTear" }))
			{
				WearNTear component2 = prefab.GetComponent<WearNTear>();
				if ((Object)(object)component2 != (Object)null)
				{
					resourceHealthMap[((Object)prefab).name] = component2.m_health;
					damageModifiers = component2.m_damages;
				}
			}
		}
		foreach (DropData drop in component.m_dropWhenDestroyed.m_drops)
		{
			resourceQuantityMap[((Object)prefab).name] = component.m_dropWhenDestroyed.m_dropMax;
			Resource sourceResource = new Resource(((Object)prefab).name, component.m_dropWhenDestroyed.m_dropMin, component.m_dropWhenDestroyed.m_dropMax, resourceHealthMap[((Object)prefab).name], damageModifiers);
			if (Object.op_Implicit((Object)(object)drop.m_item))
			{
				AddToDatabase(((Object)drop.m_item).name, "DropOnDestroyed", sourceResource);
			}
		}
	}

	private void CheckItemDrop(GameObject prefab)
	{
		//IL_0058: Unknown result type (might be due to invalid IL or missing references)
		//IL_005e: Unknown result type (might be due to invalid IL or missing references)
		ItemDrop component = prefab.GetComponent<ItemDrop>();
		if ((Object)(object)component != (Object)null && component.m_itemData != null)
		{
			resourceQuantityMap[((Object)prefab).name] = component.m_itemData.m_stack;
			Resource sourceResource = new Resource(((Object)prefab).name, 1, component.m_itemData.m_stack, 2.5f);
			AddToDatabase(((Object)prefab).name, "ItemDrop", sourceResource);
		}
	}

	private void CheckDestructibles(GameObject prefab)
	{
		//IL_01a3: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ce: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d3: Unknown result type (might be due to invalid IL or missing references)
		//IL_0129: Unknown result type (might be due to invalid IL or missing references)
		//IL_0135: Unknown result type (might be due to invalid IL or missing references)
		//IL_0148: Unknown result type (might be due to invalid IL or missing references)
		Destructible component = prefab.GetComponent<Destructible>();
		if (!((Object)(object)component != (Object)null))
		{
			return;
		}
		float value = -1f;
		if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
		{
			resourceHealthMap[((Object)prefab).name] = Math.Max(component.m_health, value);
		}
		else
		{
			resourceHealthMap[((Object)prefab).name] = component.m_health;
		}
		resourceQuantityMap[((Object)prefab).name] = 1f;
		int minAmount = 1;
		int maxAmount = 1;
		DropOnDestroyed component2 = prefab.GetComponent<DropOnDestroyed>();
		if ((Object)(object)component2 != (Object)null && component2.m_dropWhenDestroyed != null)
		{
			foreach (DropData drop in component2.m_dropWhenDestroyed.m_drops)
			{
				resourceQuantityMap[((Object)prefab).name] = component2.m_dropWhenDestroyed.m_dropMax;
				minAmount = component2.m_dropWhenDestroyed.m_dropMin;
				maxAmount = component2.m_dropWhenDestroyed.m_dropMax;
				Resource sourceResource = new Resource(((Object)prefab).name, minAmount, maxAmount, resourceHealthMap[((Object)prefab).name], component.m_damages);
				if (Object.op_Implicit((Object)(object)drop.m_item))
				{
					AddToDatabase(((Object)drop.m_item).name, "Destructible", sourceResource);
				}
			}
		}
		if ((Object)(object)component.m_spawnWhenDestroyed != (Object)null)
		{
			Resource item = new Resource(((Object)prefab).name, minAmount, maxAmount, component.m_health, component.m_damages);
			if (!destructibleToSpawnMap.ContainsKey(((Object)component.m_spawnWhenDestroyed).name))
			{
				destructibleToSpawnMap[((Object)component.m_spawnWhenDestroyed).name] = new List<Resource>();
			}
			destructibleToSpawnMap[((Object)component.m_spawnWhenDestroyed).name].Add(item);
		}
	}

	private void CheckPickables(GameObject prefab)
	{
		//IL_0056: Unknown result type (might be due to invalid IL or missing references)
		//IL_005c: Unknown result type (might be due to invalid IL or missing references)
		Pickable component = prefab.GetComponent<Pickable>();
		if ((Object)(object)component != (Object)null && (Object)(object)component.m_itemPrefab != (Object)null)
		{
			resourceQuantityMap[((Object)prefab).name] = component.m_amount;
			Resource sourceResource = new Resource(((Object)prefab).name, component.m_amount, component.m_amount, 2.5f);
			AddToDatabase(((Object)component.m_itemPrefab).name, "Pickable", sourceResource);
		}
	}

	private void CheckMineRock(GameObject prefab)
	{
		//IL_00bc: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c1: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ca: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d1: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e9: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f6: Unknown result type (might be due to invalid IL or missing references)
		MineRock component = prefab.GetComponent<MineRock>();
		if (!((Object)(object)component != (Object)null) || component.m_dropItems == null || component.m_dropItems.m_drops == null)
		{
			return;
		}
		float value = -1f;
		if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
		{
			resourceHealthMap[((Object)prefab).name] = Math.Max(component.m_health, value);
		}
		else
		{
			resourceHealthMap[((Object)prefab).name] = component.m_health;
		}
		resourceQuantityMap[((Object)prefab).name] = component.m_dropItems.m_dropMax;
		foreach (DropData drop in component.m_dropItems.m_drops)
		{
			Resource sourceResource = new Resource(((Object)prefab).name, drop.m_stackMin, drop.m_stackMax, resourceHealthMap[((Object)prefab).name], component.m_damageModifiers);
			AddToDatabase(((Object)drop.m_item).name, "MineRock", sourceResource);
		}
	}

	private void CheckMineRock5(GameObject prefab)
	{
		//IL_00bc: Unknown result type (might be due to invalid IL or missing references)
		//IL_00c1: Unknown result type (might be due to invalid IL or missing references)
		//IL_00ca: Unknown result type (might be due to invalid IL or missing references)
		//IL_00d1: Unknown result type (might be due to invalid IL or missing references)
		//IL_00e9: Unknown result type (might be due to invalid IL or missing references)
		//IL_00f6: Unknown result type (might be due to invalid IL or missing references)
		MineRock5 component = prefab.GetComponent<MineRock5>();
		if (!((Object)(object)component != (Object)null) || component.m_dropItems == null || component.m_dropItems.m_drops == null)
		{
			return;
		}
		float value = -1f;
		if (resourceHealthMap.TryGetValue(((Object)prefab).name, out value))
		{
			resourceHealthMap[((Object)prefab).name] = Math.Max(component.m_health, value);
		}
		else
		{
			resourceHealthMap[((Object)prefab).name] = component.m_health;
		}
		resourceQuantityMap[((Object)prefab).name] = component.m_dropItems.m_dropMax;
		foreach (DropData drop in component.m_dropItems.m_drops)
		{
			Resource sourceResource = new Resource(((Object)prefab).name, drop.m_stackMin, drop.m_stackMax, resourceHealthMap[((Object)prefab).name], component.m_damageModifiers);
			AddToDatabase(((Object)drop.m_item).name, "MineRock5", sourceResource);
		}
	}

	private void AddToDatabase(string resourceName, string sourceType, Resource sourceResource)
	{
		if (!resourceDatabase.ContainsKey(resourceName))
		{
			resourceDatabase[resourceName] = new Dictionary<string, List<Resource>>
			{
				{
					"TreeLog",
					new List<Resource>()
				},
				{
					"TreeBase",
					new List<Resource>()
				},
				{
					"MineRock",
					new List<Resource>()
				},
				{
					"MineRock5",
					new List<Resource>()
				},
				{
					"DropOnDestroyed",
					new List<Resource>()
				},
				{
					"Destructible",
					new List<Resource>()
				},
				{
					"ItemDrop",
					new List<Resource>()
				},
				{
					"Pickable",
					new List<Resource>()
				},
				{
					"CharacterDrop",
					new List<Resource>()
				}
			};
		}
		resourceDatabase[resourceName][sourceType].Add(sourceResource);
	}

	private void SaveDatabaseToJson()
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Expected O, but got Unknown
		//IL_0021: Unknown result type (might be due to invalid IL or missing references)
		//IL_0028: Expected O, but got Unknown
		//IL_0046: Unknown result type (might be due to invalid IL or missing references)
		//IL_004d: Expected O, but got Unknown
		//IL_006b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0072: Expected O, but got Unknown
		//IL_00da: Unknown result type (might be due to invalid IL or missing references)
		JsonObject val = new JsonObject();
		foreach (KeyValuePair<string, Dictionary<string, List<Resource>>> item in resourceDatabase)
		{
			JsonObject val2 = new JsonObject();
			foreach (KeyValuePair<string, List<Resource>> item2 in item.Value)
			{
				JsonArray val3 = new JsonArray();
				foreach (Resource item3 in item2.Value)
				{
					JsonObject val4 = new JsonObject();
					val4["Name"] = item3.Name;
					val4["MinAmount"] = item3.MinAmount;
					val4["MaxAmount"] = item3.MaxAmount;
					val4["Health"] = item3.Health;
					val4["DamageModifiers"] = item3.DamageModifiers;
					((List<object>)(object)val3).Add((object)val4);
				}
				val2[item2.Key] = val3;
			}
			val[item.Key] = val2;
		}
		string text = Path.Combine(Application.persistentDataPath, "resource_database.json");
		File.WriteAllText(text, IndentJson(((object)val).ToString()));
		LogInfo("Saved resource database to " + text);
	}

	private List<(string Category, string Name, float Efficiency, float Distance, int Depth)> FindResourceSourcesRecursive(string resource, ItemData weapon, int depth = 0, int maxDepth = 3)
	{
		//IL_008d: Unknown result type (might be due to invalid IL or missing references)
		List<(string, string, float, float, int)> list = new List<(string, string, float, float, int)>();
		if (!resourceDatabase.ContainsKey(resource))
		{
			return list;
		}
		GetNearbyResources(((Component)Player.m_localPlayer).gameObject);
		foreach (KeyValuePair<string, List<Resource>> item2 in resourceDatabase[resource])
		{
			foreach (Resource item3 in item2.Value)
			{
				if (nearbyResourcesDistance.TryGetValue(item3.Name, out var value))
				{
					float weaponEffectiveness = CalculateWeaponEffectiveness(weapon, item3.DamageModifiers);
					float item = CalculateEfficiency(item3.Name, item2.Key, item3.MinAmount, item3.MaxAmount, item3.Health, weaponEffectiveness, value);
					list.Add((item2.Key, item3.Name, item, value, depth));
				}
			}
		}
		return list;
	}

	public static Dictionary<string, List<Resource>> QueryResourceComplete(string resourceName, bool HasWeapon = true)
	{
		if (!resourceDatabase.ContainsKey(resourceName))
		{
			return new Dictionary<string, List<Resource>>();
		}
		Dictionary<string, List<Resource>> dictionary = resourceDatabase[resourceName];
		Dictionary<string, List<Resource>> dictionary2 = new Dictionary<string, List<Resource>>();
		foreach (string item in HasWeapon ? priorityOrder : priorityOrderUnarmed)
		{
			if (dictionary.ContainsKey(item))
			{
				dictionary2[item] = dictionary[item];
			}
		}
		return dictionary2;
	}

	private static List<List<string>> ConvertResourcesToNames(List<List<Resource>> resourceLists)
	{
		return resourceLists.Select((List<Resource> innerList) => innerList.Select((Resource resource) => resource.Name).ToList()).ToList();
	}

	private static List<string> FlattenListOfLists(List<List<string>> nestedList)
	{
		return nestedList.SelectMany((List<string> innerList) => innerList).ToList();
	}

	private void PopulateCraftingRequirements()
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Expected O, but got Unknown
		//IL_0042: Unknown result type (might be due to invalid IL or missing references)
		//IL_0049: Expected O, but got Unknown
		//IL_007b: Unknown result type (might be due to invalid IL or missing references)
		//IL_0082: Expected O, but got Unknown
		//IL_0207: Unknown result type (might be due to invalid IL or missing references)
		//IL_020e: Expected O, but got Unknown
		//IL_0228: Unknown result type (might be due to invalid IL or missing references)
		//IL_022f: Expected O, but got Unknown
		JsonObject val = new JsonObject();
		foreach (GameObject item in ObjectDB.instance.m_items)
		{
			ItemDrop component = item.GetComponent<ItemDrop>();
			if (!((Object)(object)component != (Object)null))
			{
				continue;
			}
			JsonObject val2 = new JsonObject();
			val2["name"] = ((Object)component).name;
			val2["itemName"] = component.m_itemData.m_shared.m_name;
			JsonObject val3 = new JsonObject();
			foreach (KeyValuePair<string, string> customDatum in component.m_itemData.m_customData)
			{
				val3[customDatum.Key] = customDatum.Value;
			}
			if (val3.Count > 0)
			{
				val2["customData"] = val3;
			}
			if (component.m_itemData.m_shared.m_description != "")
			{
				string text = LocalizationManager.Instance.TryTranslate(component.m_itemData.m_shared.m_description);
				if (text != "")
				{
					val2["description"] = text;
				}
			}
			val2["armor"] = component.m_itemData.m_shared.m_armor;
			val2["maxDurability"] = component.m_itemData.m_shared.m_maxDurability;
			val2["weight"] = component.m_itemData.m_shared.m_weight;
			Recipe recipe = ObjectDB.instance.GetRecipe(component.m_itemData);
			if ((Object)(object)recipe != (Object)null)
			{
				craftingRequirements[component.m_itemData.m_shared.m_name] = recipe.m_resources;
				JsonArray val4 = new JsonArray();
				Requirement[] resources = recipe.m_resources;
				foreach (Requirement val5 in resources)
				{
					JsonObject val6 = new JsonObject();
					val6["name"] = ((Object)val5.m_resItem).name;
					val6["itemName"] = val5.m_resItem.m_itemData.m_shared.m_name;
					if (val5.m_resItem.m_itemData.m_shared.m_description != "")
					{
						string text2 = LocalizationManager.Instance.TryTranslate(val5.m_resItem.m_itemData.m_shared.m_description);
						if (text2 != "")
						{
							val6["description"] = text2;
						}
					}
					val6["amount"] = val5.m_amount;
					((List<object>)(object)val4).Add((object)val6);
				}
				val2["m_resources"] = val4;
			}
			val[component.m_itemData.m_shared.m_name] = val2;
		}
		string contents = IndentJson(((object)val).ToString());
		string text3 = Path.Combine(Application.persistentDataPath, "crafting_requirements.json");
		File.WriteAllText(text3, contents);
		LogError("Crafting requirements exported to " + text3);
	}

	private void PopulateBuildingRequirements()
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Expected O, but got Unknown
		//IL_0060: Unknown result type (might be due to invalid IL or missing references)
		//IL_0067: Expected O, but got Unknown
		//IL_0161: Unknown result type (might be due to invalid IL or missing references)
		//IL_0168: Expected O, but got Unknown
		//IL_0182: Unknown result type (might be due to invalid IL or missing references)
		//IL_0189: Expected O, but got Unknown
		JsonObject val = new JsonObject();
		foreach (GameObject prefab in ZNetScene.instance.m_prefabs)
		{
			Piece component = prefab.GetComponent<Piece>();
			if (!((Object)(object)component != (Object)null))
			{
				continue;
			}
			string name = component.m_name;
			buildingRequirements[name] = component.m_resources;
			JsonObject val2 = new JsonObject();
			val2["name"] = ((Object)component).name;
			val2["itemName"] = component.m_name;
			if (component.m_description != "")
			{
				string text = LocalizationManager.Instance.TryTranslate(component.m_description);
				if (text != "")
				{
					val2["description"] = text;
				}
			}
			val2["category"] = ((object)(PieceCategory)(ref component.m_category)).ToString();
			val2["comfort"] = component.m_comfort;
			val2["groundPiece"] = component.m_groundPiece;
			val2["allowedInDungeons"] = component.m_allowedInDungeons;
			val2["spaceRequirement"] = component.m_spaceRequirement;
			JsonArray val3 = new JsonArray();
			Requirement[] resources = component.m_resources;
			foreach (Requirement val4 in resources)
			{
				JsonObject val5 = new JsonObject();
				val5["name"] = ((Object)val4.m_resItem).name;
				val5["itemName"] = val4.m_resItem.m_itemData.m_shared.m_name;
				if (val4.m_resItem.m_itemData.m_shared.m_description != "")
				{
					string text2 = LocalizationManager.Instance.TryTranslate(val4.m_resItem.m_itemData.m_shared.m_description);
					if (text2 != "")
					{
						val5["description"] = text2;
					}
				}
				val5["amount"] = val4.m_amount;
				val5["amountPerLevel"] = val4.m_amountPerLevel;
				val5["m_recover"] = val4.m_recover;
				val5["m_extraAmountOnlyOneIngredient"] = val4.m_extraAmountOnlyOneIngredient;
				((List<object>)(object)val3).Add((object)val5);
			}
			val2["m_resources"] = val3;
			val[name] = val2;
		}
		string contents = IndentJson(((object)val).ToString());
		string text3 = Path.Combine(Application.persistentDataPath, "building_requirements.json");
		File.WriteAllText(text3, contents);
		LogError("Building requirements exported to " + text3);
	}

	private void PopulateMonsterPrefabs()
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Expected O, but got Unknown
		//IL_0048: Unknown result type (might be due to invalid IL or missing references)
		//IL_004f: Expected O, but got Unknown
		//IL_0090: Unknown result type (might be due to invalid IL or missing references)
		//IL_0097: Expected O, but got Unknown
		JsonArray val = new JsonArray();
		foreach (GameObject prefab in ZNetScene.instance.m_prefabs)
		{
			Character component = prefab.GetComponent<Character>();
			Humanoid component2 = prefab.GetComponent<Humanoid>();
			if ((Object)(object)component != (Object)null)
			{
				JsonObject val2 = new JsonObject();
				val2["name"] = ((Object)component).name;
				val2["itemName"] = component.m_name;
				((List<object>)(object)val).Add((object)val2);
			}
			if ((Object)(object)component2 != (Object)null)
			{
				JsonObject val3 = new JsonObject();
				val3["name"] = ((Object)component2).name;
				val3["itemName"] = ((Character)component2).m_name;
				((List<object>)(object)val).Add((object)val3);
			}
		}
		string json = ((object)val).ToString();
		json = IndentJson(json);
		string text = Path.Combine(Application.persistentDataPath, "monsters.json");
		File.WriteAllText(text, json);
		LogError("Monster prefab list exported to " + text);
	}

	private void PopulateAllItems()
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Expected O, but got Unknown
		//IL_0040: Unknown result type (might be due to invalid IL or missing references)
		//IL_0047: Expected O, but got Unknown
		JsonArray val = new JsonArray();
		foreach (GameObject prefab in ZNetScene.instance.m_prefabs)
		{
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "ItemDrop" }))
			{
				JsonObject val2 = new JsonObject();
				ItemDrop component = prefab.GetComponent<ItemDrop>();
				val2["name"] = ((Object)prefab).name;
				val2["shared"] = ((object)component.m_itemData.m_shared).ToString();
				((List<object>)(object)val).Add((object)val2);
			}
		}
		string json = ((object)val).ToString();
		json = IndentJson(json);
		string text = Path.Combine(Application.persistentDataPath, "all_items_list.json");
		File.WriteAllText(text, json);
		LogError("all_items_list exported to " + text);
	}

	private void PopulateAllWeapons()
	{
		//IL_0001: Unknown result type (might be due to invalid IL or missing references)
		//IL_0007: Expected O, but got Unknown
		//IL_0071: Unknown result type (might be due to invalid IL or missing references)
		//IL_0078: Expected O, but got Unknown
		//IL_0153: Unknown result type (might be due to invalid IL or missing references)
		//IL_0176: Unknown result type (might be due to invalid IL or missing references)
		JsonObject val = new JsonObject();
		foreach (GameObject prefab in ZNetScene.instance.m_prefabs)
		{
			if (ExposedGameObjectExtension.HasAnyComponent(prefab, new string[1] { "ItemDrop" }))
			{
				ItemDrop component = prefab.GetComponent<ItemDrop>();
				if (Object.op_Implicit((Object)(object)component) && component.m_itemData.IsWeapon())
				{
					JsonObject val2 = new JsonObject();
					val2["Durability"] = component.m_itemData.m_durability;
					val2["Quality"] = component.m_itemData.m_quality;
					val2["m_aiAttackRange"] = component.m_itemData.m_shared.m_aiAttackRange;
					val2["Weight"] = component.m_itemData.m_shared.m_weight;
					val2["Attack"] = component.m_itemData.m_shared.m_attack.m_attackAnimation;
					val2["SecondaryAttack"] = component.m_itemData.m_shared.m_secondaryAttack.m_attackAnimation;
					val2["DamageModifiers"] = component.m_itemData.m_shared.m_damages;
					val2["DamagesPerLevel"] = component.m_itemData.m_shared.m_damagesPerLevel;
					val[((Object)prefab).name] = val2;
				}
			}
		}
		string json = ((object)val).ToString();
		json = IndentJson(json);
		string text = Path.Combine(Application.persistentDataPath, "all_weapons.json");
		File.WriteAllText(text, json);
		LogError("All weapons exported to " + text);
	}

	public Requirement[] GetCraftingRequirements(string itemName)
	{
		if (craftingRequirements.ContainsKey(itemName))
		{
			return craftingRequirements[itemName];
		}
		return null;
	}
}
public class NPCCommandManager
{
	private List<NPCCommand> commands = new List<NPCCommand>();

	public void AddCommand(NPCCommand command)
	{
		commands.Insert(0, command);
	}

	public void RemoveCommand(int index)
	{
		if (index >= 0 && index < commands.Count)
		{
			commands.RemoveAt(index);
		}
	}

	public void RemoveCommandsOfType<T>() where T : NPCCommand
	{
		commands.RemoveAll((NPCCommand command) => command is T);
	}

	public NPCCommand GetNextCommand()
	{
		NPCCommand nPCCommand = null;
		List<NPCCommand> list = new List<NPCCommand>();
		foreach (NPCCommand command in commands)
		{
			if (nPCCommand != null)
			{
				break;
			}
			if (!command.IsTaskComplete())
			{
				nPCCommand = command;
			}
			else
			{
				list.Add(command);
			}
		}
		foreach (NPCCommand item in list)
		{
			if ((Object)(object)item.humanoidNPC != (Object)null)
			{
				string text = null;
				if (item is HarvestAction)
				{
					HarvestAction harvestAction = (HarvestAction)item;
					text = $"gathering {harvestAction.OriginalRequiredAmount} {harvestAction.ResourceName}";
				}
				else if (item is AttackAction)
				{
					AttackAction attackAction = (AttackAction)item;
					text = $"attacking {attackAction.OriginalTargetQuantity} {attackAction.TargetName}";
				}
				else if (item is PatrolAction)
				{
					PatrolAction patrolAction = (PatrolAction)item;
					text = "patrolling area";
				}
				else if (item is FollowAction)
				{
					FollowAction followAction = (FollowAction)item;
					text = "following " + Player.m_localPlayer.GetPlayerName();
				}
				string text2 = "Done " + text;
				ValheimAIModLivePatch.instance.AddChatTalk((Character)(object)item.humanoidNPC, "NPC", text2);
				ValheimAIModLivePatch.instance.BrainSynthesizeAudio(text2, ValheimAIModLivePatch.npcVoices[ValheimAIModLivePatch.instance.npcVoice].ToLower());
			}
			commands.Remove(item);
		}
		return nPCCommand;
	}

	public List<NPCCommand> GetAllCommands()
	{
		return new List<NPCCommand>(commands);
	}

	public void RemoveAllCommands()
	{
		commands.Clear();
	}

	public int GetCommandsCount()
	{
		return commands.Count;
	}
}
public abstract class NPCCommand
{
	public enum CommandType
	{
		Idle,
		FollowPlayer,
		CombatAttack,
		CombatSneakAttack,
		CombatDefend,
		HarvestResource,
		PatrolArea,
		MoveToLocation
	}

	public GameObject NPC;

	public HumanoidNPC humanoidNPC;

	public int priority = 0;

	public int expiresAt = 0;

	public bool DestroyOnComplete = false;

	public CommandType Type { get; set; }

	public NPCCommand()
	{
		Type = CommandType.Idle;
		priority = 1;
		expiresAt = -1;
	}

	public NPCCommand(CommandType IType, int Ipriority, int expiresInSeconds, GameObject INPC)
	{
		Type = IType;
		priority = Ipriority;
		if (expiresInSeconds > 0)
		{
			expiresAt = (int)(Time.time + (float)expiresInSeconds);
		}
		else
		{
			expiresAt = 0;
		}
		NPC = INPC;
	}

	public abstract bool IsTaskComplete();

	public abstract void Execute();
}
public class PatrolAction : NPCCommand
{
	public Vector3 patrol_position;

	public int patrol_radius;

	public override bool IsTaskComplete()
	{
		return false;
	}

	public override void Execute()
	{
	}
}
public class HarvestAction : NPCCommand
{
	public string ResourceName { get; set; }

	public int OriginalRequiredAmount { get; set; }

	public int RequiredAmount { get; set; }

	public override bool IsTaskComplete()
	{
		if (Object.op_Implicit((Object)(object)humanoidNPC))
		{
			if (RequiredAmount <= 0)
			{
				return true;
			}
		}
		else
		{
			Debug.LogError((object)"HarvestAction no humanoidNPC");
		}
		return false;
	}

	public override void Execute()
	{
	}
}
public class AttackAction : NPCCommand
{
	public GameObject Target { get; set; }

	public string TargetName { get; set; }

	public int TargetQuantity { get; set; }

	public int OriginalTargetQuantity { get; set; }

	public override bool IsTaskComplete()
	{
		if (TargetQuantity == 0)
		{
			return true;
		}
		return false;
	}

	public override void Execute()
	{
	}
}
public class FollowAction : NPCCommand
{
	public override bool IsTaskComplete()
	{
		return false;
	}

	public override void Execute()
	{
	}
}
